<!DOCTYPE html>
<html lang="fr" class="scroll-smooth">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GoChantier - L'outil des Artisans</title>
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="./icon.png">
    <meta name="theme-color" content="#2563eb">

    <!-- S√âCURIT√â CSP -->
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://cdnjs.cloudflare.com https://www.gstatic.com https://apis.google.com https://*.firebaseapp.com https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://fonts.googleapis.com; font-src https://fonts.gstatic.com https://cdnjs.cloudflare.com; img-src 'self' https: data: blob:; connect-src 'self' https:;">

    <!-- MOTEUR GRAPHIQUE -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        // Professional Blue Palette (Inter Blue)
                        brand: { 50: '#eff6ff', 100: '#dbeafe', 200: '#bfdbfe', 300: '#93c5fd', 400: '#60a5fa', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8', 800: '#1e40af', 900: '#1e3a8a' },
                        accent: { orange: '#f97316', green: '#10b981', red: '#ef4444' }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } }
                    }
                }
            }
        }
    </script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
            background-color: #f8fafc;
        }

        .dark body {
            background-color: #0f172a;
        }

        .view-section {
            display: none !important;
        }

        .view-section.active {
            display: block !important;
            animation: fadeIn 0.3s ease-out forwards;
        }

        #view-devis.active {
            display: flex !important;
        }

        /* SCROLLBAR CLEAN */
        .custom-scrollbar::-webkit-scrollbar {
            width: 5px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        .dark .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #475569;
        }

        /* CLEAN CARD DESIGN (No Glass) */
        .glass {
            background: white;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
        }

        .dark .glass {
            background: #1e293b;
            border: 1px solid #334155;
            box-shadow: none;
        }

        .card-hover {
            transition: all 0.2s ease;
        }

        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border-color: #cbd5e1;
        }

        .dark .card-hover:hover {
            border-color: #475569;
        }

        .btn-action {
            transition: all 0.1s;
        }

        .btn-action:active {
            transform: scale(0.98);
        }

        /* SIMPLIFIED TEXT */
        .gradient-text {
            color: #0f172a;
        }

        .dark .gradient-text {
            color: white;
        }

        .text-gradient {
            background: linear-gradient(to right, #2563eb, #4f46e5);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .gradient-fire {
            background: linear-gradient(135deg, #f97316 0%, #ef4444 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .promo-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ef4444;
            color: white;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 0.7rem;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #e2e8f0;
            border: 1px solid #e2e8f0;
        }

        .dark .calendar-grid {
            background: #334155;
            border: 1px solid #334155;
        }

        .calendar-day {
            background: white;
            min-height: 90px;
            padding: 6px;
            display: flex;
            flex-direction: column;
            cursor: pointer;
            transition: background 0.2s;
        }

        .dark .calendar-day {
            background: #1e293b;
        }

        .calendar-day:hover {
            background: #f1f5f9;
        }

        .dark .calendar-day:hover {
            background: #334155;
        }

        @media print {
            body {
                background: white !important;
                color: black !important;
            }

            .no-print,
            #sidebar,
            #mobile-nav,
            #view-login,
            .view-section,
            #signature-pad-container {
                display: none !important;
            }

            #print-area {
                display: block !important;
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: 9999;
            }

            .print-page {
                padding: 0;
                margin: 0;
                width: 100%;
            }
        }

        #print-area {
            display: none !important;
        }

        /* DRAWER MENU */
        #main-menu {
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #main-menu.open {
            transform: translateX(0);
        }

        #menu-overlay.open {
            display: block;
            opacity: 1;
        }
    </style>
</head>

<body
    class="bg-slate-50 text-slate-800 antialiased dark:bg-[#0f172a] dark:text-slate-200 h-screen overflow-hidden flex transition-colors duration-300">

    <!-- HAMBURGER REMOVED -->

    <!-- RIGHT DRAWER MENU -->
    <!-- MENU OVERLAY REMOVED -->

    <!-- DRAWER MENU REMOVED -->

    <!-- 0. LANDING PAGE / LOGIN -->
    <section id="view-login"
        class="fixed inset-0 z-[100] bg-white dark:bg-[#0f172a] overflow-y-auto view-section active">
        <!-- 1. HERO (HOOK) -->
        <div class="relative pt-24 pb-12 lg:pt-32 lg:pb-20 overflow-hidden">
            <div
                class="absolute inset-0 bg-[radial-gradient(ellipse_at_top_right,_var(--tw-gradient-stops))] from-brand-200/40 via-transparent to-transparent dark:from-brand-900/20">
            </div>
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 relative z-10 text-center">
                <div
                    class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-brand-50 dark:bg-brand-900/30 text-brand-600 dark:text-brand-400 font-bold text-sm mb-8 animate-fade-in border border-brand-100 dark:border-brand-800">
                    <span class="w-2 h-2 rounded-full bg-brand-500 animate-pulse"></span>
                    Nouveau : Chiffrage automatique sur photo
                </div>
                <h1
                    class="text-5xl md:text-7xl font-black text-slate-900 dark:text-white tracking-tight mb-6 leading-tight animate-slide-up">
                    Ton devis se fait<br>
                    <span class="text-transparent bg-clip-text bg-gradient-to-r from-brand-600 to-purple-600">sur le
                        chantier.</span>
                </h1>
                <p
                    class="mt-6 max-w-2xl mx-auto text-xl text-slate-500 dark:text-slate-400 mb-10 animate-slide-up delay-100">
                    Transformez une photo en devis sign√©.
                    <span class="text-slate-900 dark:text-white font-bold">Gagnez 4h par semaine</span> et s√©curisez vos
                    marges.
                </p>
                <div class="flex flex-col gap-4 max-w-sm mx-auto animate-slide-up delay-200">
                    <div
                        class="bg-white dark:bg-slate-800 p-2 rounded-2xl shadow-xl border border-slate-100 dark:border-slate-700 flex flex-col gap-2">
                        <input type="email" id="login-email" placeholder="Votre email"
                            class="w-full bg-slate-50 dark:bg-slate-900 px-4 py-3 rounded-xl outline-none focus:ring-2 focus:ring-brand-500 dark:text-white font-bold">
                        <input type="password" id="login-password" placeholder="Mot de passe"
                            class="w-full bg-slate-50 dark:bg-slate-900 px-4 py-3 rounded-xl outline-none focus:ring-2 focus:ring-brand-500 dark:text-white font-bold">
                        <button onclick="authManager.loginEmail()"
                            class="btn-action bg-brand-600 text-white font-bold py-3 rounded-xl hover:bg-brand-700 transition-all flex items-center justify-center gap-2">
                            <i class="fa-solid fa-arrow-right"></i>
                            Se connecter / S'inscrire
                        </button>
                    </div>
                </div>
                <div
                    class="mt-8 flex items-center justify-center gap-6 text-sm text-slate-400 animate-fade-in delay-300">
                    <span class="flex items-center gap-2"><i class="fa-solid fa-check text-green-500"></i> Sans
                        engagement</span>
                    <span class="flex items-center gap-2"><i class="fa-solid fa-check text-green-500"></i> Gratuit pour
                        d√©marrer</span>
                </div>
            </div>
        </div>

        <!-- 2. PROBLEM (EMPATHY) -->
        <div class="py-20 bg-slate-50 dark:bg-slate-900/50">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <h2 class="text-3xl font-black text-center mb-12 dark:text-white">Le cauchemar de l'artisan...</h2>
                <div class="grid md:grid-cols-3 gap-8">
                    <div
                        class="bg-white dark:bg-slate-800 p-8 rounded-3xl shadow-sm border border-slate-100 dark:border-slate-700 relative">
                        <i
                            class="fa-solid fa-quote-left text-4xl text-brand-100 dark:text-slate-700 absolute top-6 left-6"></i>
                        <p class="text-lg text-slate-600 dark:text-slate-300 relative z-10 italic mb-4">"Je passe mes
                            dimanches apr√®s-midi √† faire des devis sur Excel au lieu de profiter de ma famille."</p>
                        <div class="font-bold text-slate-900 dark:text-white">‚Äî Marc, Plombier</div>
                    </div>
                    <div
                        class="bg-white dark:bg-slate-800 p-8 rounded-3xl shadow-sm border border-slate-100 dark:border-slate-700 relative">
                        <i
                            class="fa-solid fa-quote-left text-4xl text-brand-100 dark:text-slate-700 absolute top-6 left-6"></i>
                        <p class="text-lg text-slate-600 dark:text-slate-300 relative z-10 italic mb-4">"J'ai perdu
                            3000‚Ç¨ le mois dernier parce que j'ai oubli√© de facturer des suppl√©ments sur un chantier."
                        </p>
                        <div class="font-bold text-slate-900 dark:text-white">‚Äî Thomas, √âlectricien</div>
                    </div>
                    <div
                        class="bg-white dark:bg-slate-800 p-8 rounded-3xl shadow-sm border border-slate-100 dark:border-slate-700 relative">
                        <i
                            class="fa-solid fa-quote-left text-4xl text-brand-100 dark:text-slate-700 absolute top-6 left-6"></i>
                        <p class="text-lg text-slate-600 dark:text-slate-300 relative z-10 italic mb-4">"Mes clients ne
                            signent pas mes devis car ils les trouvent 'brouillons' et peu professionnels."</p>
                        <div class="font-bold text-slate-900 dark:text-white">‚Äî Julien, Peintre</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. SOLUTION (SCHEMA) -->
        <div class="py-24 bg-white dark:bg-[#0f172a]">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
                <h2 class="text-3xl md:text-4xl font-black mb-16 dark:text-white">La M√©thode GoChantier</h2>
                <div class="grid md:grid-cols-3 gap-12 relative">
                    <!-- Connector Line (Desktop) -->
                    <div
                        class="hidden md:block absolute top-12 left-0 w-full h-1 bg-gradient-to-r from-transparent via-brand-200 to-transparent dark:via-brand-900">
                    </div>

                    <div class="relative z-10">
                        <div
                            class="w-24 h-24 mx-auto bg-white dark:bg-slate-800 rounded-full border-4 border-brand-100 dark:border-brand-900 flex items-center justify-center text-4xl text-brand-600 mb-6 shadow-xl">
                            <i class="fa-solid fa-camera"></i>
                        </div>
                        <h3 class="text-xl font-bold mb-2 dark:text-white">1. Photographiez</h3>
                        <p class="text-slate-500">Prenez une photo du probl√®me ou dictez vos notes vocalement.</p>
                    </div>
                    <div class="relative z-10">
                        <div
                            class="w-24 h-24 mx-auto bg-white dark:bg-slate-800 rounded-full border-4 border-purple-100 dark:border-purple-900 flex items-center justify-center text-4xl text-purple-600 mb-6 shadow-xl">
                            <i class="fa-solid fa-wand-magic-sparkles"></i>
                        </div>
                        <h3 class="text-xl font-bold mb-2 dark:text-white">2. Analyse Automatique</h3>
                        <p class="text-slate-500">L'outil identifie les travaux, calcule les surfaces et propose les
                            prix.</p>
                    </div>
                    <div class="relative z-10">
                        <div
                            class="w-24 h-24 mx-auto bg-white dark:bg-slate-800 rounded-full border-4 border-green-100 dark:border-green-900 flex items-center justify-center text-4xl text-green-600 mb-6 shadow-xl">
                            <i class="fa-solid fa-paper-plane"></i>
                        </div>
                        <h3 class="text-xl font-bold mb-2 dark:text-white">3. Encaissez</h3>
                        <p class="text-slate-500">Le devis est envoy√©. Le client signe sur le mobile. Vous facturez.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 4. PRODUCT (TRANSPARENCY) -->
        <div class="py-24 bg-slate-900 text-white overflow-hidden relative">
            <div class="absolute top-0 right-0 w-1/2 h-full bg-gradient-to-l from-brand-900/20 to-transparent"></div>
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 relative z-10">
                <div class="grid lg:grid-cols-2 gap-16 items-center">
                    <div>
                        <div
                            class="inline-block px-3 py-1 rounded-lg bg-brand-500/20 text-brand-400 font-bold text-xs mb-6">
                            TOUT-EN-UN</div>
                        <h2 class="text-4xl font-black mb-6 leading-tight">Votre bureau tient dans votre poche.</h2>
                        <p class="text-slate-400 text-lg mb-8">Plus besoin d'ordinateur. GoChantier est con√ßu pour √™tre
                            utilis√© avec un seul pouce, directement sur le chantier.</p>

                        <ul class="space-y-6">
                            <li class="flex items-start gap-4">
                                <div
                                    class="w-10 h-10 rounded-lg bg-green-500/20 flex items-center justify-center text-green-400 shrink-0">
                                    <i class="fa-solid fa-check"></i>
                                </div>
                                <div>
                                    <div class="font-bold text-xl">Devis & Factures Illimit√©s</div>
                                    <div class="text-slate-400 text-sm">Cr√©ez, modifiez et envoyez sans limite.</div>
                                </div>
                            </li>
                            <li class="flex items-start gap-4">
                                <div
                                    class="w-10 h-10 rounded-lg bg-purple-500/20 flex items-center justify-center text-purple-400 shrink-0">
                                    <i class="fa-solid fa-robot"></i>
                                </div>
                                <div>
                                    <div class="font-bold text-xl">Calcul de marge automatique</div>
                                    <div class="text-slate-400 text-sm">Il v√©rifie que vous ne perdez pas d'argent.
                                    </div>
                                </div>
                            </li>
                            <li class="flex items-start gap-4">
                                <div
                                    class="w-10 h-10 rounded-lg bg-blue-500/20 flex items-center justify-center text-blue-400 shrink-0">
                                    <i class="fa-solid fa-signature"></i>
                                </div>
                                <div>
                                    <div class="font-bold text-xl">Signature √âlectronique</div>
                                    <div class="text-slate-400 text-sm">Faites signer le client imm√©diatement.</div>
                                </div>
                            </li>
                        </ul>
                    </div>

                    <!-- MOCKUP VISUALIZATION (CSS ONLY) -->
                    <div
                        class="relative mx-auto border-gray-800 dark:border-gray-800 bg-gray-800 border-[14px] rounded-[2.5rem] h-[600px] w-[300px] shadow-xl">
                        <div
                            class="w-[148px] h-[18px] bg-gray-800 top-0 rounded-b-[1rem] left-1/2 -translate-x-1/2 absolute">
                        </div>
                        <div class="h-[32px] w-[3px] bg-gray-800 absolute -left-[17px] top-[72px] rounded-l-lg"></div>
                        <div class="h-[46px] w-[3px] bg-gray-800 absolute -left-[17px] top-[124px] rounded-l-lg"></div>
                        <div class="h-[46px] w-[3px] bg-gray-800 absolute -left-[17px] top-[178px] rounded-l-lg"></div>
                        <div class="h-[64px] w-[3px] bg-gray-800 absolute -right-[17px] top-[142px] rounded-r-lg"></div>
                        <div class="rounded-[2rem] overflow-hidden w-full h-full bg-white dark:bg-slate-900 relative">
                            <!-- SCREEN CONTENT MOCK -->
                            <div class="p-6 pt-12 bg-slate-50 dark:bg-slate-900 h-full flex flex-col">
                                <div class="flex justify-between items-center mb-6">
                                    <div class="font-bold text-slate-900 dark:text-white">Devis #2401</div>
                                    <div class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full">Brouillon
                                    </div>
                                </div>
                                <div class="space-y-3 flex-1">
                                    <div
                                        class="bg-white dark:bg-slate-800 p-3 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700">
                                        <div class="text-xs text-slate-400 mb-1">Client</div>
                                        <div class="font-bold text-slate-900 dark:text-white">M. Dupont</div>
                                    </div>
                                    <div
                                        class="bg-white dark:bg-slate-800 p-3 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700">
                                        <div class="flex justify-between mb-1">
                                            <span class="font-bold text-slate-900 dark:text-white">R√©novation SDB</span>
                                            <span class="font-bold text-brand-600">450‚Ç¨</span>
                                        </div>
                                        <div class="text-xs text-slate-400">Pose carrelage mural...</div>
                                    </div>
                                    <div
                                        class="bg-purple-50 dark:bg-purple-900/20 p-3 rounded-xl border border-purple-100 dark:border-purple-800 flex items-center gap-3">
                                        <i class="fa-solid fa-wand-magic-sparkles text-purple-600"></i>
                                        <div class="text-xs text-purple-700 dark:text-purple-300 font-bold">Marge
                                            optimis√©e d√©tect√©e</div>
                                    </div>
                                </div>
                                <div class="mt-auto">
                                    <div
                                        class="w-full bg-brand-600 text-white py-3 rounded-xl font-bold text-center shadow-lg shadow-brand-500/30">
                                        Envoyer (1 clic)</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 5. SOCIAL PROOF & CTA -->
        <div class="py-24 bg-slate-50 dark:bg-[#0f172a] text-center">
            <div class="max-w-4xl mx-auto px-4">
                <h2 class="text-3xl font-black mb-12 dark:text-white">Ils ont modernis√© leur activit√©</h2>
                <div class="grid md:grid-cols-2 gap-8 mb-16">
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm text-left">
                        <div class="flex items-center gap-1 text-amber-400 mb-3">
                            <i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i
                                class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i
                                class="fa-solid fa-star"></i>
                        </div>
                        <p class="text-slate-600 dark:text-slate-300 mb-4">"C'est simple : je ne rentre plus chez moi
                            avec de la paperasse. Tout est fait dans la camionnette."</p>
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-slate-200"></div>
                            <div>
                                <div class="font-bold text-slate-900 dark:text-white">Karim B.</div>
                                <div class="text-xs text-slate-400">Plombier Chauffagiste</div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm text-left">
                        <div class="flex items-center gap-1 text-amber-400 mb-3">
                            <i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i
                                class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i
                                class="fa-solid fa-star"></i>
                        </div>
                        <p class="text-slate-600 dark:text-slate-300 mb-4">"L'outil m'a bluff√©. Il a reconnu mes
                            fournitures sur une photo floue. Gain de temps √©norme."</p>
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-slate-200"></div>
                            <div>
                                <div class="font-bold text-slate-900 dark:text-white">Sophie L.</div>
                                <div class="text-xs text-slate-400">D√©coratrice</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div
                    class="bg-brand-600 rounded-3xl p-12 text-white shadow-2xl shadow-brand-500/40 relative overflow-hidden">
                    <div
                        class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10">
                    </div>
                    <h2 class="text-3xl md:text-4xl font-black mb-6 relative z-10">Pr√™t √† gagner du temps ?</h2>
                    <p class="text-brand-100 text-xl mb-8 max-w-2xl mx-auto relative z-10">Rejoignez 500+ artisans.
                        Aucun engagement. Pas de carte bancaire.</p>
                    <button onclick="authManager.login()"
                        class="relative z-10 bg-white text-brand-600 font-black py-4 px-10 rounded-2xl shadow-xl hover:scale-105 transition-transform text-lg">
                        Essayer gratuitement
                    </button>
                </div>
            </div>
        </div>

        <!-- FOOTER -->
        <div class="py-12 bg-slate-50 dark:bg-[#0f172a] border-t border-slate-200 dark:border-slate-800 text-center">
            <p class="text-slate-500 dark:text-slate-400 mb-4">GoChantier - L'outil des Artisans Modernes</p>
            <div class="mt-8 text-xs text-slate-300">
                ¬© 2025 GoChantier. Tous droits r√©serv√©s. v4.0 <br>
                <a href="#" onclick="uiManager.openLegalModal('mentions')"
                    class="hover:text-brand-500 underline">Mentions L√©gales</a> -
                <a href="#" onclick="uiManager.openLegalModal('cgu')" class="hover:text-brand-500 underline">CGU &
                    Confidentialit√©</a>
            </div>
        </div>

        <div id="login-error"
            class="fixed bottom-4 left-1/2 -translate-x-1/2 text-red-500 text-xs hidden bg-red-100 p-3 rounded-lg shadow-lg z-50">
        </div>
    </section>

    <!-- SIDEBAR (Desktop) -->
    <aside id="sidebar"
        class="w-64 bg-white dark:bg-[#0f172a] border-r border-slate-200 dark:border-slate-800 flex flex-col transition-all duration-300 z-20 hidden md:flex">
        <div class="p-6 flex items-center gap-3">
            <span class="font-black text-xl tracking-tight dark:text-white">GoChantier <span
                    class="text-purple-600">IA</span></span>
            <span id="badge-status-desktop"
                class="ml-auto text-[10px] font-bold bg-green-100 dark:bg-green-900/30 px-2 py-1 rounded-full text-green-700 dark:text-green-400 flex items-center gap-1">ONLINE</span>
        </div>
        <nav class="flex-1 px-4 space-y-1">
            <a onclick="router.navigate('devis'); setTimeout(() => document.getElementById('btn-smart-mic').scrollIntoView({behavior: 'smooth'}), 500)"
                id="nav-ai"
                class="nav-item flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl text-white bg-gradient-to-r from-purple-600 to-purple-500 shadow-lg shadow-purple-500/30 hover:scale-[1.02] transition-all cursor-pointer mb-4">
                <i class="fa-solid fa-wand-magic-sparkles w-5"></i>
                <span class="flex-1 font-bold">IA Chantier</span>
                <span class="bg-white text-purple-600 text-[10px] font-bold px-2 py-0.5 rounded-full">NEW</span>
            </a>

            <a onclick="router.navigate('home')" id="nav-home"
                class="nav-item flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors cursor-pointer"><i
                    class="fa-solid fa-home w-5"></i> Tableau de bord</a>

            <!-- DROPDOWN GESTION -->
            <div>
                <button
                    onclick="document.getElementById('submenu-gestion').classList.toggle('hidden');document.getElementById('chevron-gestion').classList.toggle('rotate-180')"
                    class="w-full flex items-center justify-between px-4 py-3 text-sm font-medium rounded-xl text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors cursor-pointer group">
                    <div class="flex items-center gap-3"><i class="fa-solid fa-briefcase w-5"></i> Gestion</div>
                    <i id="chevron-gestion"
                        class="fa-solid fa-chevron-down text-xs transition-transform duration-200"></i>
                </button>
                <div id="submenu-gestion" class="hidden pl-4 space-y-1 mt-1">
                    <a onclick="router.navigate('clients')" id="nav-clients"
                        class="nav-item flex items-center gap-3 px-4 py-2 text-sm font-medium rounded-xl text-slate-500 dark:text-slate-500 hover:text-brand-600 dark:hover:text-brand-400 transition-colors cursor-pointer"><i
                            class="fa-solid fa-users w-4"></i> Clients</a>
                    <a onclick="router.navigate('items')" id="nav-items"
                        class="nav-item flex items-center gap-3 px-4 py-2 text-sm font-medium rounded-xl text-slate-500 dark:text-slate-500 hover:text-brand-600 dark:hover:text-brand-400 transition-colors cursor-pointer"><i
                            class="fa-solid fa-box w-4"></i> Articles</a>
                    <a onclick="router.navigate('expenses')" id="nav-expenses"
                        class="nav-item flex items-center gap-3 px-4 py-2 text-sm font-medium rounded-xl text-slate-500 dark:text-slate-500 hover:text-brand-600 dark:hover:text-brand-400 transition-colors cursor-pointer"><i
                            class="fa-solid fa-receipt w-4"></i> D√©penses</a>
                    <a onclick="router.navigate('deals')" id="nav-deals"
                        class="nav-item flex items-center gap-3 px-4 py-2 text-sm font-medium rounded-xl text-slate-500 dark:text-slate-500 hover:text-brand-600 dark:hover:text-brand-400 transition-colors cursor-pointer"><i
                            class="fa-solid fa-tags w-4"></i> Bons Plans</a>
                </div>
            </div>

            <a onclick="router.navigate('settings')" id="nav-settings"
                class="nav-item flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors cursor-pointer"><i
                    class="fa-solid fa-cog w-5"></i> Param√®tres</a>
        </nav>
        <div class="p-4 border-t border-slate-200 dark:border-slate-800">
            <div class="flex items-center gap-3 p-2 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-800 cursor-pointer"
                onclick="authManager.logout()">
                <img id="user-photo" src="" class="w-8 h-8 rounded-full bg-slate-200">
                <div class="flex-1 min-w-0">
                    <div id="user-name" class="text-sm font-bold truncate dark:text-white">...</div>
                    <div class="text-xs text-slate-400">D√©connexion</div>
                </div>
            </div>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 overflow-y-auto custom-scrollbar relative w-full pb-24 md:pb-0">

        <!-- VIEWS -->
        <!-- 1. HOME -->
        <section id="view-home" class="view-section hidden p-4 md:p-8 max-w-6xl mx-auto">
            <div class="mb-8 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div>
                    <h1 class="text-3xl md:text-4xl font-black dark:text-white mb-2">Bonjour, <span id="dash-name"
                            class="gradient-text">Chef</span> üëã</h1>
                    <p class="text-slate-500 dark:text-slate-400 text-base flex items-center gap-2"><span
                            class="bg-amber-100 text-amber-700 px-2 py-0.5 rounded text-xs font-bold"><i
                                class="fa-solid fa-clock mr-1"></i>28 jours restants</span> Acc√®s Premium Offert</p>
                </div>
                <button onclick="themeManager.toggle()"
                    class="w-10 h-10 rounded-full glass flex items-center justify-center text-slate-500"><i
                        class="fa-solid fa-moon dark:hidden"></i><i
                        class="fa-solid fa-sun hidden dark:inline"></i></button>
            </div>

            <!-- SAVINGS BANNER -->
            <div
                class="mb-8 bg-gradient-to-r from-green-600 to-emerald-800 rounded-2xl p-6 text-white shadow-lg flex flex-col md:flex-row items-center justify-between gap-4 relative overflow-hidden">
                <div
                    class="absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full -translate-y-1/2 translate-x-1/3 blur-3xl">
                </div>
                <div class="relative z-10">
                    <div class="text-green-100 text-xs font-bold uppercase tracking-wider mb-1">Gain estim√© avec
                        GoChantier</div>
                    <div class="text-3xl md:text-4xl font-black flex items-baseline gap-2">
                        <span id="stat-savings">1 250 ‚Ç¨</span>
                        <span class="text-sm font-normal text-green-200">cette ann√©e</span>
                    </div>
                    <p class="text-green-100 text-sm mt-2 max-w-md">Bas√© sur le temps gagn√© en administratif et les
                        devis mieux relanc√©s.</p>
                </div>
                <div class="relative z-10">
                    <button onclick="router.navigate('devis')"
                        class="bg-white text-green-700 px-6 py-3 rounded-xl font-bold shadow-lg hover:scale-105 transition-transform flex items-center gap-2">
                        <i class="fa-solid fa-rocket"></i> Augmenter mes gains
                    </button>
                </div>
            </div>

            <!-- STATS GRID -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div class="glass p-5 rounded-2xl shadow-sm card-hover border border-slate-200 dark:border-slate-700">
                    <div class="text-xs font-bold text-slate-400 uppercase mb-2">Chiffre d'Affaires</div>
                    <div class="text-2xl font-black text-slate-900 dark:text-white" id="stat-revenue">-- ‚Ç¨</div>
                </div>
                <div class="glass p-5 rounded-2xl shadow-sm card-hover border border-slate-200 dark:border-slate-700">
                    <div class="text-xs font-bold text-slate-400 uppercase mb-2">Devis Sign√©s</div>
                    <div class="text-2xl font-black text-slate-900 dark:text-white" id="stat-signed">--</div>
                </div>
                <div class="glass p-5 rounded-2xl shadow-sm card-hover border border-slate-200 dark:border-slate-700">
                    <div class="text-xs font-bold text-slate-400 uppercase mb-2">Marge Nette</div>
                    <div class="text-2xl font-black text-green-600" id="stat-margin">-- ‚Ç¨</div>
                </div>
                <div class="bg-gradient-to-br from-brand-600 to-brand-800 p-5 rounded-2xl shadow-lg text-white cursor-pointer card-hover btn-action"
                    onclick="router.navigate('devis')">
                    <div class="text-xs font-bold text-brand-100 uppercase mb-2">Action Rapide</div>
                    <div class="text-lg font-black flex items-center gap-2"><i class="fa-solid fa-plus-circle"></i>
                        Cr√©er Devis</div>
                </div>
            </div>

            <!-- CHART SECTION (NEW) -->
            <div class="glass p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg dark:text-white flex items-center gap-2"><i
                            class="fa-solid fa-chart-line text-brand-500"></i> √âvolution du C.A.</h3>
                    <select id="chart-year"
                        class="bg-slate-100 dark:bg-slate-800 text-xs font-bold rounded-lg px-2 py-1 outline-none border-none"
                        onchange="dashboard.loadChart()">
                        <option value="2024">2024</option>
                        <option value="2025" selected>2025</option>
                    </select>
                </div>
                <div class="w-full h-64 relative">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>

            <div class="flex flex-col md:flex-row gap-4 mb-8">
                <!-- BONS PLANS CARD HOME -->
                <div class="flex-1 p-6 rounded-2xl bg-gradient-to-r from-slate-900 to-slate-800 text-white shadow-xl flex justify-between items-center cursor-pointer card-hover"
                    onclick="router.navigate('deals')">
                    <div>
                        <h3 class="font-bold text-xl mb-1 flex items-center gap-2"><i
                                class="fa-solid fa-fire text-red-500"></i> Bons Plans</h3>
                        <p class="text-sm text-slate-400">√âconomisez sur vos outils.</p>
                    </div>
                    <i class="fa-solid fa-chevron-right text-slate-500"></i>
                </div>
                <!-- EXPORT COMPTABLE CARD -->
                <div class="flex-1 p-6 rounded-2xl bg-gradient-to-r from-green-600 to-green-800 text-white shadow-xl flex justify-between items-center cursor-pointer card-hover"
                    onclick="dashboard.exportAccounting()">
                    <div>
                        <h3 class="font-bold text-xl mb-1 flex items-center gap-2"><i
                                class="fa-solid fa-file-excel"></i> Export Comptable</h3>
                        <p class="text-sm text-green-100">T√©l√©charger tout en CSV.</p>
                    </div>
                    <i class="fa-solid fa-download text-green-200"></i>
                </div>
            </div>

            <div class="glass rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700 overflow-hidden">
                <div class="p-6 border-b border-slate-200 dark:border-slate-700 flex justify-between">
                    <h3 class="font-bold dark:text-white">Derniers Documents</h3><button
                        onclick="router.navigate('devis')"
                        class="text-xs font-bold text-brand-600 bg-brand-50 px-3 py-1 rounded-lg">Nouveau</button>
                </div>
                <ul id="dash-recent-list" class="divide-y divide-slate-200 dark:divide-slate-700"></ul>
            </div>
        </section>

        <!-- 2. DEALS -->
        <section id="view-deals" class="view-section hidden p-4 md:p-8 max-w-6xl mx-auto">
            <div class="mb-8">
                <h1 class="text-3xl font-black dark:text-white mb-2 flex items-center gap-2">Bons Plans <span
                        class="gradient-fire">Pro</span> <i class="fa-solid fa-fire text-red-500 animate-pulse"></i>
                </h1>
                <p class="text-slate-500 text-sm">Les meilleures offres outillage du web.</p>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6" id="deals-grid"></div>
        </section>

        <!-- 3. DEVIS -->
        <section id="view-devis"
            class="view-section hidden p-0 h-full flex flex-col max-w-5xl mx-auto glass md:shadow-2xl md:my-6 md:rounded-3xl md:h-[calc(100vh-3rem)] overflow-hidden border border-slate-200 dark:border-slate-700">
            <div
                class="px-6 py-4 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center glass z-20">
                <button onclick="router.navigate('home')" class="text-slate-500 font-bold text-sm"><i
                        class="fa-solid fa-arrow-left mr-1"></i> Retour</button>
                <div class="flex bg-slate-100 dark:bg-slate-800 rounded-xl p-1">
                    <span
                        class="px-4 py-1.5 rounded-lg text-xs font-bold bg-white dark:bg-slate-700 text-brand-600 shadow-sm">NOUVEAU
                        DEVIS</span>
                </div>
                <div class="flex gap-2">
                    <button onclick="editorManager.print()"
                        class="w-12 h-12 rounded-xl bg-slate-100 hover:bg-slate-200 text-slate-600 flex items-center justify-center transition-colors text-lg"><i
                            class="fa-solid fa-print"></i></button>
                    <!-- BOUTON SIGNER -->
                    <button onclick="signatureManager.openModal()"
                        class="btn-action bg-blue-600 text-white px-4 py-3 rounded-xl font-bold shadow-lg flex items-center gap-2"><i
                            class="fa-solid fa-signature text-lg"></i> <span
                            class="hidden sm:inline">Signer</span></button>
                    <!-- BOUTON SAUVEGARDER -->
                    <button onclick="editorManager.saveDocument()"
                        class="btn-action bg-green-600 text-white px-4 py-3 rounded-xl font-bold shadow-lg flex items-center gap-2"><i
                            class="fa-solid fa-save text-lg"></i> <span class="hidden sm:inline">Enreg.</span></button>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto custom-scrollbar p-4 md:p-8 space-y-6">
                <!-- INDICATEUR DE SIGNATURE -->
                <div id="signature-preview-banner"
                    class="hidden bg-green-100 border border-green-300 rounded-xl p-3 flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <i class="fa-solid fa-check-circle text-green-600 text-xl"></i>
                        <div>
                            <p class="font-bold text-green-800 text-sm">Document Sign√©</p>
                            <p class="text-xs text-green-600">Pr√™t √† √™tre envoy√©</p>
                        </div>
                    </div>
                    <img id="signature-preview-img" src="" class="h-8 border bg-white rounded">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="glass border border-slate-200 dark:border-slate-700 p-5 rounded-2xl cursor-pointer hover:border-brand-400 transition-colors"
                        onclick="clientManager.openAddModal()"><label
                            class="block text-xs font-extrabold text-brand-600 uppercase mb-2">Client</label>
                        <div class="flex justify-between">
                            <div id="editor-client-preview" class="font-bold text-lg dark:text-white text-slate-400">
                                S√©lectionner...</div><i class="fa-solid fa-chevron-down text-slate-400"></i>
                        </div><input type="hidden" id="editor-client-id">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="glass border border-slate-200 dark:border-slate-700 p-5 rounded-2xl"><label
                                class="block text-xs font-extrabold text-brand-600 uppercase mb-2">Date</label><input
                                type="date" id="editor-date"
                                class="w-full bg-slate-100 dark:bg-slate-800 rounded p-1 font-bold dark:text-white outline-none text-slate-900">
                        </div>
                        <div class="glass border border-slate-200 dark:border-slate-700 p-5 rounded-2xl"><label
                                class="block text-xs font-extrabold text-brand-600 uppercase mb-2">Validit√©</label><select
                                id="editor-validity"
                                class="w-full bg-slate-100 dark:bg-slate-800 rounded p-1 font-bold dark:text-white outline-none text-slate-900">
                                <option value="30">30 Jours</option>
                            </select></div>
                    </div>
                </div>
                <!-- AI BUTTON REMOVED -->
                <div>
                    <!-- SMART DICTATION BTN -->
                    <!-- AI TOOLS GRID -->
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <button onclick="editorManager.startSmartDictation()" id="btn-smart-mic"
                            class="py-6 rounded-2xl bg-gradient-to-br from-brand-600 to-brand-500 text-white shadow-lg shadow-brand-500/20 flex flex-col items-center justify-center gap-2 hover:scale-[1.02] transition-transform group">
                            <div
                                class="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center mb-1 group-hover:bg-white/30 transition-colors">
                                <i class="fa-solid fa-microphone text-2xl"></i>
                            </div>
                            <span class="font-bold text-sm">Dict√©e IA</span>
                        </button>
                        <button onclick="document.getElementById('input-ai-photo').click()"
                            class="py-6 rounded-2xl bg-gradient-to-br from-purple-600 to-purple-500 text-white shadow-lg shadow-purple-500/20 flex flex-col items-center justify-center gap-2 hover:scale-[1.02] transition-transform group">
                            <div
                                class="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center mb-1 group-hover:bg-white/30 transition-colors">
                                <i class="fa-solid fa-camera text-2xl"></i>
                            </div>
                            <span class="font-bold text-sm">Analyse Photo</span>
                        </button>
                        <input type="file" id="input-ai-photo" class="hidden" accept="image/*"
                            onchange="editorManager.analyzePhoto(this)">
                    </div>
                    <div
                        class="w-16 h-16 rounded-full bg-white/20 flex items-center justify-center mb-1 group-hover:bg-white/30 transition-colors">
                        <i class="fa-solid fa-microphone text-3xl"></i>
                    </div>
                    <span class="font-black text-lg">Dict√©e Intelligente</span>
                    <span class="text-xs text-brand-100 font-medium">"Pose de 3 prises et 1 tableau..."</span>
                    </button>

                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-bold text-sm uppercase text-slate-500">Prestations</h3><button
                            onclick="editorManager.openLibraryModal()"
                            class="text-sm font-bold text-brand-600 bg-brand-50 px-4 py-2 rounded-lg hover:bg-brand-100 transition-colors"><i
                                class="fa-solid fa-book-open mr-1"></i> Biblio</button>
                    </div>
                    <div id="editor-lines" class="space-y-3"></div><button onclick="editorManager.addLine()"
                        class="mt-4 w-full py-4 border-2 border-dashed border-slate-300 dark:border-slate-700 rounded-2xl text-slate-500 font-bold text-lg hover:border-brand-400 hover:text-brand-600 transition-all flex items-center justify-center gap-2"><i
                            class="fa-solid fa-plus"></i> Ajouter une ligne</button>
                </div>
                <div class="flex justify-end">
                    <div class="w-full md:w-1/2 bg-slate-900 text-white rounded-2xl p-6 shadow-xl">
                        <div class="flex justify-between text-sm text-slate-400 mb-2"><span>Total HT</span><span
                                id="editor-total-ht">0.00 ‚Ç¨</span></div>
                        <div class="flex justify-between text-sm text-slate-400 mb-4 border-b border-slate-700 pb-4">
                            <span>TVA</span><span id="editor-total-tva">0.00 ‚Ç¨</span>
                        </div>
                        <div class="flex justify-between text-3xl font-black"><span>Net</span><span
                                id="editor-total-ttc" class="text-brand-400">0.00 ‚Ç¨</span></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 4. CALENDAR -->
        <section id="view-calendar" class="view-section hidden p-4 md:p-8 max-w-6xl mx-auto h-full flex flex-col">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-3xl font-black dark:text-white mb-1"><span class="gradient-text">Mon
                            Agenda</span>
                    </h2>
                    <p class="text-slate-500 dark:text-slate-400 text-base font-bold capitalize"
                        id="calendar-month-display">...</p>
                </div>
                <div class="flex gap-2"><button onclick="calendarManager.changeMonth(-1)"
                        class="w-10 h-10 rounded-xl glass shadow flex items-center justify-center hover:scale-110 border border-slate-200 dark:border-slate-700"><i
                            class="fa-solid fa-chevron-left text-brand-600"></i></button><button
                        onclick="calendarManager.changeMonth(1)"
                        class="w-10 h-10 rounded-xl glass shadow flex items-center justify-center hover:scale-110 border border-slate-200 dark:border-slate-700"><i
                            class="fa-solid fa-chevron-right text-brand-600"></i></button></div>
            </div>
            <div
                class="glass rounded-2xl shadow-xl border border-slate-200/50 dark:border-slate-700/50 overflow-hidden flex-1 flex flex-col">
                <div
                    class="grid grid-cols-7 border-b border-slate-200 dark:border-slate-700 bg-slate-100 dark:bg-slate-800/50">
                    <div
                        class="py-3 text-center text-xs font-extrabold text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                        Lun</div>
                    <div
                        class="py-3 text-center text-xs font-extrabold text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                        Mar</div>
                    <div
                        class="py-3 text-center text-xs font-extrabold text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                        Mer</div>
                    <div
                        class="py-3 text-center text-xs font-extrabold text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                        Jeu</div>
                    <div
                        class="py-3 text-center text-xs font-extrabold text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                        Ven</div>
                    <div
                        class="py-3 text-center text-xs font-extrabold text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                        Sam</div>
                    <div
                        class="py-3 text-center text-xs font-extrabold text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                        Dim</div>
                </div>
                <div id="calendar-grid"
                    class="calendar-grid flex-1 overflow-y-auto custom-scrollbar p-2 bg-slate-50 dark:bg-slate-900/30">
                </div>
            </div>
        </section>

        <!-- 5. CLIENTS -->
        <section id="view-clients" class="view-section hidden p-4 md:p-8 max-w-6xl mx-auto">
            <h2 class="text-3xl font-black dark:text-white mb-6">Clients</h2>
            <div id="clients-list-body" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div><button
                onclick="clientManager.openAddModal()"
                class="fixed bottom-24 right-6 w-16 h-16 bg-brand-600 text-white rounded-2xl shadow-2xl flex items-center justify-center text-2xl btn-action"><i
                    class="fa-solid fa-plus"></i></button>
        </section>

        <!-- 6. ITEMS -->
        <section id="view-items" class="view-section hidden p-4 md:p-8 max-w-6xl mx-auto">
            <h2 class="text-3xl font-black dark:text-white mb-6">Biblioth√®que</h2>
            <div id="items-list-body" class="space-y-3"></div><button onclick="itemManager.openAddModal()"
                class="fixed bottom-24 right-6 w-16 h-16 bg-brand-600 text-white rounded-2xl shadow-2xl flex items-center justify-center text-2xl btn-action"><i
                    class="fa-solid fa-plus"></i></button>
        </section>

        <!-- 7. EXPENSES (NEW) -->
        <section id="view-expenses" class="view-section hidden p-4 md:p-8 max-w-5xl mx-auto">
            <h2 class="text-3xl font-black dark:text-white mb-6">D√©penses</h2>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <!-- ADD EXPENSE FORM -->
                <div
                    class="md:col-span-1 glass p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 h-fit">
                    <h3 class="font-bold mb-4 dark:text-white">Nouvelle D√©pense</h3>
                    <form onsubmit="event.preventDefault(); expensesManager.add();" class="space-y-3">
                        <div>
                            <label class="text-xs font-bold text-slate-500 uppercase">Date</label>
                            <input type="date" id="exp-date"
                                class="w-full bg-slate-50 dark:bg-slate-800 border-none rounded-xl p-3 text-sm font-bold outline-none focus:ring-2 focus:ring-brand-500 dark:text-white"
                                required>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-slate-500 uppercase">Fournisseur</label>
                            <input type="text" id="exp-supplier" placeholder="Ex: Leroy Merlin"
                                class="w-full bg-slate-50 dark:bg-slate-800 border-none rounded-xl p-3 text-sm font-bold outline-none focus:ring-2 focus:ring-brand-500 dark:text-white"
                                required>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-slate-500 uppercase">Montant TTC</label>
                            <input type="number" step="0.01" id="exp-amount" placeholder="0.00 ‚Ç¨"
                                class="w-full bg-slate-50 dark:bg-slate-800 border-none rounded-xl p-3 text-sm font-bold outline-none focus:ring-2 focus:ring-brand-500 dark:text-white"
                                required>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-slate-500 uppercase">Cat√©gorie</label>
                            <select id="exp-category"
                                class="w-full bg-slate-50 dark:bg-slate-800 border-none rounded-xl p-3 text-sm font-bold outline-none focus:ring-2 focus:ring-brand-500 dark:text-white">
                                <option value="Mat√©riaux">Mat√©riaux</option>
                                <option value="Carburant">Carburant</option>
                                <option value="Sous-traitance">Sous-traitance</option>
                                <option value="Outillage">Outillage</option>
                                <option value="Autre">Autre</option>
                            </select>
                        </div>
                        <button type="submit"
                            class="w-full bg-brand-600 text-white font-bold py-3 rounded-xl hover:bg-brand-700 transition-colors shadow-lg shadow-brand-500/30">Ajouter</button>
                    </form>
                </div>

                <!-- EXPENSES LIST -->
                <div class="md:col-span-2 space-y-4">
                    <div
                        class="glass p-4 rounded-2xl flex justify-between items-center border border-slate-200 dark:border-slate-700">
                        <div>
                            <div class="text-xs font-bold text-slate-400 uppercase">Total D√©penses (Mois)</div>
                            <div class="text-2xl font-black text-slate-900 dark:text-white" id="exp-total-month">
                                0.00 ‚Ç¨</div>
                        </div>
                        <div class="w-10 h-10 rounded-full bg-red-50 text-red-500 flex items-center justify-center">
                            <i class="fa-solid fa-arrow-down"></i>
                        </div>
                    </div>

                    <div
                        class="glass rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
                        <div class="p-4 border-b border-slate-200 dark:border-slate-700 font-bold dark:text-white">
                            Historique</div>
                        <ul id="expenses-list"
                            class="divide-y divide-slate-200 dark:divide-slate-700 max-h-[400px] overflow-y-auto custom-scrollbar">
                            <!-- JS Generated -->
                        </ul>
                    </div>
                </div>
            </div>
        </section>

        <!-- 8. SETTINGS -->
        <section id="view-settings" class="view-section hidden p-4 md:p-8 max-w-3xl mx-auto">
            <h2 class="text-3xl font-black dark:text-white mb-6">Param√®tres & Mentions L√©gales</h2>
            <form onsubmit="settingsManager.save(event)" class="glass p-8 rounded-2xl shadow-lg space-y-6">
                <!-- LOGO UPLOAD -->
                <div>
                    <label class="font-bold text-sm block mb-2 dark:text-white">Logo de l'entreprise</label>
                    <div class="flex items-center gap-4">
                        <div id="preview-logo"
                            class="w-24 h-24 bg-slate-100 dark:bg-slate-800 rounded-xl flex items-center justify-center border border-slate-200 overflow-hidden">
                            <i class="fa-solid fa-image text-slate-400 text-2xl"></i>
                        </div>
                        <div>
                            <input type="file" id="set-logo" class="hidden" accept="image/*"
                                onchange="settingsManager.handleLogo(this)">
                            <button type="button" onclick="document.getElementById('set-logo').click()"
                                class="bg-brand-100 text-brand-600 px-4 py-2 rounded-lg font-bold text-sm hover:bg-brand-200">Choisir
                                une image</button>
                            <p class="text-xs text-slate-500 mt-1">PNG ou JPG (Max 500ko)</p>
                        </div>
                    </div>
                </div>
                <div><label class="font-bold text-sm block mb-2 dark:text-white">Nom Entreprise</label><input
                        id="set-company"
                        class="w-full p-4 bg-slate-50 dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-700 outline-none text-slate-900 dark:text-white">
                </div>
                <div><label class="font-bold text-sm block mb-2 dark:text-white">SIRET</label><input id="set-siret"
                        class="w-full p-4 bg-slate-50 dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-700 outline-none text-slate-900 dark:text-white">
                </div>
                <div><label class="font-bold text-sm block mb-2 dark:text-white">Adresse</label><textarea
                        id="set-address" rows="2"
                        class="w-full p-4 bg-slate-50 dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-700 outline-none text-slate-900 dark:text-white"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="font-bold text-sm block mb-2 dark:text-white text-brand-600">N¬∞ Assurance
                            D√©cennale</label><input id="set-decennale" placeholder="Obligatoire"
                            class="w-full p-4 bg-slate-50 dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-700 outline-none text-slate-900 dark:text-white">
                    </div>
                    <div><label class="font-bold text-sm block mb-2 dark:text-white text-brand-600">Label RGE
                            (Optionnel)</label><input id="set-rge" placeholder="Qualibat / EcoArtisan"
                            class="w-full p-4 bg-slate-50 dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-700 outline-none text-slate-900 dark:text-white">
                    </div>
                </div>
                <!-- TVA Intracommunautaire -->
                <div><label class="font-bold text-sm block mb-2 dark:text-white">N¬∞ TVA
                        Intracommunautaire</label><input id="set-tva-intra"
                        class="w-full p-4 bg-slate-50 dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-700 outline-none text-slate-900 dark:text-white">
                </div>

                <button class="w-full py-4 bg-brand-600 text-white font-bold rounded-xl btn-action">Enregistrer les
                    mentions</button>
            </form>

            <!-- SECTION PROFIL -->
            <div class="glass p-8 rounded-2xl shadow-lg border border-slate-200/50 dark:border-slate-700/50 mt-8">
                <h3 class="font-bold text-lg mb-4 dark:text-white flex items-center gap-2"><i
                        class="fa-solid fa-user-circle text-brand-600"></i> Mon Profil</h3>
                <div class="flex items-center gap-4 mb-6">
                    <img id="settings-photo" src="" class="w-16 h-16 rounded-full bg-slate-200 object-cover">
                    <div>
                        <p class="text-sm text-slate-500">Connect√© en tant que</p>
                        <p id="settings-email" class="font-bold dark:text-white">...</p>
                    </div>
                </div>
                <div class="space-y-4">
                    <div><label class="font-bold text-sm block mb-2 dark:text-white">Nom d'affichage</label><input
                            id="set-username"
                            class="w-full p-4 bg-slate-50 dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-700 outline-none text-slate-900 dark:text-white">
                    </div>
                    <button type="button" onclick="settingsManager.updateProfile()"
                        class="w-full py-3 bg-brand-100 text-brand-700 font-bold rounded-xl hover:bg-brand-200 transition-colors">Mettre
                        √† jour le profil</button>
                    <button type="button" onclick="authManager.logout()"
                        class="w-full py-3 border-2 border-red-100 text-red-500 font-bold rounded-xl hover:bg-red-50 transition-colors">Se
                        d√©connecter</button>
                </div>
            </div>
        </section>

        <!-- 8. SUIVI CHANTIER -->
        <section id="view-sites" class="view-section hidden p-4 md:p-8 max-w-6xl mx-auto">
            <div class="mb-8 flex justify-between items-center">
                <div>
                    <h2 class="text-3xl font-black dark:text-white mb-2"><span class="gradient-text">Suivi de
                            Chantier</span></h2>
                    <p class="text-slate-500 dark:text-slate-400">Journal de bord et photos</p>
                </div><button onclick="siteManager.addNote()"
                    class="bg-brand-600 text-white px-4 py-2 rounded-lg font-bold shadow-lg btn-action"><i
                        class="fa-solid fa-camera mr-2"></i> Ajouter Note/Photo</button>
            </div>
            <div id="sites-feed" class="space-y-6">
                <div class="glass p-6 rounded-2xl border border-slate-200 dark:border-slate-700">
                    <div class="flex items-center gap-3 mb-4">
                        <div
                            class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold">
                            M</div>
                        <div>
                            <div class="font-bold dark:text-white">Exemple : Chantier Mme. Martin</div>
                            <div class="text-xs text-slate-500">Aujourd'hui, 14:30</div>
                        </div>
                    </div>
                    <p class="text-slate-700 dark:text-slate-300 mb-4">Fin de la pose du placo dans le salon.
                        Pr√©voir
                        pon√ßage demain matin.</p>
                </div>
            </div>
        </section>
    </main>

    <!-- MOBILE NAV -->
    <div id="mobile-nav"
        class="md:hidden fixed bottom-0 left-0 right-0 glass border-t border-slate-200/50 dark:border-slate-700/50 flex justify-around p-3 pb-safe z-40 shadow-2xl">
        <button onclick="router.navigate('home')"
            class="p-2 flex flex-col items-center text-slate-400 nav-btn-mobile transition-all" data-target="home"><i
                class="fa-solid fa-house mb-1 text-lg"></i><span class="text-[10px] font-bold">Accueil</span></button>
        <button onclick="router.navigate('calendar')"
            class="p-2 flex flex-col items-center text-slate-400 nav-btn-mobile transition-all"
            data-target="calendar"><i class="fa-solid fa-calendar mb-1 text-lg"></i><span
                class="text-[10px] font-bold">Agenda</span></button>
        <button onclick="router.navigate('devis')" class="p-2 -mt-10">
            <div
                class="w-16 h-16 bg-gradient-to-br from-brand-500 to-brand-700 rounded-2xl flex items-center justify-center text-white shadow-2xl shadow-brand-500/40 hover:scale-110 transition-all">
                <i class="fa-solid fa-plus text-2xl"></i>
            </div>
        </button>
        <button onclick="router.navigate('sites')"
            class="p-2 flex flex-col items-center text-slate-400 nav-btn-mobile transition-all" data-target="sites"><i
                class="fa-solid fa-hard-hat mb-1 text-lg"></i><span
                class="text-[10px] font-bold">Chantier</span></button>
        <button onclick="document.getElementById('modal-mobile-menu').classList.remove('hidden')"
            class="p-2 flex flex-col items-center text-slate-400 nav-btn-mobile transition-all"><i
                class="fa-solid fa-bars mb-1 text-lg"></i><span class="text-[10px] font-bold">Menu</span></button>
    </div>

    <!-- MOBILE MENU BOTTOM SHEET -->
    <div id="modal-mobile-menu"
        class="fixed inset-0 z-[100] hidden bg-black/50 backdrop-blur-sm flex flex-col justify-end animate-fade-in"
        onclick="if(event.target === this) this.classList.add('hidden')">
        <div class="bg-white dark:bg-slate-900 rounded-t-3xl p-6 animate-slide-up">
            <div class="flex justify-center mb-6">
                <div class="w-12 h-1.5 bg-slate-200 dark:bg-slate-700 rounded-full"></div>
            </div>

            <!-- IA SHORTCUT -->
            <button
                onclick="router.navigate('devis'); setTimeout(() => document.getElementById('btn-smart-mic').scrollIntoView({behavior: 'smooth'}), 500); document.getElementById('modal-mobile-menu').classList.add('hidden')"
                class="w-full mb-6 p-4 rounded-2xl bg-gradient-to-r from-purple-600 to-purple-500 text-white shadow-lg shadow-purple-500/30 flex items-center justify-center gap-3 hover:scale-[1.02] transition-transform">
                <i class="fa-solid fa-wand-magic-sparkles text-xl"></i>
                <span class="font-bold text-lg">IA Chantier</span>
            </button>

            <div class="grid grid-cols-4 gap-4 mb-8">
                <button
                    onclick="router.navigate('clients');document.getElementById('modal-mobile-menu').classList.add('hidden')"
                    class="flex flex-col items-center gap-2">
                    <div
                        class="w-14 h-14 rounded-2xl bg-blue-50 dark:bg-blue-900/30 flex items-center justify-center text-blue-600 dark:text-blue-400 text-xl">
                        <i class="fa-solid fa-users"></i>
                    </div>
                    <span class="text-xs font-bold dark:text-slate-300">Clients</span>
                </button>
                <button
                    onclick="router.navigate('items');document.getElementById('modal-mobile-menu').classList.add('hidden')"
                    class="flex flex-col items-center gap-2">
                    <div
                        class="w-14 h-14 rounded-2xl bg-purple-50 dark:bg-purple-900/30 flex items-center justify-center text-purple-600 dark:text-purple-400 text-xl">
                        <i class="fa-solid fa-box"></i>
                    </div>
                    <span class="text-xs font-bold dark:text-slate-300">Articles</span>
                </button>
                <button
                    onclick="router.navigate('expenses');document.getElementById('modal-mobile-menu').classList.add('hidden')"
                    class="flex flex-col items-center gap-2">
                    <div
                        class="w-14 h-14 rounded-2xl bg-red-50 dark:bg-red-900/30 flex items-center justify-center text-red-600 dark:text-red-400 text-xl">
                        <i class="fa-solid fa-receipt"></i>
                    </div>
                    <span class="text-xs font-bold dark:text-slate-300">D√©penses</span>
                </button>
                <button
                    onclick="router.navigate('deals');document.getElementById('modal-mobile-menu').classList.add('hidden')"
                    class="flex flex-col items-center gap-2">
                    <div
                        class="w-14 h-14 rounded-2xl bg-amber-50 dark:bg-amber-900/30 flex items-center justify-center text-amber-600 dark:text-amber-400 text-xl">
                        <i class="fa-solid fa-tags"></i>
                    </div>
                    <span class="text-xs font-bold dark:text-slate-300">Bons Plans</span>
                </button>
            </div>

            <div class="space-y-2">
                <button id="btn-install-app" onclick="pwaManager.install()"
                    class="hidden w-full p-4 rounded-xl bg-gradient-to-r from-brand-600 to-brand-500 text-white flex items-center gap-4 font-bold shadow-lg mb-4">
                    <i class="fa-solid fa-download"></i> Installer l'Application
                </button>
                <button
                    onclick="router.navigate('settings');document.getElementById('modal-mobile-menu').classList.add('hidden')"
                    class="w-full p-4 rounded-xl bg-slate-50 dark:bg-slate-800 flex items-center gap-4 font-bold text-slate-700 dark:text-slate-300">
                    <i class="fa-solid fa-cog text-slate-400"></i> R√©glages
                </button>
                <button onclick="themeManager.toggle()"
                    class="w-full p-4 rounded-xl bg-slate-50 dark:bg-slate-800 flex items-center gap-4 font-bold text-slate-700 dark:text-slate-300">
                    <i class="fa-solid fa-moon text-slate-400"></i> Mode Sombre
                </button>
                <button onclick="authManager.logout()"
                    class="w-full p-4 rounded-xl bg-red-50 text-red-500 flex items-center gap-4 font-bold">
                    <i class="fa-solid fa-sign-out-alt"></i> D√©connexion
                </button>
            </div>
        </div>
    </div>

    <!-- MODALS -->

    <!-- MODAL SIGNATURE -->
    <div id="modal-signature"
        class="fixed inset-0 z-[100] hidden flex flex-col items-center justify-center bg-black/80 backdrop-blur-sm">
        <div class="glass w-full max-w-lg p-6 rounded-3xl animate-slide-up mx-4">
            <h3 class="font-bold text-xl mb-2 dark:text-white flex items-center gap-2">
                <i class="fa-solid fa-signature text-brand-600"></i> Signature Client
            </h3>
            <p class="text-sm text-slate-500 mb-4">Signez dans le cadre ci-dessous :</p>

            <div class="bg-white rounded-xl border-2 border-dashed border-slate-300 overflow-hidden touch-none relative"
                style="height: 250px;">
                <canvas id="signature-pad" class="w-full h-full cursor-crosshair"></canvas>
            </div>

            <div class="flex gap-3 mt-6">
                <button onclick="signatureManager.clear()"
                    class="flex-1 py-3 text-red-500 font-bold bg-red-50 rounded-xl hover:bg-red-100 transition-colors">Effacer</button>
                <button onclick="signatureManager.save()"
                    class="flex-[2] py-3 bg-brand-600 text-white font-bold rounded-xl hover:bg-brand-700 shadow-lg btn-action">Valider
                    la signature</button>
            </div>
            <button onclick="signatureManager.close()"
                class="mt-4 text-xs text-slate-400 w-full text-center hover:text-white">Annuler</button>
        </div>
    </div>

    <div id="modal-ai" class="fixed inset-0 z-[100] hidden flex flex-col items-center justify-end sm:justify-center">
        <div class="fixed inset-0 bg-black/70 backdrop-blur-md" onclick="aiManager.closeModal()"></div>
        <div class="glass w-full sm:max-w-lg p-8 rounded-t-3xl sm:rounded-3xl z-10 animate-slide-up">
            <h3 class="text-2xl font-black mb-4 dark:text-white flex items-center gap-2"><i
                    class="fa-solid fa-wand-magic-sparkles text-purple-500"></i> Assistant IA</h3><textarea
                id="ai-input" rows="4"
                class="w-full p-4 bg-slate-100 dark:bg-slate-800 rounded-xl mb-4 outline-none text-slate-900 dark:text-white"
                placeholder="D√©crivez les travaux..."></textarea><button onclick="aiManager.generate()"
                id="ai-btn-generate"
                class="w-full py-4 bg-purple-600 text-white font-bold rounded-xl btn-action">G√©n√©rer</button>
        </div>
    </div>
    <div id="modal-generic"
        class="fixed inset-0 z-[60] hidden flex flex-col items-center justify-end sm:justify-center"></div>

    <!-- PREMIUM MODAL -->
    <div id="modal-premium"
        class="fixed inset-0 z-[80] hidden flex flex-col items-center justify-center bg-slate-900/90 backdrop-blur-sm p-4 animate-fade-in">
        <div
            class="bg-white dark:bg-slate-900 w-full max-w-2xl rounded-3xl overflow-hidden shadow-2xl border border-slate-200 dark:border-slate-700 relative">
            <button onclick="document.getElementById('modal-premium').classList.add('hidden')"
                class="absolute top-4 right-4 w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center text-slate-500 hover:text-red-500 transition-colors z-10">
                <i class="fa-solid fa-times"></i>
            </button>

            <div class="grid grid-cols-1 md:grid-cols-2">
                <div class="p-8 bg-slate-50 dark:bg-slate-800/50 flex flex-col justify-center">
                    <div
                        class="w-16 h-16 bg-gradient-to-br from-amber-400 to-orange-600 rounded-2xl flex items-center justify-center text-white text-3xl mb-6 shadow-lg shadow-orange-500/30">
                        <i class="fa-solid fa-crown"></i>
                    </div>
                    <h2 class="text-3xl font-black text-slate-900 dark:text-white mb-2">Passez <span
                            class="gradient-fire">Premium</span></h2>
                    <p class="text-slate-500 dark:text-slate-400 mb-6">D√©bloquez tout le potentiel de GoChantier pour
                        votre
                        entreprise.</p>
                    <div class="text-4xl font-black text-slate-900 dark:text-white mb-1">19.00‚Ç¨ <span
                            class="text-sm font-bold text-slate-400">/mois</span></div>
                    <p class="text-xs text-slate-400">Sans engagement. Annulable √† tout moment.</p>
                </div>
                <div class="p-8">
                    <ul class="space-y-4 mb-8">
                        <li class="flex items-center gap-3 text-sm font-bold text-slate-700 dark:text-slate-300">
                            <i class="fa-solid fa-check-circle text-green-500 text-lg"></i> Assistant IA Illimit√©
                        </li>
                        <li class="flex items-center gap-3 text-sm font-bold text-slate-700 dark:text-slate-300">
                            <i class="fa-solid fa-check-circle text-green-500 text-lg"></i> Export Comptable CSV
                        </li>
                        <li class="flex items-center gap-3 text-sm font-bold text-slate-700 dark:text-slate-300">
                            <i class="fa-solid fa-check-circle text-green-500 text-lg"></i> Support Prioritaire
                        </li>
                        <li class="flex items-center gap-3 text-sm font-bold text-slate-700 dark:text-slate-300">
                            <i class="fa-solid fa-check-circle text-green-500 text-lg"></i> Sauvegardes Cloud
                        </li>
                    </ul>
                    <button onclick="DataService.upgrade()"
                        class="w-full py-4 bg-gradient-to-r from-amber-500 to-orange-600 text-white font-bold rounded-xl shadow-lg shadow-orange-500/30 hover:scale-105 transition-transform btn-action">
                        Activer le Premium
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- PRINT TEMPLATE -->
    <div id="print-area">
        <div class="print-page font-sans p-10 max-w-[210mm] mx-auto bg-white text-slate-900 h-full relative">
            <!-- Header -->
            <div class="flex justify-between items-start mb-10 pb-6 border-b-2 border-slate-900">
                <div class="w-1/2">
                    <img id="print-logo" class="h-20 object-contain mb-4 hidden" src="">
                    <div id="print-company-info" class="text-sm text-slate-600 whitespace-pre-line"></div>
                </div>
                <div class="text-right w-1/2">
                    <h1 class="text-5xl font-black uppercase tracking-tighter mb-2" id="print-type">DEVIS</h1>
                    <p class="text-lg font-bold">N¬∞ <span id="print-ref"></span></p>
                    <p class="text-sm text-slate-500">Date : <span id="print-date"></span></p>
                </div>
            </div>

            <!-- Client -->
            <div class="mb-12 bg-slate-50 p-6 rounded-xl border border-slate-100">
                <p class="text-xs font-bold text-slate-400 uppercase mb-2">Factur√© √†</p>
                <h3 class="font-bold text-2xl mb-1" id="print-client-name"></h3>
            </div>

            <!-- Lines -->
            <table class="w-full mb-8">
                <thead class="bg-slate-900 text-white">
                    <tr>
                        <th class="py-3 px-4 text-left text-xs font-bold uppercase rounded-l-lg">Description
                        </th>
                        <th class="py-3 px-4 text-center text-xs font-bold uppercase w-16">Qt√©</th>
                        <th class="py-3 px-4 text-center text-xs font-bold uppercase w-16">TVA</th>
                        <th class="py-3 px-4 text-right text-xs font-bold uppercase w-24">Prix U.</th>
                        <th class="py-3 px-4 text-right text-xs font-bold uppercase w-24 rounded-r-lg">Total
                        </th>
                    </tr>
                </thead>
                <tbody id="print-lines" class="text-sm"></tbody>
            </table>

            <!-- Totals -->
            <div class="flex justify-end mb-10">
                <div class="w-1/2 space-y-2">
                    <div class="flex justify-between text-slate-600"><span>Total HT</span><span class="font-bold"
                            id="print-ht"></span></div>
                    <div class="flex justify-between text-slate-600"><span>Total TVA</span><span class="font-bold"
                            id="print-tva"></span></div>
                    <div
                        class="flex justify-between text-2xl font-black text-slate-900 border-t-2 border-slate-900 pt-2 mt-2">
                        <span>NET √Ä PAYER</span><span id="print-ttc"></span>
                    </div>
                </div>
            </div>

            <!-- Signature Area Print -->
            <div class="flex justify-between mt-10 mb-20">
                <div class="w-1/3 border-t border-slate-300 pt-2">
                    <p class="text-xs font-bold uppercase text-slate-400">Pour l'entreprise</p>
                </div>
                <div class="w-1/3 border-t border-slate-300 pt-2 relative">
                    <p class="text-xs font-bold uppercase text-slate-400">Bon pour accord (Client)</p>
                    <img id="print-signature-img" class="absolute top-4 left-0 w-full h-auto mix-blend-multiply hidden"
                        src="">
                    <p id="print-signature-date" class="text-[10px] text-slate-400 mt-20 hidden">Sign√©
                        num√©riquement
                        le...</p>
                </div>
            </div>

            <!-- Footer Legal -->
            <div class="absolute bottom-10 left-10 right-10 text-center border-t pt-4 text-[10px] text-slate-400">
                <p id="print-legal-footer"></p>
                <p class="mt-1">Document g√©n√©r√© par GoChantier</p>
            </div>
        </div>
    </div>



    <!-- LOGIC -->
    <script type="module">
        // --- 1. CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyBXRdDsXLzDpksSXTQb8EVrRaEU5s4Xfm0",
            authDomain: "progest-e4b55.firebaseapp.com",
            projectId: "progest-e4b55",
            storageBucket: "progest-e4b55.firebasestorage.app",
            messagingSenderId: "195166049754",
            appId: "1:195166049754:web:246a8ef1e7653603eb5ce3"
        };

        // --- 2. IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, deleteDoc, doc, query, where } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, updateProfile, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

        let db, auth;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            console.log("‚úÖ Firebase Initialis√©");
        } catch (e) { console.error("Erreur Firebase:", e); }



        // --- 3. DEALS MANAGER (AFFILIATION) ---
        window.dealsManager = {
            fakeDeals: [
                { title: "Bosch Professional 103 pi√®ces Jeu de forets et d'embouts", price: 34, old: 50, link: "https://amzn.to/3KTfEh0", img: "https://m.media-amazon.com/images/I/811e1lAbH7L._AC_SX569_.jpg", hot: true },
                { title: "Bosch Professional scie circulaire GKS 190", price: 122, old: 130, link: "https://amzn.to/3KW1EmQ", img: "https://m.media-amazon.com/images/I/51crVNWfQlL._AC_SX569_.jpg", hot: false },
                { title: "Makita DDF482Z Perceuse visseuse 60 nm 18 V Bleu", price: 79, old: 117, link: "https://amzn.to/4oR8nwo", img: "https://m.media-amazon.com/images/I/71bmqgnZQdL._AC_SY679_.jpg", hot: true },
                { title: "Makita DBO180Z Ponceuse Excentrique √ò 125 mm", price: 93, old: 118, link: "https://amzn.to/3MXR6UI", img: "https://m.media-amazon.com/images/I/51txDg7nshL._AC_SX569_.jpg", hot: false }
            ],
            render() {
                const g = document.getElementById('deals-grid'); if (!g) return;
                g.innerHTML = '';
                this.fakeDeals.forEach(d => {
                    const discount = Math.round(((d.old - d.price) / d.old) * 100);
                    const fire = d.hot ? '<i class="fa-solid fa-fire text-orange-500 animate-pulse absolute top-3 left-3 text-lg bg-white rounded-full p-1 shadow"></i>' : '';
                    g.innerHTML += `
                    <div class="glass rounded-2xl overflow-hidden shadow-lg card-hover relative group">
                        ${fire} <span class="promo-badge">-${discount}%</span>
                        <div class="h-48 bg-white flex items-center justify-center p-4 relative">
                            <img src="${d.img}" class="h-full object-contain group-hover:scale-110 transition-transform duration-500">
                        </div>
                        <div class="p-5">
                            <h3 class="font-bold text-slate-900 dark:text-white mb-2 leading-tight h-10 overflow-hidden">${d.title}</h3>
                            <div class="flex items-end gap-2 mb-4"><span class="text-2xl font-black text-red-500">${d.price}‚Ç¨</span><span class="text-sm text-slate-400 line-through mb-1">${d.old}‚Ç¨</span></div>
                            <a href="${d.link}" target="_blank" class="block w-full py-3 bg-slate-900 dark:bg-brand-600 text-white font-bold text-center rounded-xl hover:bg-slate-700 transition-colors btn-action">Voir l'offre</a>
                        </div>
                    </div>`;
                });
            }
        };

        // --- 4. DATA SERVICE ---
        const DataService = {
            userId: null, isPremium: false, // Default to false
            _getLocal(k) { return JSON.parse(localStorage.getItem('pg_' + k) || '[]'); },
            _saveLocal(k, v) { localStorage.setItem('pg_' + k, JSON.stringify(v)); },
            // SECURITY: Sanitize input to prevent XSS
            escapeHtml(text) {
                if (!text) return text;
                return String(text)
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            },
            async get(c) {
                console.log(`Getting ${c}, User: ${this.userId}, DB: ${!!db}`);
                if (db && this.userId && !this.userId.startsWith('demo_')) {
                    try {
                        const q = query(collection(db, c), where("uid", "==", this.userId));
                        const s = await getDocs(q);
                        this._online(true);
                        console.log(`Fetched ${s.docs.length} docs from cloud`);
                        return s.docs.map(d => ({ id: d.id, ...d.data() }));
                    } catch (e) {
                        console.error("Firestore Get Error:", e);
                        this._online(false);
                        // Fallback to local
                    }
                }
                return this._getLocal(c);
            },
            async add(c, d) {
                // alert(`Saving to ${c}...`); // Debug
                d.uid = this.userId || 'guest';
                d.created_at = new Date().toISOString();
                console.log(`Adding to ${c}, User: ${this.userId}, DB: ${!!db}`);

                if (db && this.userId && !this.userId.startsWith('demo_')) {
                    try {
                        const r = await addDoc(collection(db, c), d);
                        this._online(true);
                        console.log("Added to cloud:", r.id);
                        return { id: r.id, ...d };
                    } catch (e) {
                        console.error("Firestore Add Error:", e);
                        alert(`Erreur sauvegarde Cloud: ${e.message}. Sauvegarde locale...`);
                        this._online(false);
                        // Fallback to local execution below
                    }
                }
                const i = this._getLocal(c);
                d.id = 'loc_' + Date.now();
                i.push(d);
                this._saveLocal(c, i);
                console.log("Added locally");
                return d;
            },
            async delete(c, id) {
                if (db && !id.startsWith('loc_') && this.userId && !this.userId.startsWith('demo_')) {
                    try {
                        await deleteDoc(doc(db, c, id));
                        this._online(true);
                        return;
                    } catch (e) {
                        console.error("Firestore Delete Error:", e);
                        this._online(false);
                        // Fallback to local
                    }
                }
                this._saveLocal(c, this._getLocal(c).filter(x => x.id !== id));
            },
            async saveSettings(d) { this._saveLocal('settings', [d]); if (db && this.userId && !this.userId.startsWith('demo_')) try { await this.add('settings', d); } catch { } },
            _online(s) {
                const h = s ? '<span class="w-1.5 h-1.5 bg-green-500 rounded-full status-dot"></span> ONLINE' : 'OFFLINE';
                const d = document.getElementById('badge-status-desktop');
                if (d) d.innerHTML = h;
                // Mobile badge removed
            },

            // PREMIUM LOGIC (BETA GRATUITE)
            STRIPE_LINK: '#',

            checkPremium() {
                // BETA MODE: Tout est gratuit pour l'instant
                return true;
            },
            upgrade() {
                // Simulation d'upgrade pour la beta
                this.isPremium = true;
                alert("üéâ Bienvenue dans la Beta ! Vous avez acc√®s √† toutes les fonctionnalit√©s Premium gratuitement.");
                document.getElementById('modal-premium').classList.add('hidden');

                // Save premium state locally for persistence during session
                localStorage.setItem('pg_premium', 'true');
            },
            initPremium() {
                this.isPremium = localStorage.getItem('pg_premium') === 'true';
            },

            // SAVINGS CALCULATOR (ALGO "REALISTE")
            async calculateSavings() {
                // 1. Base starts at 0
                let total = 0;

                // 2. Count Documents (Local + Cloud if possible, but let's use what we have in memory or fetch count)
                // For simplicity and speed, we'll track "actions" in localStorage counters
                const quoteCount = parseInt(localStorage.getItem('pg_count_quotes') || '0');
                const invoiceCount = parseInt(localStorage.getItem('pg_count_invoices') || '0');
                const siteCount = parseInt(localStorage.getItem('pg_count_sites') || '0');

                // 3. Apply Formula
                // - 1 Devis = 20 mins gagn√©es = ~15‚Ç¨
                // - 1 Facture = 15 mins gagn√©es = ~10‚Ç¨
                // - 1 Chantier suivi = 5‚Ç¨/jour (on simplifie √† 5‚Ç¨ par chantier cr√©√© pour l'instant)
                total += (quoteCount * 15);
                total += (invoiceCount * 10);
                total += (siteCount * 5);

                // 4. Update UI
                const el = document.getElementById('stat-savings');
                if (el) {
                    // Animation effect
                    const currentVal = parseInt(el.innerText.replace(/\D/g, '')) || 0;
                    if (currentVal !== total) {
                        el.innerText = total.toLocaleString('fr-FR') + ' ‚Ç¨';
                        el.classList.add('scale-110', 'text-green-300');
                        setTimeout(() => el.classList.remove('scale-110', 'text-green-300'), 300);
                    }
                }
                return total;
            },
            incrementCounter(type) {
                const key = 'pg_count_' + type;
                const current = parseInt(localStorage.getItem(key) || '0');
                localStorage.setItem(key, current + 1);
                this.calculateSavings(); // Refresh UI immediately
            }
        };
        window.DataService = DataService;
        DataService.initPremium();

        // --- 5. AUTH MANAGER (UPDATED FOR DEMO) ---
        window.authManager = {
            loginEmail: async () => {
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                const errorDiv = document.getElementById('login-error');

                if (!email || !password) return alert("Veuillez remplir l'email et le mot de passe.");
                if (!auth) return alert("Erreur: Firebase non initialis√©");

                errorDiv.classList.add('hidden');

                try {
                    // 1. On essaie de CR√âER le compte (c'est une landing page, donc priorit√© aux nouveaux)
                    await createUserWithEmailAndPassword(auth, email, password);
                } catch (e) {
                    // 2. Si l'email existe d√©j√†, on essaie de se CONNECTER
                    if (e.code === 'auth/email-already-in-use') {
                        try {
                            await signInWithEmailAndPassword(auth, email, password);
                        } catch (loginErr) {
                            console.error(loginErr);
                            // L√† c'est une vraie erreur de connexion (ex: mauvais mot de passe)
                            errorDiv.innerText = "Mot de passe incorrect pour cet email.";
                            errorDiv.classList.remove('hidden');
                        }
                    } else {
                        // Autre erreur de cr√©ation (ex: mot de passe trop court)
                        console.error(e);
                        errorDiv.innerText = "Erreur: " + e.message;
                        errorDiv.classList.remove('hidden');
                    }
                }
            },
            loginDemo: () => {
                try {
                    console.log("Starting Demo Mode...");
                    // Mock user for demo
                    const demoUser = {
                        uid: 'demo_' + Date.now(),
                        displayName: 'Utilisateur D√©mo',
                        email: 'demo@gochantier.com',
                        photoURL: 'https://ui-avatars.com/api/?name=Demo&background=random'
                    };

                    DataService.userId = demoUser.uid;

                    // Update UI
                    const userName = document.getElementById('user-name');
                    const userPhoto = document.getElementById('user-photo');
                    const dashName = document.getElementById('dash-name');
                    const settingsEmail = document.getElementById('settings-email');
                    const setUsername = document.getElementById('set-username');

                    if (userName) userName.innerText = demoUser.displayName;
                    if (userPhoto) userPhoto.src = demoUser.photoURL;
                    if (dashName) dashName.innerText = 'D√©mo';
                    if (settingsEmail) settingsEmail.innerText = demoUser.email;
                    if (setUsername) setUsername.value = demoUser.displayName;

                    // Mock Subscription
                    window.subscriptionManager = { checkLimit: async () => true, checkForSuccess: () => { } };

                    // Initialize Signature for Demo Mode
                    if (window.signatureManager) {
                        window.signatureManager.init();
                    } else {
                        console.error("SignatureManager not found");
                    }

                    // Switch Views
                    const loginView = document.getElementById('view-login');
                    if (loginView) {
                        loginView.classList.remove('active');
                        loginView.classList.add('hidden');
                    }

                    if (window.router) {
                        window.router.navigate('home');
                    } else {
                        alert("Erreur: Router non initialis√©");
                    }

                    alert("Vous √™tes en mode D√âMO. Les donn√©es sont enregistr√©es localement dans votre navigateur.");
                } catch (e) {
                    console.error("Demo Login Error:", e);
                    alert("Erreur lors du lancement de la d√©mo: " + e.message);
                }
            },
            logout: async () => {
                if (confirm("D√©connexion ?")) {
                    if (auth && auth.currentUser) await signOut(auth);
                    window.location.reload();
                }
            }
        };

        // --- NEW : SIGNATURE MANAGER ---
        window.signatureManager = {
            canvas: null, ctx: null, isDrawing: false, currentSignatureData: null,
            init() {
                this.canvas = document.getElementById('signature-pad');
                if (!this.canvas) return;
                this.ctx = this.canvas.getContext('2d');

                // Mouse Events
                this.canvas.addEventListener('mousedown', (e) => this.start(e));
                this.canvas.addEventListener('mousemove', (e) => this.draw(e));
                this.canvas.addEventListener('mouseup', () => this.stop());
                this.canvas.addEventListener('mouseout', () => this.stop());

                // Touch Events
                this.canvas.addEventListener('touchstart', (e) => { e.preventDefault(); this.start(e.touches[0]); });
                this.canvas.addEventListener('touchmove', (e) => { e.preventDefault(); this.draw(e.touches[0]); });
                this.canvas.addEventListener('touchend', () => this.stop());

                // Resize for quality
                this.resizeCanvas();
            },
            resizeCanvas() {
                const parent = this.canvas.parentElement;
                this.canvas.width = parent.clientWidth;
                this.canvas.height = parent.clientHeight;
                this.ctx.lineWidth = 2;
                this.ctx.lineCap = 'round';
                this.ctx.strokeStyle = '#000';
            },
            getPos(e) {
                const rect = this.canvas.getBoundingClientRect();
                return { x: e.clientX - rect.left, y: e.clientY - rect.top };
            },
            start(e) {
                this.isDrawing = true;
                const pos = this.getPos(e);
                this.ctx.beginPath();
                this.ctx.moveTo(pos.x, pos.y);
            },
            draw(e) {
                if (!this.isDrawing) return;
                const pos = this.getPos(e);
                this.ctx.lineTo(pos.x, pos.y);
                this.ctx.stroke();
            },
            stop() { this.isDrawing = false; },
            clear() {
                if (this.ctx) {
                    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                }
                this.currentSignatureData = null;
            },
            openModal() {
                document.getElementById('modal-signature').classList.remove('hidden');
                document.getElementById('modal-signature').classList.add('flex');
                setTimeout(() => this.resizeCanvas(), 50); // Delay for layout
            },
            close() {
                document.getElementById('modal-signature').classList.add('hidden');
                document.getElementById('modal-signature').classList.remove('flex');
            },
            save() {
                this.currentSignatureData = this.canvas.toDataURL();

                // Update UI preview
                const banner = document.getElementById('signature-preview-banner');
                const img = document.getElementById('signature-preview-img');
                banner.classList.remove('hidden');
                img.src = this.currentSignatureData;

                this.close();
            }
        };

        // --- 6. EXPENSES MANAGER ---
        window.expensesManager = {
            async init() {
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('exp-date').value = today;
                this.render();
            },
            async add() {
                const date = document.getElementById('exp-date').value;
                const supplier = document.getElementById('exp-supplier').value;
                const amount = parseFloat(document.getElementById('exp-amount').value);
                const category = document.getElementById('exp-category').value;

                if (!date || !supplier || isNaN(amount)) return alert("Veuillez remplir tous les champs");

                const expense = {
                    date, supplier, amount, category,
                    created_at: new Date().toISOString(),
                    userId: DataService.userId
                };

                await DataService.add('expenses', expense);

                // Reset form
                document.getElementById('exp-supplier').value = '';
                document.getElementById('exp-amount').value = '';
                this.render();
            },
            async del(id) {
                if (confirm("Supprimer cette d√©pense ?")) {
                    await DataService.delete('expenses', id);
                    this.render();
                }
            },
            async render() {
                const list = document.getElementById('expenses-list');
                const totalEl = document.getElementById('exp-total-month');
                if (!list) return;

                const expenses = await DataService.get('expenses');
                expenses.sort((a, b) => new Date(b.date) - new Date(a.date));

                list.innerHTML = '';
                let totalMonth = 0;
                const currentMonth = new Date().getMonth();

                if (expenses.length === 0) {
                    list.innerHTML = '<li class="p-8 text-center text-slate-400 italic">Aucune d√©pense enregistr√©e.</li>';
                }

                expenses.forEach(e => {
                    const d = new Date(e.date);
                    if (d.getMonth() === currentMonth) totalMonth += e.amount;

                    list.innerHTML += `
                        <li class="p-4 hover:bg-slate-50 dark:hover:bg-slate-800/50 flex justify-between items-center group transition-colors">
                            <div class="flex items-center gap-4">
                                <div class="w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center text-slate-500 font-bold text-xs">
                                    ${d.getDate()}/${d.getMonth() + 1}
                                </div>
                                <div>
                                    <div class="font-bold text-slate-900 dark:text-white">${DataService.escapeHtml(e.supplier)}</div>
                                    <div class="text-xs text-slate-500">${DataService.escapeHtml(e.category)}</div>
                                </div>
                            </div>
                            <div class="flex items-center gap-4">
                                <div class="font-black text-slate-900 dark:text-white">-${e.amount.toFixed(2)} ‚Ç¨</div>
                                <button onclick="expensesManager.del('${e.id}')" class="w-8 h-8 rounded-lg text-slate-300 hover:text-red-500 hover:bg-red-50 transition-colors opacity-0 group-hover:opacity-100"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </li>
                    `;
                });

                totalEl.innerText = totalMonth.toFixed(2) + ' ‚Ç¨';
            }
        };

        // --- 7. CORE MANAGERS ---
        window.router = {
            navigate: (id) => {

                document.querySelectorAll('.view-section').forEach(e => { if (e.id !== 'view-login') { e.classList.remove('active'); e.classList.add('hidden'); } });
                const target = document.getElementById('view-' + id);
                if (target) {
                    target.classList.remove('hidden');
                    target.classList.add('active');
                    // Force display for home
                    if (id === 'home') {
                        target.style.display = 'block';
                    } else {
                        target.style.display = '';
                    }

                    // Init specific managers
                    if (id === 'home' && window.dashboard) window.dashboard.load();
                    if (id === 'devis' && window.editorManager) window.editorManager.init();
                    if (id === 'items' && window.itemManager) window.itemManager.render();
                    if (id === 'clients' && window.clientManager) window.clientManager.render();
                    if (id === 'calendar' && window.calendarManager) window.calendarManager.render();
                    if (id === 'expenses' && window.expensesManager) window.expensesManager.init();
                    if (id === 'settings' && window.settingsManager) window.settingsManager.load();
                    if (id === 'deals' && window.dealsManager) window.dealsManager.render();
                }

                // Update Nav Active State
                document.querySelectorAll('.nav-item, .nav-btn, .nav-btn-mobile').forEach(b => {
                    b.classList.remove('bg-slate-100', 'dark:bg-slate-800', 'text-brand-600', 'text-slate-400', 'text-red-500');
                    if (b.classList.contains('nav-btn-mobile')) b.classList.add('text-slate-400');

                    const targetId = b.dataset.target || (b.id ? b.id.replace('nav-', '') : '');

                    if (targetId === id) {
                        if (b.classList.contains('nav-item') || b.classList.contains('nav-btn')) {
                            b.classList.add('bg-slate-100', 'dark:bg-slate-800', 'text-brand-600');
                            // Special case for sub-items in dropdown
                            if (b.parentElement.id === 'submenu-gestion') {
                                // Ensure dropdown is open
                                const subMenu = document.getElementById('submenu-gestion');
                                const chevron = document.getElementById('chevron-gestion');
                                if (subMenu) subMenu.classList.remove('hidden');
                                if (chevron) chevron.classList.add('rotate-180');
                            }
                        }
                        else b.classList.add(id === 'deals' ? 'text-red-500' : 'text-brand-600');
                        b.classList.remove('text-slate-400');
                    }
                });
            }
        };

        window.dashboard = {
            chartInstance: null,
            async load() {
                try {
                    const d = await DataService.get('docs');
                    const e = await DataService.get('expenses'); // Fetch expenses

                    let r = 0, s = 0;
                    d.forEach(x => { if (x.status === 'validated' || x.type === 'facture') { r += x.ttc; s++; } });

                    let exp = 0;
                    e.forEach(x => exp += x.amount); // Calculate total expenses

                    const margin = r - exp; // Calculate Net Margin

                    if (document.getElementById('stat-revenue')) document.getElementById('stat-revenue').innerText = r.toFixed(0) + ' ‚Ç¨';
                    if (document.getElementById('stat-signed')) document.getElementById('stat-signed').innerText = s;
                    if (document.getElementById('stat-margin')) {
                        document.getElementById('stat-margin').innerText = margin.toFixed(2) + ' ‚Ç¨';
                        // Color coding for margin
                        if (margin >= 0) document.getElementById('stat-margin').className = "text-2xl font-black text-green-600";
                        else document.getElementById('stat-margin').className = "text-2xl font-black text-red-600";
                    }

                    // PREMIUM BUTTON IN DASHBOARD
                    const premiumBtn = document.getElementById('btn-go-premium');
                    if (!DataService.isPremium) {
                        if (!premiumBtn) {
                            const statsGrid = document.querySelector('#view-home .grid');
                            if (statsGrid) {
                                const btn = document.createElement('div');
                                btn.id = 'btn-go-premium';
                                btn.className = 'bg-gradient-to-br from-amber-400 to-orange-600 p-5 rounded-2xl shadow-lg text-white cursor-pointer card-hover btn-action relative overflow-hidden';
                                btn.onclick = () => document.getElementById('modal-premium').classList.remove('hidden');
                                btn.innerHTML = `<i class="fa-solid fa-crown absolute -right-4 -bottom-4 text-8xl text-white/20"></i>
                                                 <div class="text-xs font-bold text-amber-100 uppercase mb-2">Upgrade</div>
                                                 <div class="text-lg font-black flex items-center gap-2">Passer Premium</div>`;
                                statsGrid.appendChild(btn);
                            }
                        }
                    } else if (premiumBtn) {
                        premiumBtn.remove();
                    }

                    const l = document.getElementById('dash-recent-list');
                    if (l) {
                        l.innerHTML = '';
                        if (d.length === 0) l.innerHTML = '<li class="p-6 text-center text-sm text-slate-400 italic">Aucun document</li>';
                        d.sort((a, b) => new Date(b.created_at) - new Date(a.created_at)).slice(0, 5).forEach(x =>
                            l.innerHTML += `<li class="p-5 hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-all cursor-pointer flex justify-between items-center border-b border-slate-100 dark:border-800"><div class="font-bold dark:text-white">${x.clientName}</div><div class="font-black">${x.ttc.toFixed(2)}‚Ç¨</div></li>`
                        );
                    }
                    this.loadChart();
                } catch (e) {
                    console.error("Dashboard Load Error:", e);
                }
            },
            async loadChart() {
                const ctx = document.getElementById('revenueChart');
                if (!ctx) return;

                const year = parseInt(document.getElementById('chart-year').value);
                const docs = await DataService.get('docs');

                // Init data array for 12 months
                const monthlyData = Array(12).fill(0);

                docs.forEach(d => {
                    if (d.status === 'validated' || d.type === 'facture') {
                        const date = new Date(d.date);
                        if (date.getFullYear() === year) {
                            monthlyData[date.getMonth()] += d.ttc;
                        }
                    }
                });

                const isDark = document.documentElement.classList.contains('dark');
                const color = isDark ? '#60a5fa' : '#3b82f6';
                const bg = isDark ? 'rgba(96, 165, 250, 0.1)' : 'rgba(59, 130, 246, 0.1)';

                if (this.chartInstance) this.chartInstance.destroy();

                this.chartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['Jan', 'F√©v', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Ao√ªt', 'Sep', 'Oct', 'Nov', 'D√©c'],
                        datasets: [{
                            label: 'Chiffre d\'Affaires (‚Ç¨)',
                            data: monthlyData,
                            borderColor: color,
                            backgroundColor: bg,
                            borderWidth: 3,
                            pointBackgroundColor: 'white',
                            pointBorderColor: color,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: isDark ? '#1e293b' : 'white',
                                titleColor: isDark ? 'white' : '#0f172a',
                                bodyColor: isDark ? '#cbd5e1' : '#64748b',
                                borderColor: isDark ? '#334155' : '#e2e8f0',
                                borderWidth: 1,
                                padding: 10,
                                displayColors: false,
                                callbacks: { label: (c) => c.raw.toFixed(2) + ' ‚Ç¨' }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: { color: isDark ? '#334155' : '#e2e8f0', borderDash: [5, 5] },
                                ticks: { color: isDark ? '#94a3b8' : '#64748b', font: { family: 'Inter', size: 10 } }
                            },
                            x: {
                                grid: { display: false },
                                ticks: { color: isDark ? '#94a3b8' : '#64748b', font: { family: 'Inter', size: 10 } }
                            }
                        }
                    }
                });
            },
            async exportAccounting() {
                if (!DataService.checkPremium()) return; // PREMIUM CHECK
                const docs = await DataService.get('docs');
                if (docs.length === 0) return alert("Aucune facture √† exporter.");

                let csv = "Date;Type;Numero;Client;HT;TVA;TTC\n";
                docs.forEach(d => {
                    const date = new Date(d.date).toLocaleDateString();
                    const tvaTotal = d.ttc - d.ht;
                    csv += `${date};${d.type};${d.id.substr(-4)};${d.clientName};${d.ht.toFixed(2)};${tvaTotal.toFixed(2)};${d.ttc.toFixed(2)}\n`;
                });

                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "export_comptable_gochantier.csv");
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        };

        window.editorManager = {
            // CONFIGURATION IA (SYSTEM PROMPT)
            AI_PROMPT: `Tu es un artisan fran√ßais exp√©riment√©.

√Ä partir de cette photo de chantier :
1. Dis quel type de prestation est n√©cessaire.
2. R√©dige un devis simple et professionnel en fran√ßais.
3. Utilise des phrases claires compr√©hensibles par un client.

Ne parle pas de toi.
Ne parle pas d‚ÄôIA.
Reste r√©aliste et prudent.
            
IMPORTANT : Tu dois r√©pondre UNIQUEMENT au format JSON strict, sans markdown, sans explication.
Le format attendu est une liste d'objets JSON :
[
  { "d": "Description de la prestation", "q": Quantit√©(nombre), "p": PrixUnitaire(nombre) }
]
Exemple :
[
  { "d": "Remplacement prise secteur d√©fectueuse", "q": 1, "p": 45 },
  { "d": "Reprise enduit mur", "q": 10, "p": 35 }
]`,

            lines: [],
            marketPrices: {
                'prise': 25, 'interrupteur': 20, 'tableau': 150, 'peinture': 35, 'robinet': 80, 'wc': 250, 'lavabo': 120, 'douche': 450, 'placo': 45, 'carrelage': 55
            },
            async analyzePhoto(input) {
                if (input.files && input.files[0]) {
                    const btn = input.previousElementSibling;
                    const originalContent = btn.innerHTML;

                    // 1. Get API Key
                    // 1. Get API Key
                    let apiKey = localStorage.getItem('gemini_api_key');
                    if (!apiKey) {
                        this.openApiKeyModal();
                        return;
                    }

                    try {
                        btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin text-2xl"></i><span class="font-bold text-sm">IA r√©fl√©chit...</span>';

                        // 2. Convert Image
                        const base64Image = await this.fileToBase64(input.files[0]);

                        // 3. Call Gemini
                        const jsonResponse = await this.callGeminiAPI(apiKey, base64Image);

                        // 4. Parse Results
                        console.log("IA Response:", jsonResponse);

                        if (this.lines.length === 1 && this.lines[0].d === '' && this.lines[0].p === 0) this.lines = [];

                        jsonResponse.forEach(r => {
                            // Validate data
                            if (r.d && r.p) {
                                this.lines.push({
                                    d: r.d,
                                    q: parseInt(r.q) || 1,
                                    p: parseFloat(r.p) || 0,
                                    tva: 0.2
                                });
                            }
                        });

                        this.renderLines();
                        DataService.incrementCounter('quotes');
                        alert("üì∏ Analyse termin√©e ! Le devis a √©t√© g√©n√©r√© via Gemini Pro Vision.");
                    } catch (e) {
                        console.error("API Error, falling back to simulation:", e);

                        // FALLBACK : MODE SIMULATION
                        // Si l'API √©choue, on ne bloque pas l'utilisateur, on montre que √ßa marche "en principe".
                        const mockResults = [
                            { d: 'R√©novation Mur (D√©tection Auto)', q: 15, p: 45 },
                            { d: 'Pose Prise (D√©tection Auto)', q: 3, p: 25 },
                            { d: 'Peinture Plafond (D√©tection Auto)', q: 1, p: 120 }
                        ];

                        if (this.lines.length === 1 && this.lines[0].d === '' && this.lines[0].p === 0) this.lines = [];

                        mockResults.forEach(r => this.lines.push({ ...r, tva: 0.2 }));
                        this.renderLines();
                        DataService.incrementCounter('quotes');

                        alert("‚ö†Ô∏è Note : Votre cl√© API semble incorrecte ou absente.\n\n‚Üí Mode D√âMO activ√© : Voici un exemple de ce que l'IA g√©n√©rerait.");

                        // On supprime la cl√© incorrecte pour retenter la prochaine fois
                        if (e.message.includes('400') || e.message.includes('403') || e.message.includes('API Error')) {
                            localStorage.removeItem('gemini_api_key');
                        }
                    } finally {
                        btn.innerHTML = originalContent;
                    }
                }
            },

            openApiKeyModal() {
                uiManager.openGenericModal('Activer l\'IA (Gemini)', `
                    <div class="space-y-4">
                        <p class="text-sm text-slate-500 dark:text-slate-400">
                            Pour analyser vos photos, vous avez besoin d'une cl√© API Gemini (Google).<br>
                            C'est gratuit et s√©curis√© (stock√© sur votre appareil).
                        </p>
                        <ol class="list-decimal list-inside text-sm text-slate-600 dark:text-slate-300 space-y-2">
                            <li>Allez sur <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-brand-600 font-bold hover:underline">aistudio.google.com</a></li>
                            <li>Cliquez sur <b>Create API key</b></li>
                            <li>Copiez la cl√© (commence par "AIza")</li>
                        </ol>
                        <input id="input-api-key" type="text" placeholder="Collez votre cl√© API ici..." class="w-full p-3 border rounded-xl bg-slate-50 dark:bg-slate-900 dark:text-white font-mono text-sm">
                        <button onclick="editorManager.saveApiKey()" class="w-full bg-brand-600 text-white font-bold p-3 rounded-xl hover:bg-brand-700 transition-colors">
                            Enregistrer et Activer
                        </button>
                    </div>
                `);
            },

            saveApiKey() {
                const input = document.getElementById('input-api-key');
                let key = input.value.trim();
                // Basic cleanup
                key = key.replace(/^"|"$/g, '').replace(/^'|'$/g, '');

                if (!key.startsWith('AIza')) {
                    alert("‚ö†Ô∏è Cette cl√© ne semble pas valide.\nElle doit commencer par 'AIza'.");
                    return;
                }

                localStorage.setItem('gemini_api_key', key);
                uiManager.closeGenericModal();
                alert("‚úÖ Cl√© enregistr√©e ! Vous pouvez maintenant prendre une photo.");
            },

            fileToBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => {
                        // Remove data:image/xxx;base64, prefix
                        const base64String = reader.result.split(',')[1];
                        resolve(base64String);
                    };
                    reader.onerror = error => reject(error);
                });
            },

            async callGeminiAPI(key, imageBase64) {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`;

                const body = {
                    contents: [{
                        parts: [
                            { text: this.AI_PROMPT },
                            { inline_data: { mime_type: "image/jpeg", data: imageBase64 } }
                        ]
                    }]
                };

                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if (!response.ok) throw new Error(`API Error: ${response.statusText}`);

                const data = await response.json();

                // Extract Text
                const text = data.candidates[0].content.parts[0].text;

                // Clean Markdown if present (```json ... ```)
                const cleanText = text.replace(/```json/g, '').replace(/```/g, '').trim();

                return JSON.parse(cleanText);
            },
            init() {
                this.lines = [{ d: '', q: 1, p: 0, tva: 0.2 }];
                this.renderLines();
                document.getElementById('editor-date').valueAsDate = new Date();

                // Reset signature logic
                window.signatureManager.clear();
                document.getElementById('signature-preview-banner').classList.add('hidden');
                document.getElementById('signature-preview-img').src = '';
            },

            updateTotals() {
                let ht = 0, tvaTotal = 0;
                this.lines.forEach(l => {
                    ht += l.q * l.p;
                    tvaTotal += (l.q * l.p) * l.tva;
                });
                document.getElementById('editor-total-ht').innerText = ht.toFixed(2) + '‚Ç¨';
                document.getElementById('editor-total-tva').innerText = tvaTotal.toFixed(2) + '‚Ç¨';
                document.getElementById('editor-total-ttc').innerText = (ht + tvaTotal).toFixed(2) + '‚Ç¨';
            },

            renderLines() {
                const e = document.getElementById('editor-lines');
                e.innerHTML = '';
                this.lines.forEach((l, i) => {
                    // SMART MARGIN CHECK
                    let warning = '';
                    const lowerDesc = l.d.toLowerCase();
                    for (const [key, refPrice] of Object.entries(this.marketPrices)) {
                        if (lowerDesc.includes(key) && l.p > 0 && l.p < refPrice * 0.8) {
                            warning = `<div class="absolute -top-2 -right-2 bg-amber-500 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs shadow-lg animate-bounce cursor-pointer z-10" onclick="alert('‚ö†Ô∏è Marge Faible d√©tect√©e !\\n\\nPrix march√© : ${refPrice}‚Ç¨\\nVotre prix : ${l.p}‚Ç¨\\n\\nConseil : Augmentez votre prix pour garantir votre rentabilit√©.')"><i class="fa-solid fa-triangle-exclamation"></i></div>`;
                            break;
                        }
                    }

                    e.innerHTML += `<div class="glass p-3 rounded-xl flex gap-2 items-center flex-wrap mb-2 relative">
                        ${warning}
                        <button onclick="editorManager.removeLine(${i})" class="text-red-500 px-2"><i class="fa-solid fa-times"></i></button>
                        <div class="flex-1 flex items-center gap-2 min-w-[150px] bg-slate-50 dark:bg-slate-800/50 rounded-lg px-2 border border-transparent focus-within:border-brand-500 transition-colors">
                            <input class="flex-1 bg-transparent outline-none dark:text-white text-slate-900 placeholder-slate-400 font-medium py-2" value="${DataService.escapeHtml(l.d)}" oninput="editorManager.up(${i},'d',this.value)" placeholder="Prestation">
                            <button onclick="editorManager.startDictation(${i})" class="text-slate-400 hover:text-brand-600 transition-colors p-2"><i class="fa-solid fa-microphone"></i></button>
                        </div>
                        <input class="w-14 text-center bg-slate-100 dark:bg-slate-800 rounded p-1 dark:text-white text-slate-900 font-bold" type="number" value="${l.q}" oninput="editorManager.up(${i},'q',this.value)">
                        <input class="w-20 text-right bg-slate-100 dark:bg-slate-800 rounded p-1 dark:text-white text-slate-900 font-bold" type="number" value="${l.p}" oninput="editorManager.up(${i},'p',this.value)">
                        <select class="w-16 bg-slate-100 dark:bg-slate-800 rounded p-1 text-xs dark:text-white" onchange="editorManager.up(${i},'tva',this.value)"><option value="0.2" ${l.tva == 0.2 ? 'selected' : ''}>20%</option><option value="0.1" ${l.tva == 0.1 ? 'selected' : ''}>10%</option><option value="0.055" ${l.tva == 0.055 ? 'selected' : ''}>5.5%</option></select>
                    </div>`;
                });
                this.updateTotals();
            },

            // SMART DICTATION (GLOBAL)
            recognition: null,
            isRecording: false,
            originalBtnContent: null, // Added to store original button content

            startSmartDictation() {
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) return alert("Navigateur non compatible");

                // STOP IF RECORDING
                if (this.isRecording && this.recognition) {
                    this.recognition.stop();
                    this.isRecording = false; // Set to false immediately
                    return;
                }

                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                this.recognition = new SpeechRecognition();
                this.recognition.lang = 'fr-FR';
                this.recognition.interimResults = false;

                const btn = document.getElementById('btn-smart-mic');
                // Store original content only if not already recording (to avoid overwriting with "Appuyez pour arr√™ter")
                if (!this.originalBtnContent) this.originalBtnContent = btn.innerHTML;

                btn.classList.remove('from-brand-600', 'to-brand-500');
                btn.classList.add('animate-pulse', 'bg-red-500');
                btn.innerHTML = '<i class="fa-solid fa-microphone-lines text-4xl animate-bounce"></i><span class="font-bold mt-2">Appuyez pour arr√™ter</span>';

                this.isRecording = true;
                this.recognition.start();

                this.recognition.onresult = (e) => {
                    const text = e.results[0][0].transcript;
                    this.analyzeAndAdd(text);
                };

                this.recognition.onend = () => {
                    this.isRecording = false;
                    btn.classList.remove('animate-pulse', 'bg-red-500');
                    btn.classList.add('from-brand-600', 'to-brand-500');
                    btn.innerHTML = this.originalBtnContent;
                };

                this.recognition.onerror = (e) => {
                    console.error(e);
                    btn.innerHTML = originalContent;
                    alert("Erreur: " + e.error);
                };
            },

            analyzeAndAdd(text) {
                console.log("Analyzing:", text);
                const keywords = [
                    { k: 'prise', l: 'Pose Prise de Courant', p: 25 },
                    { k: 'interrupteur', l: 'Pose Interrupteur', p: 20 },
                    { k: 'tableau', l: 'Remplacement Tableau √âlectrique', p: 150 },
                    { k: 'peinture', l: 'Forfait Peinture (m¬≤)', p: 35 },
                    { k: 'robinet', l: 'Remplacement Robinet', p: 80 },
                    { k: 'wc', l: 'Pose WC Suspendu', p: 250 },
                    { k: 'lavabo', l: 'Pose Lavabo', p: 120 },
                    { k: 'douche', l: 'Installation Douche', p: 450 },
                    { k: 'placo', l: 'Pose Placo (m¬≤)', p: 45 },
                    { k: 'carrelage', l: 'Pose Carrelage (m¬≤)', p: 55 }
                ];

                let found = false;
                const lowerText = text.toLowerCase();

                keywords.forEach(item => {
                    // Check for singular or plural (simple check)
                    if (lowerText.includes(item.k)) {
                        // Try to find quantity: "3 prises"
                        // Regex: look for number before the keyword
                        const regex = new RegExp(`(\\d+)\\s*\\w*\\s*${item.k}`, 'i');
                        const match = lowerText.match(regex);
                        const qty = match ? parseInt(match[1]) : 1;

                        // Check if we already have an empty line at the start (default) and remove it if it's the only one
                        if (this.lines.length === 1 && this.lines[0].d === '' && this.lines[0].p === 0) {
                            this.lines = [];
                        }

                        this.lines.push({ d: item.l, q: qty, p: item.p, tva: 0.2 });
                        found = true;
                    }
                });

                if (!found) {
                    // No keyword? Add raw text
                    if (this.lines.length === 1 && this.lines[0].d === '' && this.lines[0].p === 0) {
                        this.lines = [];
                    }
                    this.lines.push({ d: text.charAt(0).toUpperCase() + text.slice(1), q: 1, p: 0, tva: 0.2 });
                }

                this.renderLines();
                DataService.incrementCounter('quotes');
                alert(`üó£Ô∏è Analyse termin√©e !\n\nJ'ai compris : "${text}"`);
            },

            // VOICE DICTATION
            startDictation(i) {
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    alert("Votre navigateur ne supporte pas la dict√©e vocale. Essayez Chrome ou Safari.");
                    return;
                }

                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                const recognition = new SpeechRecognition();
                recognition.lang = 'fr-FR';
                recognition.interimResults = false;
                recognition.maxAlternatives = 1;

                const btn = document.querySelector(`button[onclick="editorManager.startDictation(${i})"]`);
                const icon = btn.querySelector('i');

                // Visual feedback
                icon.className = "fa-solid fa-microphone-lines text-red-500 animate-pulse";

                recognition.start();

                recognition.onresult = (event) => {
                    const text = event.results[0][0].transcript;
                    console.log('Dict√©e:', text);

                    // SIMPLE PARSING LOGIC
                    // Ex: "Peinture salon 500 euros" -> Desc: "Peinture salon", Price: 500
                    let desc = text;
                    let price = 0;

                    // Try to find price at the end
                    const priceMatch = text.match(/(\d+)\s?(euros?|‚Ç¨)/i);
                    if (priceMatch) {
                        price = parseFloat(priceMatch[1]);
                        desc = text.replace(priceMatch[0], '').trim();
                    }

                    // Update Line
                    const currentDesc = this.lines[i].d;
                    this.lines[i].d = currentDesc ? currentDesc + ' ' + desc : desc;
                    if (price > 0) this.lines[i].p = price;

                    this.renderLines();
                };

                recognition.onend = () => {
                    // Reset icon
                    // Since renderLines is called in onresult, the button is re-rendered, so we don't strictly need to reset class here if successful.
                    // But if no result (silence), we should reset.
                    if (icon) icon.className = "fa-solid fa-microphone";
                };

                recognition.onerror = (event) => {
                    console.error('Speech error', event.error);
                    alert("Erreur micro : " + event.error);
                    if (icon) icon.className = "fa-solid fa-microphone";
                };
            },
            up(i, k, v) { this.lines[i][k] = k === 'd' ? v : parseFloat(v) || 0; this.updateTotals(); },
            addLine() { this.lines.push({ d: '', q: 1, p: 0, tva: 0.2 }); this.renderLines(); },
            removeLine(i) { if (this.lines.length > 1) { this.lines.splice(i, 1); this.renderLines(); } },
            async saveDocument() {
                const clientName = document.getElementById('editor-client-preview').innerText;
                if (clientName === "S√©lectionner...") return alert('Veuillez s√©lectionner un client');

                const b = document.querySelector('button[onclick="editorManager.saveDocument()"]');
                const t = b.innerHTML; b.innerHTML = '...'; b.disabled = true;

                let ht = 0, tva = 0;
                this.lines.forEach(l => { ht += l.q * l.p; tva += (l.q * l.p) * l.tva; });

                // Get Signature
                const sigData = window.signatureManager.currentSignatureData;

                await DataService.add('docs', {
                    type: 'devis', date: new Date().toISOString(),
                    clientName: clientName, lines: this.lines,
                    ht, ttc: ht + tva, status: sigData ? 'signed' : 'draft',
                    signature: sigData
                });

                // TRACK SAVINGS
                DataService.incrementCounter('quotes');

                b.innerHTML = t; b.disabled = false;
                alert('Sauvegard√© !'); router.navigate('home');
            },
            openLibraryModal() { window.uiManager.openGenericModal('Biblioth√®que', '<div id="modal-lib-list">...</div>'); window.itemManager.render(true); },
            importItem(t, p) { this.lines.push({ d: t, q: 1, p, tva: 0.2 }); this.renderLines(); window.uiManager.closeGenericModal(); },

            // PRINT LOGIC (UPDATED WITH LEGAL, VAT & SIGNATURE)
            async print() {
                try {
                    const client = document.getElementById('editor-client-preview').innerText;
                    if (client === "S√©lectionner...") return alert("Choisissez un client");

                    // Get Settings for Logo & Legal
                    const s = await DataService.get('settings');
                    const conf = s[0] || {};

                    document.getElementById('print-client-name').innerText = client;
                    document.getElementById('print-date').innerText = new Date().toLocaleDateString();
                    document.getElementById('print-ref').innerText = 'D-' + Date.now().toString().substr(-4);

                    // Legal Info Header
                    let legal = `${conf.company || 'Mon Entreprise'}\nSIRET: ${conf.siret || 'Non renseign√©'}\n${conf.address || ''}\nTVA Intra: ${conf.tvaintra || 'Non renseign√©'}`;
                    document.getElementById('print-company-info').innerText = legal;

                    // Legal Footer
                    document.getElementById('print-legal-footer').innerText = `Assurance D√©cennale: ${conf.decennale || 'Non renseign√©e'} - Mention RGE: ${conf.rge || 'Non applicable'}`;

                    // LOGO
                    const logoImg = document.getElementById('print-logo');
                    if (conf.logo) {
                        logoImg.src = conf.logo;
                        logoImg.classList.remove('hidden');
                    } else {
                        logoImg.classList.add('hidden');
                    }

                    // SIGNATURE IN PRINT
                    const sigData = window.signatureManager.currentSignatureData;
                    const sigImgPrint = document.getElementById('print-signature-img');
                    const sigDatePrint = document.getElementById('print-signature-date');

                    if (sigData) {
                        sigImgPrint.src = sigData;
                        sigImgPrint.classList.remove('hidden');
                        sigDatePrint.innerText = "Sign√© num√©riquement le " + new Date().toLocaleDateString();
                        sigDatePrint.classList.remove('hidden');
                    } else {
                        sigImgPrint.classList.add('hidden');
                        sigDatePrint.classList.add('hidden');
                    }

                    // Lines
                    const tbody = document.getElementById('print-lines');
                    tbody.innerHTML = '';
                    this.lines.forEach(l => {
                        const tvaPct = (l.tva * 100).toFixed(1) + '%';
                        tbody.innerHTML += `<tr class="border-b border-slate-100"><td class="py-3 px-4">${l.d}</td><td class="text-center">${l.q}</td><td class="text-center text-xs text-slate-500">${tvaPct}</td><td class="text-right">${l.p}‚Ç¨</td><td class="text-right font-bold">${(l.q * l.p).toFixed(2)}‚Ç¨</td></tr>`;
                    });

                    document.getElementById('print-ht').innerText = document.getElementById('editor-total-ht').innerText;
                    document.getElementById('print-tva').innerText = document.getElementById('editor-total-tva').innerText;
                    document.getElementById('print-ttc').innerText = document.getElementById('editor-total-ttc').innerText;

                    window.print();
                } catch (e) {
                    console.error("Print Error:", e);
                    alert("Erreur lors de l'impression: " + e.message);
                }
            }
        };

        const clientManager = {
            async render() {
                const e = document.getElementById('clients-list-body');
                const c = await DataService.get('clients');
                e.innerHTML = '';
                if (c.length === 0) e.innerHTML = '<p class="text-slate-400 p-4">Vide</p>';
                c.forEach(x => e.innerHTML += `<div class="glass p-4 rounded-xl shadow border border-slate-200/50 flex justify-between"><span class="font-bold dark:text-white text-slate-900">${DataService.escapeHtml(x.name)}</span><button onclick="clientManager.del('${x.id}')" class="text-red-500"><i class="fa-solid fa-trash"></i></button></div>`);
            },
            openAddModal() {
                const isEditor = document.getElementById('view-devis').classList.contains('active');
                if (isEditor) this.renderSel();
                else this.openNewForm(false);
            },
            async renderSel() {
                const c = await DataService.get('clients');
                let h = '<div class="space-y-2 mb-4 max-h-60 overflow-auto custom-scrollbar">';
                // SECURITY FIX: Use data attributes
                c.forEach(x => h += `<div onclick="clientManager.sel('${x.id}', this.getAttribute('data-name'))" data-name="${DataService.escapeHtml(x.name)}" class="p-3 bg-slate-100 dark:bg-slate-800 rounded-lg cursor-pointer font-bold text-slate-900 dark:text-white hover:bg-brand-100">${DataService.escapeHtml(x.name)}</div>`);
                h += '</div><button onclick="uiManager.closeGenericModal();clientManager.openNewForm(true)" class="text-brand-600 text-sm font-bold">Nouveau Client</button>';
                uiManager.openGenericModal('Choisir', h);
            },
            openNewForm(isEditor = false) {
                uiManager.openGenericModal('Nouveau Client', `<input id="new-c-name" class="w-full p-3 border rounded-xl mb-3 bg-slate-100 dark:bg-slate-800 text-slate-900 dark:text-white" placeholder="Nom"><button onclick="clientManager.save(${isEditor})" class="w-full bg-brand-600 text-white p-4 rounded-xl font-bold text-lg shadow-lg">Ajouter</button>`);
            },
            async save(s = false) {
                console.log("save called", s);
                try {
                    const n = document.getElementById('new-c-name').value;
                    if (!n) return alert("Le nom est obligatoire");

                    console.log("Calling DataService.add...");
                    const r = await DataService.add('clients', { name: n });
                    console.log("DataService returned:", r);

                    if (!r) throw new Error("Erreur interne: Aucune donn√©e retourn√©e");

                    if (s) {
                        this.sel(r.id, r.name);
                    } else {
                        uiManager.closeGenericModal();
                        this.render();
                    }
                } catch (e) {
                    console.error("Save Error:", e);
                    alert("Erreur lors de l'enregistrement: " + e.message);
                }
            }, sel(i, n) { document.getElementById('editor-client-preview').innerText = n; document.getElementById('editor-client-preview').classList.add('text-slate-900', 'dark:text-white'); document.getElementById('editor-client-id').value = i; uiManager.closeGenericModal(); }, async del(i) { if (confirm('Supprimer ?')) { await DataService.delete('clients', i); this.render(); } }
        };
        const itemManager = {
            async render(m = false) {
                const i = await DataService.get('items');
                const e = m ? document.getElementById('modal-lib-list') : document.getElementById('items-list-body');
                e.innerHTML = '';
                i.forEach(x => {
                    // SECURITY FIX: Use data attributes
                    const a = m ? `onclick="editorManager.importItem(this.getAttribute('data-title'), ${x.price})" data-title="${DataService.escapeHtml(x.title)}"` : '';
                    e.innerHTML += `<div ${a} class="glass p-4 rounded-xl mb-2 flex justify-between cursor-pointer border border-slate-200/50 dark:border-slate-700"><span class="dark:text-white text-slate-900 font-bold">${DataService.escapeHtml(x.title)}</span><span class="font-black text-brand-600">${x.price}‚Ç¨</span></div>`;
                });
            },
            openAddModal() {
                uiManager.openGenericModal('Nouvelle Prestation', `<input id="new-i-t" class="w-full p-3 border rounded-xl mb-3 bg-slate-100 dark:bg-slate-800 text-slate-900 dark:text-white" placeholder="Titre"><input id="new-i-p" class="w-full p-3 border rounded-xl mb-3 bg-slate-100 dark:bg-slate-800 text-slate-900 dark:text-white" placeholder="Prix"><button onclick="itemManager.save()" class="w-full bg-brand-600 text-white p-4 rounded-xl font-bold text-lg shadow-lg">Ajouter</button>`);
            },
            async save() {
                await DataService.add('items', {
                    title: document.getElementById('new-i-t').value,
                    price: parseFloat(document.getElementById('new-i-p').value)
                });
                uiManager.closeGenericModal();
                this.render();
            }
        };
        const calendarManager = {
            currentDate: new Date(),
            changeMonth(delta) { this.currentDate.setMonth(this.currentDate.getMonth() + delta); this.render(); },
            async render() {
                const year = this.currentDate.getFullYear();
                const month = this.currentDate.getMonth();
                const monthNames = ["Janvier", "F√©vrier", "Mars", "Avril", "Mai", "Juin", "Juillet", "Ao√ªt", "Septembre", "Octobre", "Novembre", "D√©cembre"];
                const disp = document.getElementById('calendar-month-display');
                if (disp) disp.innerText = `${monthNames[month]} ${year}`;
                const grid = document.getElementById('calendar-grid');
                if (!grid) return;
                grid.innerHTML = '';
                const appts = await DataService.get('appointments');
                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const offset = firstDay === 0 ? 6 : firstDay - 1;
                for (let i = 0; i < offset; i++) grid.innerHTML += `<div class="calendar-day bg-slate-50 dark:bg-slate-800/50 opacity-50"></div>`;
                const today = new Date();
                for (let d = 1; d <= daysInMonth; d++) {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                    const isToday = (d === today.getDate() && month === today.getMonth() && year === today.getFullYear());
                    const dayAppts = appts.filter(a => a.date === dateStr);
                    let dots = '';
                    dayAppts.forEach(a => {
                        let c = 'bg-brand-500';
                        if (a.type == 'chantier') c = 'bg-green-500';
                        if (a.type == 'urgence') c = 'bg-red-500';
                        dots += `<div class="w-2 h-2 rounded-full ${c} mb-0.5"></div>`;
                    });
                    grid.innerHTML += `<div onclick="calendarManager.openDayModal('${dateStr}')" class="calendar-day group relative hover:bg-brand-50 dark:hover:bg-slate-800 transition-colors"><span class="text-xs font-bold text-slate-500 dark:text-slate-400">${d}</span><div class="mt-1 flex flex-wrap gap-0.5 content-start">${dots}</div></div>`;
                }
            },
            async openDayModal(dateStr) {
                const appts = await DataService.get('appointments');
                const clients = await DataService.get('clients');
                const dayAppts = appts.filter(a => a.date === dateStr);
                const niceDate = new Date(dateStr).toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' });
                let ops = `<option value="">-- Client --</option>`;
                clients.forEach(c => ops += `<option value="${c.name}">${c.name}</option>`);
                let list = '';
                dayAppts.forEach(a => {
                    // Google Calendar Link Generation
                    const startDate = dateStr.replace(/-/g, '');
                    const endDate = new Date(new Date(dateStr).getTime() + 86400000).toISOString().split('T')[0].replace(/-/g, ''); // Next day for all-day event
                    const gCalUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(a.title)}&dates=${startDate}/${endDate}&details=${encodeURIComponent('Type: ' + a.type)}`;

                    list += `<li class="flex justify-between items-center glass p-3 mb-2 rounded-xl border border-slate-200 dark:border-slate-700">
                        <div class="flex-1">
                            <div class="font-bold text-sm text-slate-900 dark:text-white">${DataService.escapeHtml(a.title)}</div>
                            <div class="text-xs text-slate-500">${a.type}</div>
                        </div>
                        <div class="flex gap-2">
                            <a href="${gCalUrl}" target="_blank" class="w-8 h-8 flex items-center justify-center rounded-lg bg-blue-50 text-blue-600 hover:bg-blue-100" title="Ajouter √† Google Agenda">
                                <i class="fa-brands fa-google"></i>
                            </a>
                            <button onclick="calendarManager.del('${a.id}','${dateStr}')" class="w-8 h-8 flex items-center justify-center rounded-lg bg-red-50 text-red-400 hover:bg-red-100">
                                <i class="fa-solid fa-times"></i>
                            </button>
                        </div>
                    </li>`;
                });
                if (!list) list = '<p class="text-slate-400 italic text-sm mb-4">Rien de pr√©vu</p>';
                const form = `<div class="border-t border-slate-200 dark:border-slate-700 pt-4 mt-4"><label class="text-[10px] uppercase font-bold text-slate-500 mb-2 block">Ajouter</label><select id="cal-client" class="w-full p-3 bg-slate-100 dark:bg-slate-800 rounded-xl mb-2 outline-none text-slate-900 dark:text-white" onchange="document.getElementById('cal-title').value = this.value">${ops}</select><input id="cal-title" class="w-full p-3 bg-slate-100 dark:bg-slate-800 rounded-xl mb-2 outline-none text-slate-900 dark:text-white" placeholder="Ou titre libre..."><div class="flex gap-2"><select id="cal-type" class="p-3 bg-slate-100 dark:bg-slate-800 rounded-xl outline-none text-slate-900 dark:text-white flex-1"><option value="rdv">RDV</option><option value="chantier">Chantier</option><option value="urgence">Urgence</option></select><button onclick="calendarManager.save('${dateStr}')" class="bg-brand-600 text-white font-bold rounded-xl px-4">OK</button></div></div>`;
                window.uiManager.openGenericModal(niceDate, `<ul class="mb-2">${list}</ul>${form}`);
            },
            async save(dateStr) { const title = document.getElementById('cal-title').value; const type = document.getElementById('cal-type').value; if (!title) return; await DataService.add('appointments', { title, type, date: dateStr }); window.uiManager.closeGenericModal(); this.render(); },
            async del(id, dateStr) { if (confirm('Supprimer ?')) { await DataService.delete('appointments', id); this.openDayModal(dateStr); this.render(); } }
        };

        const siteManager = {
            async addNote() {
                const clients = await DataService.get('clients');
                let ops = ''; clients.forEach(c => ops += `<option value="${c.name}">${c.name}</option>`);
                window.uiManager.openGenericModal('Note de Chantier', `
                    <div class="space-y-4">
                        <select id="site-client" class="w-full p-4 bg-slate-100 dark:bg-slate-800 text-slate-900 dark:text-white rounded-xl outline-none">${ops}</select>
                        <textarea id="site-note" rows="3" class="w-full p-4 bg-slate-100 dark:bg-slate-800 text-slate-900 dark:text-white rounded-xl outline-none" placeholder="Avancement..."></textarea>
                        <button onclick="siteManager.save()" class="w-full bg-brand-600 text-white font-bold p-4 rounded-xl">Publier</button>
                    </div>
                `);
            },
            async save() {
                const client = document.getElementById('site-client').value;
                const note = document.getElementById('site-note').value;
                if (!client) return;
                // Just visual for demo
                const feed = document.getElementById('sites-feed');
                feed.innerHTML = `<div class="glass p-6 rounded-2xl border border-slate-200 dark:border-slate-700 mb-4 animate-fade-in"><div class="flex items-center gap-3 mb-2"><div class="w-8 h-8 rounded-full bg-brand-100 flex items-center justify-center text-brand-600 font-bold">${DataService.escapeHtml(client).charAt(0)}</div><div class="font-bold dark:text-white">${DataService.escapeHtml(client)}</div></div><p class="text-slate-600 dark:text-slate-300">${DataService.escapeHtml(note)}</p></div>` + feed.innerHTML;
                window.uiManager.closeGenericModal();
            }
        };

        const settingsManager = {
            async load() {
                const s = await DataService.get('settings');
                if (s.length > 0) {
                    const c = s[0];
                    if (document.getElementById('set-company')) document.getElementById('set-company').value = c.company || '';
                    if (document.getElementById('set-siret')) document.getElementById('set-siret').value = c.siret || '';
                    if (document.getElementById('set-address')) document.getElementById('set-address').value = c.address || '';
                    if (document.getElementById('set-decennale')) document.getElementById('set-decennale').value = c.decennale || '';
                    if (document.getElementById('set-rge')) document.getElementById('set-rge').value = c.rge || '';
                    if (document.getElementById('set-tva-intra')) document.getElementById('set-tva-intra').value = c.tvaintra || '';
                    if (c.logo) document.getElementById('preview-logo').innerHTML = `<img src="${c.logo}" class="w-full h-full object-contain">`;
                }
                if (auth && auth.currentUser) {
                    document.getElementById('settings-email').innerText = auth.currentUser.email;
                    document.getElementById('set-username').value = auth.currentUser.displayName || '';
                    if (auth.currentUser.photoURL) document.getElementById('settings-photo').src = auth.currentUser.photoURL;
                }

                // Add Reset API Key Button if not exists
                const container = document.getElementById('view-settings');
                if (container && !document.getElementById('btn-reset-key')) {
                    const div = document.createElement('div');
                    div.className = "mt-8 pt-8 border-t border-slate-200 dark:border-slate-700";
                    div.innerHTML = `
                        <h3 class="font-bold mb-4 dark:text-white">Intelligence Artificielle</h3>
                        <h3 class="font-bold mb-4 dark:text-white">Intelligence Artificielle</h3>
                        <button id="btn-reset-key" onclick="editorManager.openApiKeyModal()" 
                            class="bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-200 px-4 py-2 rounded-xl font-bold hover:bg-slate-300 transition-colors">
                            <i class="fa-solid fa-key mr-2"></i> Changer la cl√© API Gemini
                        </button>
                    `;
                    // Append to the white card container
                    const card = container.querySelector('.glass.p-6');
                    if (card) card.appendChild(div);
                }
            },
            handleLogo(input) {
                const file = input.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onloadend = () => {
                    document.getElementById('preview-logo').innerHTML = `<img src="${reader.result}" class="w-full h-full object-contain">`;
                    document.getElementById('set-logo').dataset.b64 = reader.result;
                };
                reader.readAsDataURL(file);
            },
            async save(e) {
                e.preventDefault();
                const logoB64 = document.getElementById('set-logo').dataset.b64 || null;
                const current = await DataService.get('settings');
                const oldLogo = (current.length > 0) ? current[0].logo : null;

                await DataService.saveSettings({
                    company: document.getElementById('set-company').value,
                    siret: document.getElementById('set-siret').value,
                    address: document.getElementById('set-address').value,
                    decennale: document.getElementById('set-decennale').value,
                    rge: document.getElementById('set-rge').value,
                    tvaintra: document.getElementById('set-tva-intra').value,
                    logo: logoB64 || oldLogo
                });
                alert('OK');
            },
            async updateProfile() {
                const newName = document.getElementById('set-username').value;
                if (auth.currentUser) {
                    try { await updateProfile(auth.currentUser, { displayName: newName }); document.getElementById('user-name').innerText = newName; alert("Profil mis √† jour !"); } catch (e) { console.error(e); alert("Erreur"); }
                }
            }
        };

        const aiManager = {
            openModal: () => {
                if (!DataService.checkPremium()) return; // PREMIUM CHECK
                document.getElementById('modal-ai').classList.remove('hidden');
            },
            closeModal: () => document.getElementById('modal-ai').classList.add('hidden'),
            async generate() {
                const b = document.getElementById('ai-btn-generate'); b.innerHTML = '...';
                await new Promise(r => setTimeout(r, 1000));
                window.editorManager.lines = [{ d: "Peinture compl√®te", q: 1, p: 450, tva: 0.1 }, { d: "Pose sol", q: 20, p: 40, tva: 0.2 }];
                window.editorManager.renderLines();
                this.closeModal();
                b.innerHTML = 'G√©n√©rer';
            }
        };
        const uiManager = {
            openGenericModal(t, c) { const m = document.getElementById('modal-generic'); m.innerHTML = `<div class="fixed inset-0 bg-black/60 backdrop-blur-sm" onclick="uiManager.closeGenericModal()"></div><div class="glass w-full max-w-md p-6 rounded-2xl z-10 animate-slide-up shadow-2xl"><h3 class="font-bold mb-4 dark:text-white text-xl">${t}</h3><div>${c}</div></div>`; m.classList.remove('hidden'); },
            closeGenericModal() { document.getElementById('modal-generic').classList.add('hidden'); },
            openLegalModal(type) {
                let title = "", content = "";
                if (type === 'mentions') {
                    title = "Mentions L√©gales";
                    content = `<p class="text-sm text-slate-600 dark:text-slate-300 mb-2"><strong>√âditeur :</strong> Benjamin Meriot<br><strong>Adresse :</strong> 33230<br><strong>Contact :</strong> sportygamernerd@gmail.com</p><p class="text-sm text-slate-600 dark:text-slate-300">H√©berg√© par Vercel Inc.</p>`;
                } else {
                    title = "CGU & Confidentialit√©";
                    content = `<p class="text-sm text-slate-600 dark:text-slate-300 mb-2"><strong>Donn√©es :</strong> Les donn√©es collect√©es (clients, devis) sont stock√©es de mani√®re s√©curis√©e sur Google Firebase. Elles ne sont ni vendues ni partag√©es.</p><p class="text-sm text-slate-600 dark:text-slate-300"><strong>Responsabilit√© :</strong> GoChantier n'est pas responsable des erreurs dans vos devis.</p>`;
                }
                this.openGenericModal(title, content);
            }
        };
        const themeManager = { toggle: () => { document.documentElement.classList.toggle('dark'); } };
        // INIT
        if (!auth) {
            console.warn("Firebase Auth non disponible. Mode hors ligne/d√©mo uniquement.");
            // Force login view to be active if not already
            document.getElementById('view-login').classList.add('active');
            document.getElementById('view-login').classList.remove('hidden');
        }

        // Globals
        window.clientManager = clientManager; window.itemManager = itemManager;
        window.calendarManager = calendarManager; window.settingsManager = settingsManager;
        window.aiManager = aiManager; window.siteManager = siteManager;
        window.uiManager = uiManager; window.themeManager = themeManager;

        console.log("Modules attached to window");

        // --- AUTH STATE LISTENER (MOVED TO END) ---
        if (auth) {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // alert("Utilisateur connect√©: " + user.email); // Debug
                    console.log("Utilisateur connect√©:", user.uid);
                    DataService.userId = user.uid;

                    // Update UI
                    const userName = document.getElementById('user-name');
                    const userPhoto = document.getElementById('user-photo');
                    const dashName = document.getElementById('dash-name');
                    const settingsEmail = document.getElementById('settings-email');
                    const setUsername = document.getElementById('set-username');
                    const settingsPhoto = document.getElementById('settings-photo');

                    if (userName) userName.innerText = user.displayName || 'Utilisateur';
                    if (userPhoto && user.photoURL) userPhoto.src = user.photoURL;
                    if (dashName) dashName.innerText = (user.displayName || 'Chef').split(' ')[0];
                    if (settingsEmail) settingsEmail.innerText = user.email;
                    if (setUsername) setUsername.value = user.displayName;
                    if (settingsPhoto && user.photoURL) settingsPhoto.src = user.photoURL;

                    // Mock Subscription (Copy from Demo)
                    window.subscriptionManager = { checkLimit: async () => true, checkForSuccess: () => { } };

                    // Initialize Signature (Copy from Demo)
                    if (window.signatureManager) {
                        window.signatureManager.init();
                    }

                    // Switch View
                    const loginView = document.getElementById('view-login');
                    if (loginView) {
                        loginView.classList.remove('active');
                        loginView.classList.add('hidden');
                        loginView.style.display = 'none'; // Force hide
                    }
                    if (window.router) {
                        router.navigate('home');
                    }
                } else {
                    console.log("Utilisateur d√©connect√©");
                    DataService.userId = null;
                    document.getElementById('view-login').classList.add('active');
                    document.getElementById('view-login').classList.remove('hidden');
                }
            });
        }

        // PWA MANAGER
        const pwaManager = {
            deferredPrompt: null,
            init() {
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    this.deferredPrompt = e;
                    const btn = document.getElementById('btn-install-app');
                    if (btn) btn.classList.remove('hidden');
                });

                window.addEventListener('appinstalled', () => {
                    this.deferredPrompt = null;
                    const btn = document.getElementById('btn-install-app');
                    if (btn) btn.classList.add('hidden');
                    console.log('PWA was installed');
                });
            },
            async install() {
                if (this.deferredPrompt) {
                    this.deferredPrompt.prompt();
                    const { outcome } = await this.deferredPrompt.userChoice;
                    console.log(`User response to the install prompt: ${outcome}`);
                    this.deferredPrompt = null;
                    document.getElementById('btn-install-app').classList.add('hidden');
                } else {
                    // Fallback for iOS or if prompt not available
                    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
                    if (isIOS) {
                        alert("Pour installer l'application sur iOS :\n1. Appuyez sur le bouton 'Partager' (carr√© avec fl√®che)\n2. S√©lectionnez 'Sur l'√©cran d'accueil'");
                    } else {
                        alert("Pour installer, utilisez le menu de votre navigateur et choisissez 'Installer l'application' ou 'Ajouter √† l'√©cran d'accueil'.");
                    }
                }
            }
        };
        pwaManager.init();

        // PWA SERVICE WORKER REGISTRATION
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => {
                        console.log('SW registered', reg);
                        reg.onupdatefound = () => {
                            const installingWorker = reg.installing;
                            installingWorker.onstatechange = () => {
                                if (installingWorker.state === 'installed') {
                                    if (navigator.serviceWorker.controller) {
                                        // New update available
                                        console.log('New content is available; please refresh.');
                                        if (confirm("Une nouvelle version de GoChantier est disponible ! Cliquez sur OK pour mettre √† jour.")) {
                                            window.location.reload();
                                        }
                                    } else {
                                        console.log('Content is cached for offline use.');
                                    }
                                }
                            };
                        };
                    })
                    .catch(err => console.log('SW failed', err));

                // Force reload if controller changes
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    window.location.reload();
                });
            });
        }
    </script>
</body>

</html>