<!DOCTYPE html>
<html lang="fr" class="scroll-smooth">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ProGest Cloud - L'outil des Artisans</title>

    <!-- S√âCURIT√â CSP -->
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'self' https: data: blob:; script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://cdnjs.cloudflare.com https://www.gstatic.com https://apis.google.com https://*.firebaseapp.com https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://fonts.googleapis.com; font-src https://fonts.gstatic.com https://cdnjs.cloudflare.com;">

    <!-- MOTEUR GRAPHIQUE -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        // Professional Blue Palette (Inter Blue)
                        brand: { 50: '#eff6ff', 100: '#dbeafe', 200: '#bfdbfe', 300: '#93c5fd', 400: '#60a5fa', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8', 800: '#1e40af', 900: '#1e3a8a' },
                        accent: { orange: '#f97316', green: '#10b981', red: '#ef4444' }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } }
                    }
                }
            }
        }
    </script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
            background-color: #f8fafc;
        }

        .dark body {
            background-color: #0f172a;
        }

        .view-section {
            display: none !important;
        }

        .view-section.active {
            display: block !important;
            animation: fadeIn 0.3s ease-out forwards;
        }

        #view-devis.active,
        #view-login.active {
            display: flex !important;
        }

        /* SCROLLBAR CLEAN */
        .custom-scrollbar::-webkit-scrollbar {
            width: 5px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        .dark .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #475569;
        }

        /* CLEAN CARD DESIGN (No Glass) */
        .glass {
            background: white;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
        }

        .dark .glass {
            background: #1e293b;
            border: 1px solid #334155;
            box-shadow: none;
        }

        .card-hover {
            transition: all 0.2s ease;
        }

        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border-color: #cbd5e1;
        }

        .dark .card-hover:hover {
            border-color: #475569;
        }

        .btn-action {
            transition: all 0.1s;
        }

        .btn-action:active {
            transform: scale(0.98);
        }

        /* SIMPLIFIED TEXT */
        .gradient-text {
            color: #0f172a;
        }

        .dark .gradient-text {
            color: white;
        }

        .text-gradient {
            background: linear-gradient(to right, #2563eb, #4f46e5);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .gradient-fire {
            background: linear-gradient(135deg, #f97316 0%, #ef4444 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .promo-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ef4444;
            color: white;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 0.7rem;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #e2e8f0;
            border: 1px solid #e2e8f0;
        }

        .dark .calendar-grid {
            background: #334155;
            border: 1px solid #334155;
        }

        .calendar-day {
            background: white;
            min-height: 90px;
            padding: 6px;
            display: flex;
            flex-direction: column;
            cursor: pointer;
            transition: background 0.2s;
        }

        .dark .calendar-day {
            background: #1e293b;
        }

        .calendar-day:hover {
            background: #f1f5f9;
        }

        .dark .calendar-day:hover {
            background: #334155;
        }

        @media print {
            body {
                background: white !important;
                color: black !important;
            }

            .no-print,
            #sidebar,
            #mobile-nav,
            #view-login,
            .view-section,
            #signature-pad-container {
                display: none !important;
            }

            #print-area {
                display: block !important;
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: 9999;
            }

            .print-page {
                padding: 0;
                margin: 0;
                width: 100%;
            }
        }

        #print-area {
            display: none !important;
        }

        /* DRAWER MENU */
        #main-menu {
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #main-menu.open {
            transform: translateX(0);
        }

        #menu-overlay.open {
            display: block;
            opacity: 1;
        }
    </style>
</head>

<body
    class="bg-slate-50 text-slate-800 antialiased dark:bg-[#0f172a] dark:text-slate-200 h-screen overflow-hidden flex transition-colors duration-300">

    <!-- HAMBURGER BUTTON (Mobile & Desktop) -->
    <button onclick="menuManager.open()"
        class="fixed top-4 right-4 z-50 w-12 h-12 bg-white dark:bg-slate-800 rounded-full shadow-xl flex items-center justify-center text-slate-900 dark:text-white border border-slate-200 dark:border-slate-700 hover:scale-110 transition-transform">
        <i class="fa-solid fa-bars text-xl"></i>
    </button>

    <!-- RIGHT DRAWER MENU -->
    <div id="menu-overlay" onclick="menuManager.close()"
        class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[60] hidden transition-opacity opacity-0"></div>
    <div id="main-menu"
        class="fixed inset-y-0 right-0 w-80 bg-white dark:bg-slate-900 shadow-2xl z-[70] flex flex-col border-l border-slate-200 dark:border-slate-800">
        <div class="p-6 flex justify-between items-center border-b border-slate-100 dark:border-slate-800">
            <span class="font-black text-xl dark:text-white">Menu</span>
            <button onclick="menuManager.close()"
                class="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center text-slate-500 hover:text-red-500 transition-colors">
                <i class="fa-solid fa-times"></i>
            </button>
        </div>
        <nav class="flex-1 overflow-y-auto p-4 space-y-2">
            <a onclick="router.navigate('home')"
                class="flex items-center gap-4 p-4 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-800 text-slate-600 dark:text-slate-400 font-bold cursor-pointer">
                <i class="fa-solid fa-home w-6 text-center"></i> Tableau de bord
            </a>
            <a onclick="router.navigate('devis')"
                class="flex items-center gap-4 p-4 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-800 text-slate-600 dark:text-slate-400 font-bold cursor-pointer">
                <i class="fa-solid fa-pen-nib w-6 text-center"></i> Devis
            </a>
            <a onclick="router.navigate('calendar')"
                class="flex items-center gap-4 p-4 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-800 text-slate-600 dark:text-slate-400 font-bold cursor-pointer">
                <i class="fa-solid fa-calendar w-6 text-center"></i> Agenda
            </a>
            <div class="border-t border-slate-100 dark:border-slate-800 my-2"></div>
            <a onclick="router.navigate('clients')"
                class="flex items-center gap-4 p-4 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-800 text-slate-600 dark:text-slate-400 font-bold cursor-pointer">
                <i class="fa-solid fa-users w-6 text-center"></i> Clients
            </a>
            <a onclick="router.navigate('items')"
                class="flex items-center gap-4 p-4 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-800 text-slate-600 dark:text-slate-400 font-bold cursor-pointer">
                <i class="fa-solid fa-box w-6 text-center"></i> Articles
            </a>
            <a onclick="router.navigate('expenses')"
                class="flex items-center gap-4 p-4 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-800 text-slate-600 dark:text-slate-400 font-bold cursor-pointer">
                <i class="fa-solid fa-receipt w-6 text-center"></i> D√©penses
            </a>
            <a onclick="router.navigate('deals')"
                class="flex items-center gap-4 p-4 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-800 text-slate-600 dark:text-slate-400 font-bold cursor-pointer">
                <i class="fa-solid fa-tags w-6 text-center"></i> Bons Plans
            </a>
            <div class="border-t border-slate-100 dark:border-slate-800 my-2"></div>
            <a onclick="router.navigate('settings')"
                class="flex items-center gap-4 p-4 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-800 text-slate-600 dark:text-slate-400 font-bold cursor-pointer">
                <i class="fa-solid fa-cog w-6 text-center"></i> Param√®tres
            </a>
        </nav>
        <div class="p-6 border-t border-slate-100 dark:border-slate-800">
            <button onclick="themeManager.toggle()"
                class="w-full py-4 rounded-xl border border-slate-200 dark:border-slate-700 font-bold text-slate-600 dark:text-slate-400 flex items-center justify-center gap-2">
                <i class="fa-solid fa-moon dark:hidden"></i><i class="fa-solid fa-sun hidden dark:inline"></i> Mode
                Sombre
            </button>
        </div>
    </div>

    <!-- 0. LOGIN SCREEN -->
    <section id="view-login"
        class="fixed inset-0 z-[100] bg-slate-50 dark:bg-[#0f172a] flex flex-col items-center justify-center p-6 view-section active">
        <div class="relative z-10 w-full max-w-md flex flex-col items-center text-center animate-fade-in">
            <div
                class="w-24 h-24 bg-gradient-to-br from-brand-500 to-brand-700 rounded-3xl flex items-center justify-center text-white text-5xl mb-8 shadow-2xl shadow-brand-500/40">
                <i class="fa-solid fa-cloud"></i>
            </div>
            <h1 class="text-4xl font-black mb-2 text-slate-900 dark:text-white tracking-tight">ProGest Cloud</h1>
            <p class="text-slate-500 dark:text-slate-400 mb-10 text-lg">L'outil de gestion ultime pour les artisans.</p>

            <!-- BOUTON GOOGLE -->
            <button onclick="authManager.login()"
                class="btn-action w-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-700 dark:text-white font-bold py-4 px-6 rounded-2xl shadow-xl flex items-center justify-center gap-4 hover:shadow-2xl mb-4">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6 h-6">
                <span class="text-lg">Connexion Google</span>
            </button>

            <!-- BOUTON DEMO (NOUVEAU) -->
            <button onclick="authManager.loginDemo()"
                class="btn-action w-full bg-brand-600/10 border border-brand-500/30 text-brand-600 dark:text-brand-400 font-bold py-3 px-6 rounded-2xl flex items-center justify-center gap-2 hover:bg-brand-600/20">
                <i class="fa-solid fa-gamepad"></i>
                <span>Acc√®s D√©mo (Sans Compte)</span>
            </button>

            <div id="login-error" class="text-red-500 text-xs mt-4 hidden bg-red-100 p-2 rounded-lg"></div>
            <p class="text-[10px] text-slate-400 mt-8 uppercase tracking-widest">S√©curis√© par Firebase Google</p>
        </div>
    </section>

    <!-- SIDEBAR (Desktop) -->
    <aside id="sidebar"
        class="w-64 bg-white dark:bg-[#0f172a] border-r border-slate-200 dark:border-slate-800 flex flex-col transition-all duration-300 z-20 hidden md:flex">
        <div class="p-6 flex items-center gap-3">
            <div class="w-8 h-8 bg-brand-600 rounded-lg flex items-center justify-center text-white font-black text-lg">
                P</div>
            <span class="font-black text-xl tracking-tight dark:text-white">ProGest<span
                    class="text-brand-600">.</span></span>
        </div>
        <nav class="flex-1 px-4 space-y-1">
            <a onclick="router.navigate('home')" id="nav-home"
                class="nav-item flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors cursor-pointer"><i
                    class="fa-solid fa-home w-5"></i> Tableau de bord</a>
            <a onclick="router.navigate('devis')" id="nav-devis"
                class="nav-item flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors cursor-pointer"><i
                    class="fa-solid fa-pen-nib w-5"></i> Devis</a>
            <a onclick="router.navigate('calendar')" id="nav-calendar"
                class="nav-item flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors cursor-pointer"><i
                    class="fa-solid fa-calendar w-5"></i> Agenda</a>

            <!-- DROPDOWN GESTION -->
            <div>
                <button
                    onclick="document.getElementById('submenu-gestion').classList.toggle('hidden');document.getElementById('chevron-gestion').classList.toggle('rotate-180')"
                    class="w-full flex items-center justify-between px-4 py-3 text-sm font-medium rounded-xl text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors cursor-pointer group">
                    <div class="flex items-center gap-3"><i class="fa-solid fa-briefcase w-5"></i> Gestion</div>
                    <i id="chevron-gestion"
                        class="fa-solid fa-chevron-down text-xs transition-transform duration-200"></i>
                </button>
                <div id="submenu-gestion" class="hidden pl-4 space-y-1 mt-1">
                    <a onclick="router.navigate('clients')" id="nav-clients"
                        class="nav-item flex items-center gap-3 px-4 py-2 text-sm font-medium rounded-xl text-slate-500 dark:text-slate-500 hover:text-brand-600 dark:hover:text-brand-400 transition-colors cursor-pointer"><i
                            class="fa-solid fa-users w-4"></i> Clients</a>
                    <a onclick="router.navigate('items')" id="nav-items"
                        class="nav-item flex items-center gap-3 px-4 py-2 text-sm font-medium rounded-xl text-slate-500 dark:text-slate-500 hover:text-brand-600 dark:hover:text-brand-400 transition-colors cursor-pointer"><i
                            class="fa-solid fa-box w-4"></i> Articles</a>
                    <a onclick="router.navigate('expenses')" id="nav-expenses"
                        class="nav-item flex items-center gap-3 px-4 py-2 text-sm font-medium rounded-xl text-slate-500 dark:text-slate-500 hover:text-brand-600 dark:hover:text-brand-400 transition-colors cursor-pointer"><i
                            class="fa-solid fa-receipt w-4"></i> D√©penses</a>
                    <a onclick="router.navigate('deals')" id="nav-deals"
                        class="nav-item flex items-center gap-3 px-4 py-2 text-sm font-medium rounded-xl text-slate-500 dark:text-slate-500 hover:text-brand-600 dark:hover:text-brand-400 transition-colors cursor-pointer"><i
                            class="fa-solid fa-tags w-4"></i> Bons Plans</a>
                </div>
            </div>

            <a onclick="router.navigate('settings')" id="nav-settings"
                class="nav-item flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors cursor-pointer"><i
                    class="fa-solid fa-cog w-5"></i> Param√®tres</a>
        </nav>
        <div class="p-4 border-t border-slate-200 dark:border-slate-800">
            <div class="flex items-center gap-3 p-2 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-800 cursor-pointer"
                onclick="authManager.logout()">
                <img id="user-photo" src="" class="w-8 h-8 rounded-full bg-slate-200">
                <div class="flex-1 min-w-0">
                    <div id="user-name" class="text-sm font-bold truncate dark:text-white">...</div>
                    <div class="text-xs text-slate-400">D√©connexion</div>
                </div>
            </div>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 overflow-y-auto custom-scrollbar relative w-full pb-24 md:pb-0">
        <span id="badge-status-mobile"
            class="text-[10px] font-bold bg-green-100 dark:bg-green-900/30 px-3 py-1 rounded-full text-green-700 dark:text-green-400 flex items-center gap-1">ONLINE</span>
        </div>
        </div>

        <!-- VIEWS -->
        <!-- 1. HOME -->
        <section id="view-home" class="view-section hidden p-4 md:p-8 max-w-6xl mx-auto">
            <div class="mb-8 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div>
                    <h1 class="text-3xl md:text-4xl font-black dark:text-white mb-2">Bonjour, <span id="dash-name"
                            class="gradient-text">Chef</span> üëã</h1>
                    <p class="text-slate-500 dark:text-slate-400 text-base flex items-center gap-2">Tout est gratuit
                        pour vous.</p>
                </div>
                <button onclick="themeManager.toggle()"
                    class="w-10 h-10 rounded-full glass flex items-center justify-center text-slate-500"><i
                        class="fa-solid fa-moon dark:hidden"></i><i
                        class="fa-solid fa-sun hidden dark:inline"></i></button>
            </div>

            <!-- STATS GRID -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div class="glass p-5 rounded-2xl shadow-sm card-hover border border-slate-200 dark:border-slate-700">
                    <div class="text-xs font-bold text-slate-400 uppercase mb-2">Chiffre d'Affaires</div>
                    <div class="text-2xl font-black text-slate-900 dark:text-white" id="stat-revenue">-- ‚Ç¨</div>
                </div>
                <div class="glass p-5 rounded-2xl shadow-sm card-hover border border-slate-200 dark:border-slate-700">
                    <div class="text-xs font-bold text-slate-400 uppercase mb-2">Devis Sign√©s</div>
                    <div class="text-2xl font-black text-slate-900 dark:text-white" id="stat-signed">--</div>
                </div>
                <div class="glass p-5 rounded-2xl shadow-sm card-hover border border-slate-200 dark:border-slate-700">
                    <div class="text-xs font-bold text-slate-400 uppercase mb-2">Marge Nette</div>
                    <div class="text-2xl font-black text-green-600" id="stat-margin">-- ‚Ç¨</div>
                </div>
                <div class="bg-gradient-to-br from-brand-600 to-brand-800 p-5 rounded-2xl shadow-lg text-white cursor-pointer card-hover btn-action"
                    onclick="router.navigate('devis')">
                    <div class="text-xs font-bold text-brand-100 uppercase mb-2">Action Rapide</div>
                    <div class="text-lg font-black flex items-center gap-2"><i class="fa-solid fa-plus-circle"></i>
                        Cr√©er Devis</div>
                </div>
            </div>

            <!-- CHART SECTION (NEW) -->
            <div class="glass p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg dark:text-white flex items-center gap-2"><i
                            class="fa-solid fa-chart-line text-brand-500"></i> √âvolution du C.A.</h3>
                    <select id="chart-year"
                        class="bg-slate-100 dark:bg-slate-800 text-xs font-bold rounded-lg px-2 py-1 outline-none border-none"
                        onchange="dashboard.loadChart()">
                        <option value="2024">2024</option>
                        <option value="2025" selected>2025</option>
                    </select>
                </div>
                <div class="w-full h-64 relative">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>

            <div class="flex flex-col md:flex-row gap-4 mb-8">
                <!-- BONS PLANS CARD HOME -->
                <div class="flex-1 p-6 rounded-2xl bg-gradient-to-r from-slate-900 to-slate-800 text-white shadow-xl flex justify-between items-center cursor-pointer card-hover"
                    onclick="router.navigate('deals')">
                    <div>
                        <h3 class="font-bold text-xl mb-1 flex items-center gap-2"><i
                                class="fa-solid fa-fire text-red-500"></i> Bons Plans</h3>
                        <p class="text-sm text-slate-400">√âconomisez sur vos outils.</p>
                    </div>
                    <i class="fa-solid fa-chevron-right text-slate-500"></i>
                </div>
                <!-- EXPORT COMPTABLE CARD -->
                <div class="flex-1 p-6 rounded-2xl bg-gradient-to-r from-green-600 to-green-800 text-white shadow-xl flex justify-between items-center cursor-pointer card-hover"
                    onclick="dashboard.exportAccounting()">
                    <div>
                        <h3 class="font-bold text-xl mb-1 flex items-center gap-2"><i
                                class="fa-solid fa-file-excel"></i> Export Comptable</h3>
                        <p class="text-sm text-green-100">T√©l√©charger tout en CSV.</p>
                    </div>
                    <i class="fa-solid fa-download text-green-200"></i>
                </div>
            </div>

            <div class="glass rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700 overflow-hidden">
                <div class="p-6 border-b border-slate-200 dark:border-slate-700 flex justify-between">
                    <h3 class="font-bold dark:text-white">Derniers Documents</h3><button
                        onclick="router.navigate('devis')"
                        class="text-xs font-bold text-brand-600 bg-brand-50 px-3 py-1 rounded-lg">Nouveau</button>
                </div>
                <ul id="dash-recent-list" class="divide-y divide-slate-200 dark:divide-slate-700"></ul>
            </div>
        </section>

        <!-- 2. DEALS -->
        <section id="view-deals" class="view-section hidden p-4 md:p-8 max-w-6xl mx-auto">
            <div class="mb-8">
                <h1 class="text-3xl font-black dark:text-white mb-2 flex items-center gap-2">Bons Plans <span
                        class="gradient-fire">Pro</span> <i class="fa-solid fa-fire text-red-500 animate-pulse"></i>
                </h1>
                <p class="text-slate-500 text-sm">Les meilleures offres outillage du web.</p>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6" id="deals-grid"></div>
        </section>

        <!-- 3. DEVIS -->
        <section id="view-devis"
            class="view-section hidden p-0 h-full flex flex-col max-w-5xl mx-auto glass md:shadow-2xl md:my-6 md:rounded-3xl md:h-[calc(100vh-3rem)] overflow-hidden border border-slate-200 dark:border-slate-700">
            <div
                class="px-6 py-4 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center glass z-20">
                <button onclick="router.navigate('home')" class="text-slate-500 font-bold text-sm"><i
                        class="fa-solid fa-arrow-left mr-1"></i> Retour</button>
                <div class="flex bg-slate-100 dark:bg-slate-800 rounded-xl p-1">
                    <span
                        class="px-4 py-1.5 rounded-lg text-xs font-bold bg-white dark:bg-slate-700 text-brand-600 shadow-sm">NOUVEAU
                        DEVIS</span>
                </div>
                <div class="flex gap-2">
                    <button onclick="editorManager.print()"
                        class="w-10 h-10 rounded-xl bg-slate-100 hover:bg-slate-200 text-slate-600 flex items-center justify-center transition-colors"><i
                            class="fa-solid fa-print"></i></button>
                    <!-- BOUTON SIGNER -->
                    <button onclick="signatureManager.openModal()"
                        class="btn-action bg-blue-600 text-white px-5 py-2 rounded-xl text-sm font-bold shadow-lg flex items-center gap-2"><i
                            class="fa-solid fa-signature"></i> <span class="hidden sm:inline">Signer</span></button>
                    <!-- BOUTON SAUVEGARDER -->
                    <button onclick="editorManager.saveDocument()"
                        class="btn-action bg-green-600 text-white px-5 py-2 rounded-xl text-sm font-bold shadow-lg flex items-center gap-2"><i
                            class="fa-solid fa-save"></i> <span class="hidden sm:inline">Enreg.</span></button>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto custom-scrollbar p-4 md:p-8 space-y-6">
                <!-- INDICATEUR DE SIGNATURE -->
                <div id="signature-preview-banner"
                    class="hidden bg-green-100 border border-green-300 rounded-xl p-3 flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <i class="fa-solid fa-check-circle text-green-600 text-xl"></i>
                        <div>
                            <p class="font-bold text-green-800 text-sm">Document Sign√©</p>
                            <p class="text-xs text-green-600">Pr√™t √† √™tre envoy√©</p>
                        </div>
                    </div>
                    <img id="signature-preview-img" src="" class="h-8 border bg-white rounded">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="glass border border-slate-200 dark:border-slate-700 p-5 rounded-2xl cursor-pointer hover:border-brand-400 transition-colors"
                        onclick="clientManager.openAddModal()"><label
                            class="block text-xs font-extrabold text-brand-600 uppercase mb-2">Client</label>
                        <div class="flex justify-between">
                            <div id="editor-client-preview" class="font-bold text-lg dark:text-white text-slate-400">
                                S√©lectionner...</div><i class="fa-solid fa-chevron-down text-slate-400"></i>
                        </div><input type="hidden" id="editor-client-id">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="glass border border-slate-200 dark:border-slate-700 p-5 rounded-2xl"><label
                                class="block text-xs font-extrabold text-brand-600 uppercase mb-2">Date</label><input
                                type="date" id="editor-date"
                                class="w-full bg-slate-100 dark:bg-slate-800 rounded p-1 font-bold dark:text-white outline-none text-slate-900">
                        </div>
                        <div class="glass border border-slate-200 dark:border-slate-700 p-5 rounded-2xl"><label
                                class="block text-xs font-extrabold text-brand-600 uppercase mb-2">Validit√©</label><select
                                id="editor-validity"
                                class="w-full bg-slate-100 dark:bg-slate-800 rounded p-1 font-bold dark:text-white outline-none text-slate-900">
                                <option value="30">30 Jours</option>
                            </select></div>
                    </div>
                </div>
                <div
                    class="relative overflow-hidden rounded-2xl shadow-lg bg-gradient-to-r from-purple-600 to-blue-600 p-1">
                    <button onclick="aiManager.openModal()"
                        class="w-full bg-slate-900/90 text-white py-4 rounded-xl flex items-center justify-center gap-3 hover:bg-transparent transition-colors"><i
                            class="fa-solid fa-wand-magic-sparkles text-purple-400"></i> <span
                            class="font-bold">Assistant IA</span> <span class="text-xs opacity-70 font-normal">-
                            Gratuit</span></button>
                </div>
                <div>
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-bold text-sm uppercase text-slate-500">Prestations</h3><button
                            onclick="editorManager.openLibraryModal()"
                            class="text-xs font-bold text-brand-600 bg-brand-50 px-3 py-1 rounded"><i
                                class="fa-solid fa-book-open mr-1"></i> Biblio</button>
                    </div>
                    <div id="editor-lines" class="space-y-3"></div><button onclick="editorManager.addLine()"
                        class="mt-4 w-full py-4 border-2 border-dashed border-slate-300 dark:border-slate-700 rounded-2xl text-slate-500 font-bold text-sm hover:border-brand-400 hover:text-brand-600 transition-all flex items-center justify-center gap-2"><i
                            class="fa-solid fa-plus"></i> Ajouter une ligne</button>
                </div>
                <div class="flex justify-end">
                    <div class="w-full md:w-1/2 bg-slate-900 text-white rounded-2xl p-6 shadow-xl">
                        <div class="flex justify-between text-sm text-slate-400 mb-2"><span>Total HT</span><span
                                id="editor-total-ht">0.00 ‚Ç¨</span></div>
                        <div class="flex justify-between text-sm text-slate-400 mb-4 border-b border-slate-700 pb-4">
                            <span>TVA</span><span id="editor-total-tva">0.00 ‚Ç¨</span>
                        </div>
                        <div class="flex justify-between text-3xl font-black"><span>Net</span><span
                                id="editor-total-ttc" class="text-brand-400">0.00 ‚Ç¨</span></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 4. CALENDAR -->
        <section id="view-calendar" class="view-section hidden p-4 md:p-8 max-w-6xl mx-auto h-full flex flex-col">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-3xl font-black dark:text-white mb-1"><span class="gradient-text">Mon
                            Agenda</span>
                    </h2>
                    <p class="text-slate-500 dark:text-slate-400 text-base font-bold capitalize"
                        id="calendar-month-display">...</p>
                </div>
                <div class="flex gap-2"><button onclick="calendarManager.changeMonth(-1)"
                        class="w-10 h-10 rounded-xl glass shadow flex items-center justify-center hover:scale-110 border border-slate-200 dark:border-slate-700"><i
                            class="fa-solid fa-chevron-left text-brand-600"></i></button><button
                        onclick="calendarManager.changeMonth(1)"
                        class="w-10 h-10 rounded-xl glass shadow flex items-center justify-center hover:scale-110 border border-slate-200 dark:border-slate-700"><i
                            class="fa-solid fa-chevron-right text-brand-600"></i></button></div>
            </div>
            <div
                class="glass rounded-2xl shadow-xl border border-slate-200/50 dark:border-slate-700/50 overflow-hidden flex-1 flex flex-col">
                <div
                    class="grid grid-cols-7 border-b border-slate-200 dark:border-slate-700 bg-slate-100 dark:bg-slate-800/50">
                    <div
                        class="py-3 text-center text-xs font-extrabold text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                        Lun</div>
                    <div
                        class="py-3 text-center text-xs font-extrabold text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                        Mar</div>
                    <div
                        class="py-3 text-center text-xs font-extrabold text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                        Mer</div>
                    <div
                        class="py-3 text-center text-xs font-extrabold text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                        Jeu</div>
                    <div
                        class="py-3 text-center text-xs font-extrabold text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                        Ven</div>
                    <div
                        class="py-3 text-center text-xs font-extrabold text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                        Sam</div>
                    <div
                        class="py-3 text-center text-xs font-extrabold text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                        Dim</div>
                </div>
                <div id="calendar-grid"
                    class="calendar-grid flex-1 overflow-y-auto custom-scrollbar p-2 bg-slate-50 dark:bg-slate-900/30">
                </div>
            </div>
        </section>

        <!-- 5. CLIENTS -->
        <section id="view-clients" class="view-section hidden p-4 md:p-8 max-w-6xl mx-auto">
            <h2 class="text-3xl font-black dark:text-white mb-6">Clients</h2>
            <div id="clients-list-body" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div><button
                onclick="clientManager.openAddModal()"
                class="fixed bottom-24 right-6 w-16 h-16 bg-brand-600 text-white rounded-2xl shadow-2xl flex items-center justify-center text-2xl btn-action"><i
                    class="fa-solid fa-plus"></i></button>
        </section>

        <!-- 6. ITEMS -->
        <section id="view-items" class="view-section hidden p-4 md:p-8 max-w-6xl mx-auto">
            <h2 class="text-3xl font-black dark:text-white mb-6">Biblioth√®que</h2>
            <div id="items-list-body" class="space-y-3"></div><button onclick="itemManager.openAddModal()"
                class="fixed bottom-24 right-6 w-16 h-16 bg-brand-600 text-white rounded-2xl shadow-2xl flex items-center justify-center text-2xl btn-action"><i
                    class="fa-solid fa-plus"></i></button>
        </section>

        <!-- 7. EXPENSES (NEW) -->
        <section id="view-expenses" class="view-section hidden p-4 md:p-8 max-w-5xl mx-auto">
            <h2 class="text-3xl font-black dark:text-white mb-6">D√©penses</h2>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <!-- ADD EXPENSE FORM -->
                <div
                    class="md:col-span-1 glass p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 h-fit">
                    <h3 class="font-bold mb-4 dark:text-white">Nouvelle D√©pense</h3>
                    <form onsubmit="event.preventDefault(); expensesManager.add();" class="space-y-3">
                        <div>
                            <label class="text-xs font-bold text-slate-500 uppercase">Date</label>
                            <input type="date" id="exp-date"
                                class="w-full bg-slate-50 dark:bg-slate-800 border-none rounded-xl p-3 text-sm font-bold outline-none focus:ring-2 focus:ring-brand-500 dark:text-white"
                                required>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-slate-500 uppercase">Fournisseur</label>
                            <input type="text" id="exp-supplier" placeholder="Ex: Leroy Merlin"
                                class="w-full bg-slate-50 dark:bg-slate-800 border-none rounded-xl p-3 text-sm font-bold outline-none focus:ring-2 focus:ring-brand-500 dark:text-white"
                                required>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-slate-500 uppercase">Montant TTC</label>
                            <input type="number" step="0.01" id="exp-amount" placeholder="0.00 ‚Ç¨"
                                class="w-full bg-slate-50 dark:bg-slate-800 border-none rounded-xl p-3 text-sm font-bold outline-none focus:ring-2 focus:ring-brand-500 dark:text-white"
                                required>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-slate-500 uppercase">Cat√©gorie</label>
                            <select id="exp-category"
                                class="w-full bg-slate-50 dark:bg-slate-800 border-none rounded-xl p-3 text-sm font-bold outline-none focus:ring-2 focus:ring-brand-500 dark:text-white">
                                <option value="Mat√©riaux">Mat√©riaux</option>
                                <option value="Carburant">Carburant</option>
                                <option value="Sous-traitance">Sous-traitance</option>
                                <option value="Outillage">Outillage</option>
                                <option value="Autre">Autre</option>
                            </select>
                        </div>
                        <button type="submit"
                            class="w-full bg-brand-600 text-white font-bold py-3 rounded-xl hover:bg-brand-700 transition-colors shadow-lg shadow-brand-500/30">Ajouter</button>
                    </form>
                </div>

                <!-- EXPENSES LIST -->
                <div class="md:col-span-2 space-y-4">
                    <div
                        class="glass p-4 rounded-2xl flex justify-between items-center border border-slate-200 dark:border-slate-700">
                        <div>
                            <div class="text-xs font-bold text-slate-400 uppercase">Total D√©penses (Mois)</div>
                            <div class="text-2xl font-black text-slate-900 dark:text-white" id="exp-total-month">
                                0.00 ‚Ç¨</div>
                        </div>
                        <div class="w-10 h-10 rounded-full bg-red-50 text-red-500 flex items-center justify-center">
                            <i class="fa-solid fa-arrow-down"></i>
                        </div>
                    </div>

                    <div
                        class="glass rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
                        <div class="p-4 border-b border-slate-200 dark:border-slate-700 font-bold dark:text-white">
                            Historique</div>
                        <ul id="expenses-list"
                            class="divide-y divide-slate-200 dark:divide-slate-700 max-h-[400px] overflow-y-auto custom-scrollbar">
                            <!-- JS Generated -->
                        </ul>
                    </div>
                </div>
            </div>
        </section>

        <!-- 8. SETTINGS -->
        <section id="view-settings" class="view-section hidden p-4 md:p-8 max-w-3xl mx-auto">
            <h2 class="text-3xl font-black dark:text-white mb-6">Param√®tres & Mentions L√©gales</h2>
            <form onsubmit="settingsManager.save(event)" class="glass p-8 rounded-2xl shadow-lg space-y-6">
                <!-- LOGO UPLOAD -->
                <div>
                    <label class="font-bold text-sm block mb-2 dark:text-white">Logo de l'entreprise</label>
                    <div class="flex items-center gap-4">
                        <div id="preview-logo"
                            class="w-24 h-24 bg-slate-100 dark:bg-slate-800 rounded-xl flex items-center justify-center border border-slate-200 overflow-hidden">
                            <i class="fa-solid fa-image text-slate-400 text-2xl"></i>
                        </div>
                        <div>
                            <input type="file" id="set-logo" class="hidden" accept="image/*"
                                onchange="settingsManager.handleLogo(this)">
                            <button type="button" onclick="document.getElementById('set-logo').click()"
                                class="bg-brand-100 text-brand-600 px-4 py-2 rounded-lg font-bold text-sm hover:bg-brand-200">Choisir
                                une image</button>
                            <p class="text-xs text-slate-500 mt-1">PNG ou JPG (Max 500ko)</p>
                        </div>
                    </div>
                </div>
                <div><label class="font-bold text-sm block mb-2 dark:text-white">Nom Entreprise</label><input
                        id="set-company"
                        class="w-full p-4 bg-slate-50 dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-700 outline-none text-slate-900 dark:text-white">
                </div>
                <div><label class="font-bold text-sm block mb-2 dark:text-white">SIRET</label><input id="set-siret"
                        class="w-full p-4 bg-slate-50 dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-700 outline-none text-slate-900 dark:text-white">
                </div>
                <div><label class="font-bold text-sm block mb-2 dark:text-white">Adresse</label><textarea
                        id="set-address" rows="2"
                        class="w-full p-4 bg-slate-50 dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-700 outline-none text-slate-900 dark:text-white"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="font-bold text-sm block mb-2 dark:text-white text-brand-600">N¬∞ Assurance
                            D√©cennale</label><input id="set-decennale" placeholder="Obligatoire"
                            class="w-full p-4 bg-slate-50 dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-700 outline-none text-slate-900 dark:text-white">
                    </div>
                    <div><label class="font-bold text-sm block mb-2 dark:text-white text-brand-600">Label RGE
                            (Optionnel)</label><input id="set-rge" placeholder="Qualibat / EcoArtisan"
                            class="w-full p-4 bg-slate-50 dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-700 outline-none text-slate-900 dark:text-white">
                    </div>
                </div>
                <!-- TVA Intracommunautaire -->
                <div><label class="font-bold text-sm block mb-2 dark:text-white">N¬∞ TVA
                        Intracommunautaire</label><input id="set-tva-intra"
                        class="w-full p-4 bg-slate-50 dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-700 outline-none text-slate-900 dark:text-white">
                </div>

                <button class="w-full py-4 bg-brand-600 text-white font-bold rounded-xl btn-action">Enregistrer les
                    mentions</button>
            </form>

            <!-- SECTION PROFIL -->
            <div class="glass p-8 rounded-2xl shadow-lg border border-slate-200/50 dark:border-slate-700/50 mt-8">
                <h3 class="font-bold text-lg mb-4 dark:text-white flex items-center gap-2"><i
                        class="fa-solid fa-user-circle text-brand-600"></i> Mon Profil</h3>
                <div class="flex items-center gap-4 mb-6">
                    <img id="settings-photo" src="" class="w-16 h-16 rounded-full bg-slate-200 object-cover">
                    <div>
                        <p class="text-sm text-slate-500">Connect√© en tant que</p>
                        <p id="settings-email" class="font-bold dark:text-white">...</p>
                    </div>
                </div>
                <div class="space-y-4">
                    <div><label class="font-bold text-sm block mb-2 dark:text-white">Nom d'affichage</label><input
                            id="set-username"
                            class="w-full p-4 bg-slate-50 dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-700 outline-none text-slate-900 dark:text-white">
                    </div>
                    <button type="button" onclick="settingsManager.updateProfile()"
                        class="w-full py-3 bg-brand-100 text-brand-700 font-bold rounded-xl hover:bg-brand-200 transition-colors">Mettre
                        √† jour le profil</button>
                    <button type="button" onclick="authManager.logout()"
                        class="w-full py-3 border-2 border-red-100 text-red-500 font-bold rounded-xl hover:bg-red-50 transition-colors">Se
                        d√©connecter</button>
                </div>
            </div>
        </section>

        <!-- 8. SUIVI CHANTIER -->
        <section id="view-sites" class="view-section hidden p-4 md:p-8 max-w-6xl mx-auto">
            <div class="mb-8 flex justify-between items-center">
                <div>
                    <h2 class="text-3xl font-black dark:text-white mb-2"><span class="gradient-text">Suivi de
                            Chantier</span></h2>
                    <p class="text-slate-500 dark:text-slate-400">Journal de bord et photos</p>
                </div><button onclick="siteManager.addNote()"
                    class="bg-brand-600 text-white px-4 py-2 rounded-lg font-bold shadow-lg btn-action"><i
                        class="fa-solid fa-camera mr-2"></i> Ajouter Note/Photo</button>
            </div>
            <div id="sites-feed" class="space-y-6">
                <div class="glass p-6 rounded-2xl border border-slate-200 dark:border-slate-700">
                    <div class="flex items-center gap-3 mb-4">
                        <div
                            class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold">
                            M</div>
                        <div>
                            <div class="font-bold dark:text-white">Exemple : Chantier Mme. Martin</div>
                            <div class="text-xs text-slate-500">Aujourd'hui, 14:30</div>
                        </div>
                    </div>
                    <p class="text-slate-700 dark:text-slate-300 mb-4">Fin de la pose du placo dans le salon.
                        Pr√©voir
                        pon√ßage demain matin.</p>
                </div>
            </div>
        </section>
    </main>

    <!-- MOBILE NAV -->
    <div id="mobile-nav"
        class="md:hidden fixed bottom-0 left-0 right-0 glass border-t border-slate-200/50 dark:border-slate-700/50 flex justify-around p-3 pb-safe z-40 shadow-2xl">
        <button onclick="router.navigate('home')"
            class="p-2 flex flex-col items-center text-slate-400 nav-btn-mobile transition-all" data-target="home"><i
                class="fa-solid fa-house mb-1 text-lg"></i><span
                class="text-[10px] font-bold">Accueil</span></button><button onclick="router.navigate('sites')"
            class="p-2 flex flex-col items-center text-slate-400 nav-btn-mobile transition-all" data-target="sites"><i
                class="fa-solid fa-hard-hat mb-1 text-lg"></i><span
                class="text-[10px] font-bold">Chantier</span></button><button onclick="router.navigate('devis')"
            class="p-2 -mt-10">
            <div
                class="w-16 h-16 bg-gradient-to-br from-brand-500 to-brand-700 rounded-2xl flex items-center justify-center text-white shadow-2xl shadow-brand-500/40 hover:scale-110 transition-all">
                <i class="fa-solid fa-plus text-2xl"></i>
            </div>
        </button><button onclick="router.navigate('clients')"
            class="p-2 flex flex-col items-center text-slate-400 nav-btn-mobile transition-all" data-target="clients"><i
                class="fa-solid fa-users mb-1 text-lg"></i><span
                class="text-[10px] font-bold">Clients</span></button><button onclick="router.navigate('settings')"
            class="p-2 flex flex-col items-center text-slate-400 nav-btn-mobile transition-all"
            data-target="settings"><i class="fa-solid fa-cog mb-1 text-lg"></i><span
                class="text-[10px] font-bold">R√©glages</span></button>
    </div>

    <!-- MODALS -->

    <!-- MODAL SIGNATURE -->
    <div id="modal-signature"
        class="fixed inset-0 z-[100] hidden flex flex-col items-center justify-center bg-black/80 backdrop-blur-sm">
        <div class="glass w-full max-w-lg p-6 rounded-3xl animate-slide-up mx-4">
            <h3 class="font-bold text-xl mb-2 dark:text-white flex items-center gap-2">
                <i class="fa-solid fa-signature text-brand-600"></i> Signature Client
            </h3>
            <p class="text-sm text-slate-500 mb-4">Signez dans le cadre ci-dessous :</p>

            <div class="bg-white rounded-xl border-2 border-dashed border-slate-300 overflow-hidden touch-none relative"
                style="height: 250px;">
                <canvas id="signature-pad" class="w-full h-full cursor-crosshair"></canvas>
            </div>

            <div class="flex gap-3 mt-6">
                <button onclick="signatureManager.clear()"
                    class="flex-1 py-3 text-red-500 font-bold bg-red-50 rounded-xl hover:bg-red-100 transition-colors">Effacer</button>
                <button onclick="signatureManager.save()"
                    class="flex-[2] py-3 bg-brand-600 text-white font-bold rounded-xl hover:bg-brand-700 shadow-lg btn-action">Valider
                    la signature</button>
            </div>
            <button onclick="signatureManager.close()"
                class="mt-4 text-xs text-slate-400 w-full text-center hover:text-white">Annuler</button>
        </div>
    </div>

    <div id="modal-ai" class="fixed inset-0 z-[100] hidden flex flex-col items-center justify-end sm:justify-center">
        <div class="fixed inset-0 bg-black/70 backdrop-blur-md" onclick="aiManager.closeModal()"></div>
        <div class="glass w-full sm:max-w-lg p-8 rounded-t-3xl sm:rounded-3xl z-10 animate-slide-up">
            <h3 class="text-2xl font-black mb-4 dark:text-white flex items-center gap-2"><i
                    class="fa-solid fa-wand-magic-sparkles text-purple-500"></i> Assistant IA</h3><textarea
                id="ai-input" rows="4"
                class="w-full p-4 bg-slate-100 dark:bg-slate-800 rounded-xl mb-4 outline-none text-slate-900 dark:text-white"
                placeholder="D√©crivez les travaux..."></textarea><button onclick="aiManager.generate()"
                id="ai-btn-generate"
                class="w-full py-4 bg-purple-600 text-white font-bold rounded-xl btn-action">G√©n√©rer</button>
        </div>
    </div>
    <div id="modal-generic"
        class="fixed inset-0 z-[60] hidden flex flex-col items-center justify-end sm:justify-center"></div>

    <!-- PREMIUM MODAL -->
    <div id="modal-premium"
        class="fixed inset-0 z-[80] hidden flex flex-col items-center justify-center bg-slate-900/90 backdrop-blur-sm p-4 animate-fade-in">
        <div
            class="bg-white dark:bg-slate-900 w-full max-w-2xl rounded-3xl overflow-hidden shadow-2xl border border-slate-200 dark:border-slate-700 relative">
            <button onclick="document.getElementById('modal-premium').classList.add('hidden')"
                class="absolute top-4 right-4 w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center text-slate-500 hover:text-red-500 transition-colors z-10">
                <i class="fa-solid fa-times"></i>
            </button>

            <div class="grid grid-cols-1 md:grid-cols-2">
                <div class="p-8 bg-slate-50 dark:bg-slate-800/50 flex flex-col justify-center">
                    <div
                        class="w-16 h-16 bg-gradient-to-br from-amber-400 to-orange-600 rounded-2xl flex items-center justify-center text-white text-3xl mb-6 shadow-lg shadow-orange-500/30">
                        <i class="fa-solid fa-crown"></i>
                    </div>
                    <h2 class="text-3xl font-black text-slate-900 dark:text-white mb-2">Passez <span
                            class="gradient-fire">Premium</span></h2>
                    <p class="text-slate-500 dark:text-slate-400 mb-6">D√©bloquez tout le potentiel de ProGest pour votre
                        entreprise.</p>
                    <div class="text-4xl font-black text-slate-900 dark:text-white mb-1">19.00‚Ç¨ <span
                            class="text-sm font-bold text-slate-400">/mois</span></div>
                    <p class="text-xs text-slate-400">Sans engagement. Annulable √† tout moment.</p>
                </div>
                <div class="p-8">
                    <ul class="space-y-4 mb-8">
                        <li class="flex items-center gap-3 text-sm font-bold text-slate-700 dark:text-slate-300">
                            <i class="fa-solid fa-check-circle text-green-500 text-lg"></i> Assistant IA Illimit√©
                        </li>
                        <li class="flex items-center gap-3 text-sm font-bold text-slate-700 dark:text-slate-300">
                            <i class="fa-solid fa-check-circle text-green-500 text-lg"></i> Export Comptable CSV
                        </li>
                        <li class="flex items-center gap-3 text-sm font-bold text-slate-700 dark:text-slate-300">
                            <i class="fa-solid fa-check-circle text-green-500 text-lg"></i> Support Prioritaire
                        </li>
                        <li class="flex items-center gap-3 text-sm font-bold text-slate-700 dark:text-slate-300">
                            <i class="fa-solid fa-check-circle text-green-500 text-lg"></i> Sauvegardes Cloud
                        </li>
                    </ul>
                    <button onclick="DataService.upgrade()"
                        class="w-full py-4 bg-gradient-to-r from-amber-500 to-orange-600 text-white font-bold rounded-xl shadow-lg shadow-orange-500/30 hover:scale-105 transition-transform btn-action">
                        Activer le Premium
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- PRINT TEMPLATE -->
    <div id="print-area">
        <div class="print-page font-sans p-10 max-w-[210mm] mx-auto bg-white text-slate-900 h-full relative">
            <!-- Header -->
            <div class="flex justify-between items-start mb-10 pb-6 border-b-2 border-slate-900">
                <div class="w-1/2">
                    <img id="print-logo" class="h-20 object-contain mb-4 hidden" src="">
                    <div id="print-company-info" class="text-sm text-slate-600 whitespace-pre-line"></div>
                </div>
                <div class="text-right w-1/2">
                    <h1 class="text-5xl font-black uppercase tracking-tighter mb-2" id="print-type">DEVIS</h1>
                    <p class="text-lg font-bold">N¬∞ <span id="print-ref"></span></p>
                    <p class="text-sm text-slate-500">Date : <span id="print-date"></span></p>
                </div>
            </div>

            <!-- Client -->
            <div class="mb-12 bg-slate-50 p-6 rounded-xl border border-slate-100">
                <p class="text-xs font-bold text-slate-400 uppercase mb-2">Factur√© √†</p>
                <h3 class="font-bold text-2xl mb-1" id="print-client-name"></h3>
            </div>

            <!-- Lines -->
            <table class="w-full mb-8">
                <thead class="bg-slate-900 text-white">
                    <tr>
                        <th class="py-3 px-4 text-left text-xs font-bold uppercase rounded-l-lg">Description
                        </th>
                        <th class="py-3 px-4 text-center text-xs font-bold uppercase w-16">Qt√©</th>
                        <th class="py-3 px-4 text-center text-xs font-bold uppercase w-16">TVA</th>
                        <th class="py-3 px-4 text-right text-xs font-bold uppercase w-24">Prix U.</th>
                        <th class="py-3 px-4 text-right text-xs font-bold uppercase w-24 rounded-r-lg">Total
                        </th>
                    </tr>
                </thead>
                <tbody id="print-lines" class="text-sm"></tbody>
            </table>

            <!-- Totals -->
            <div class="flex justify-end mb-10">
                <div class="w-1/2 space-y-2">
                    <div class="flex justify-between text-slate-600"><span>Total HT</span><span class="font-bold"
                            id="print-ht"></span></div>
                    <div class="flex justify-between text-slate-600"><span>Total TVA</span><span class="font-bold"
                            id="print-tva"></span></div>
                    <div
                        class="flex justify-between text-2xl font-black text-slate-900 border-t-2 border-slate-900 pt-2 mt-2">
                        <span>NET √Ä PAYER</span><span id="print-ttc"></span>
                    </div>
                </div>
            </div>

            <!-- Signature Area Print -->
            <div class="flex justify-between mt-10 mb-20">
                <div class="w-1/3 border-t border-slate-300 pt-2">
                    <p class="text-xs font-bold uppercase text-slate-400">Pour l'entreprise</p>
                </div>
                <div class="w-1/3 border-t border-slate-300 pt-2 relative">
                    <p class="text-xs font-bold uppercase text-slate-400">Bon pour accord (Client)</p>
                    <img id="print-signature-img" class="absolute top-4 left-0 w-full h-auto mix-blend-multiply hidden"
                        src="">
                    <p id="print-signature-date" class="text-[10px] text-slate-400 mt-20 hidden">Sign√©
                        num√©riquement
                        le...</p>
                </div>
            </div>

            <!-- Footer Legal -->
            <div class="absolute bottom-10 left-10 right-10 text-center border-t pt-4 text-[10px] text-slate-400">
                <p id="print-legal-footer"></p>
                <p class="mt-1">Document g√©n√©r√© par ProGest</p>
            </div>
        </div>
    </div>

    <!-- LOGIC -->
    <script>
        window.onerror = function (msg, url, line, col, error) {
            alert("Erreur JS: " + msg + "\nLigne: " + line);
            return false;
        };
    </script>
    <script type="module">
        // --- 1. CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyBXRdDsXLzDpksSXTQb8EVrRaEU5s4Xfm0",
            authDomain: "progest-e4b55.firebaseapp.com",
            projectId: "progest-e4b55",
            storageBucket: "progest-e4b55.firebasestorage.app",
            messagingSenderId: "195166049754",
            appId: "1:195166049754:web:246a8ef1e7653603eb5ce3"
        };

        // --- 2. IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, deleteDoc, doc, query, where } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

        let db, auth;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            console.log("‚úÖ Firebase Initialis√©");
        } catch (e) { console.error("Erreur Firebase:", e); }



        // --- 3. DEALS MANAGER (AFFILIATION) ---
        window.dealsManager = {
            fakeDeals: [
                { title: "Bosch Professional 103 pi√®ces Jeu de forets et d'embouts", price: 34, old: 50, link: "https://amzn.to/3KTfEh0", img: "https://m.media-amazon.com/images/I/811e1lAbH7L._AC_SX569_.jpg", hot: true },
                { title: "Bosch Professional scie circulaire GKS 190", price: 122, old: 130, link: "https://amzn.to/3KW1EmQ", img: "https://m.media-amazon.com/images/I/51crVNWfQlL._AC_SX569_.jpg", hot: false },
                { title: "Makita DDF482Z Perceuse visseuse 60 nm 18 V Bleu", price: 79, old: 117, link: "https://amzn.to/4oR8nwo", img: "https://m.media-amazon.com/images/I/71bmqgnZQdL._AC_SY679_.jpg", hot: true },
                { title: "Makita DBO180Z Ponceuse Excentrique √ò 125 mm", price: 93, old: 118, link: "https://amzn.to/3MXR6UI", img: "https://m.media-amazon.com/images/I/51txDg7nshL._AC_SX569_.jpg", hot: false }
            ],
            render() {
                const g = document.getElementById('deals-grid'); if (!g) return;
                g.innerHTML = '';
                this.fakeDeals.forEach(d => {
                    const discount = Math.round(((d.old - d.price) / d.old) * 100);
                    const fire = d.hot ? '<i class="fa-solid fa-fire text-orange-500 animate-pulse absolute top-3 left-3 text-lg bg-white rounded-full p-1 shadow"></i>' : '';
                    g.innerHTML += `
                    <div class="glass rounded-2xl overflow-hidden shadow-lg card-hover relative group">
                        ${fire} <span class="promo-badge">-${discount}%</span>
                        <div class="h-48 bg-white flex items-center justify-center p-4 relative">
                            <img src="${d.img}" class="h-full object-contain group-hover:scale-110 transition-transform duration-500">
                        </div>
                        <div class="p-5">
                            <h3 class="font-bold text-slate-900 dark:text-white mb-2 leading-tight h-10 overflow-hidden">${d.title}</h3>
                            <div class="flex items-end gap-2 mb-4"><span class="text-2xl font-black text-red-500">${d.price}‚Ç¨</span><span class="text-sm text-slate-400 line-through mb-1">${d.old}‚Ç¨</span></div>
                            <a href="${d.link}" target="_blank" class="block w-full py-3 bg-slate-900 dark:bg-brand-600 text-white font-bold text-center rounded-xl hover:bg-slate-700 transition-colors btn-action">Voir l'offre</a>
                        </div>
                    </div>`;
                });
            }
        };

        // --- 4. DATA SERVICE ---
        const DataService = {
            userId: null, isPremium: false, // Default to false
            _getLocal(k) { return JSON.parse(localStorage.getItem('pg_' + k) || '[]'); },
            _saveLocal(k, v) { localStorage.setItem('pg_' + k, JSON.stringify(v)); },
            async get(c) {
                console.log(`Getting ${c}, User: ${this.userId}, DB: ${!!db}`);
                if (db && this.userId && !this.userId.startsWith('demo_')) {
                    try {
                        const q = query(collection(db, c), where("uid", "==", this.userId));
                        const s = await getDocs(q);
                        this._online(true);
                        console.log(`Fetched ${s.docs.length} docs from cloud`);
                        return s.docs.map(d => ({ id: d.id, ...d.data() }));
                    } catch (e) {
                        console.error("Firestore Get Error:", e);
                        this._online(false);
                    }
                }
                return this._getLocal(c);
            },
            async add(c, d) {
                // alert(`Saving to ${c}...`); // Debug
                d.uid = this.userId || 'guest';
                d.created_at = new Date().toISOString();
                console.log(`Adding to ${c}, User: ${this.userId}, DB: ${!!db}`);

                if (db && this.userId && !this.userId.startsWith('demo_')) {
                    try {
                        const r = await addDoc(collection(db, c), d);
                        this._online(true);
                        console.log("Added to cloud:", r.id);
                        return { id: r.id, ...d };
                    } catch (e) {
                        console.error("Firestore Add Error:", e);
                        alert(`Erreur sauvegarde Cloud: ${e.message}. Sauvegarde locale...`);
                        this._online(false);
                    }
                }
                const i = this._getLocal(c);
                d.id = 'loc_' + Date.now();
                i.push(d);
                this._saveLocal(c, i);
                console.log("Added locally");
                return d;
            },
            async delete(c, id) {
                if (db && !id.startsWith('loc_') && this.userId && !this.userId.startsWith('demo_')) { try { await deleteDoc(doc(db, c, id)); this._online(true); return; } catch { } }
                this._saveLocal(c, this._getLocal(c).filter(x => x.id !== id));
            },
            async saveSettings(d) { this._saveLocal('settings', [d]); if (db && this.userId && !this.userId.startsWith('demo_')) try { await this.add('settings', d); } catch { } },
            _online(s) { const h = s ? '<span class="w-1.5 h-1.5 bg-green-500 rounded-full status-dot"></span> ONLINE' : 'OFFLINE'; document.getElementById('badge-status-desktop').innerHTML = h; document.getElementById('badge-status-mobile').innerHTML = h; },

            // PREMIUM LOGIC
            STRIPE_LINK: 'https://buy.stripe.com/PLACEHOLDER', // ‚ö†Ô∏è DEMANDE √Ä TES PARENTS DE METTRE LEUR LIEN ICI

            checkPremium() {
                if (this.isPremium) return true;
                document.getElementById('modal-premium').classList.remove('hidden');
                return false;
            },
            upgrade() {
                // 1. Open Payment Page
                window.open(this.STRIPE_LINK, '_blank');

                // 2. Simulate success (waiting for real backend)
                if (confirm("Avez-vous effectu√© le paiement sur la page qui vient de s'ouvrir ?")) {
                    this.isPremium = true;
                    localStorage.setItem('pg_premium', 'true');
                    document.getElementById('modal-premium').classList.add('hidden');
                    alert("F√©licitations ! Vous √™tes maintenant Premium üëë");
                    window.location.reload();
                }
            },
            initPremium() {
                this.isPremium = localStorage.getItem('pg_premium') === 'true';
            }
        };
        window.DataService = DataService;
        DataService.initPremium();

        // --- 5. AUTH MANAGER (UPDATED FOR DEMO) ---
        window.authManager = {
            login: async () => {
                const errorDiv = document.getElementById('login-error');
                if (!auth) return alert("Erreur: Firebase non initialis√©");
                try {
                    errorDiv.classList.add('hidden');
                    await signInWithPopup(auth, new GoogleAuthProvider());
                }
                catch (e) {
                    console.error(e);
                    let msg = "Erreur de connexion.";
                    // Detailed error handling
                    msg += ` [${e.code}] ${e.message}`;

                    if (e.code === 'auth/unauthorized-domain') msg = "‚ö†Ô∏è Domaine non autoris√©. Ajoutez ce domaine dans Firebase Console > Auth > Settings > Authorized Domains.";
                    else if (e.code === 'auth/popup-closed-by-user') msg = "Connexion annul√©e par l'utilisateur.";
                    else if (e.code === 'auth/internal-error') msg = "Erreur interne Google. V√©rifiez l'email de support dans la console Firebase (Project Settings > General).";

                    errorDiv.innerText = msg;
                    errorDiv.classList.remove('hidden');
                }
            },
            loginDemo: () => {
                try {
                    console.log("Starting Demo Mode...");
                    // Mock user for demo
                    const demoUser = {
                        uid: 'demo_' + Date.now(),
                        displayName: 'Utilisateur D√©mo',
                        email: 'demo@progest.com',
                        photoURL: 'https://ui-avatars.com/api/?name=Demo&background=random'
                    };

                    DataService.userId = demoUser.uid;

                    // Update UI
                    document.getElementById('user-name').innerText = demoUser.displayName;
                    document.getElementById('user-photo').src = demoUser.photoURL;
                    document.getElementById('dash-name').innerText = 'D√©mo';
                    document.getElementById('settings-email').innerText = demoUser.email;
                    document.getElementById('set-username').value = demoUser.displayName;

                    // Mock Subscription
                    window.subscriptionManager = { checkLimit: async () => true, checkForSuccess: () => { } };

                    // Initialize Signature for Demo Mode
                    if (window.signatureManager) {
                        window.signatureManager.init();
                    } else {
                        console.error("SignatureManager not found");
                    }

                    // Switch Views
                    const loginView = document.getElementById('view-login');
                    if (loginView) {
                        loginView.classList.remove('active');
                        loginView.classList.add('hidden');
                    }

                    if (window.router) {
                        window.router.navigate('home');
                    } else {
                        alert("Erreur: Router non initialis√©");
                    }

                    alert("Vous √™tes en mode D√âMO. Les donn√©es sont enregistr√©es localement dans votre navigateur.");
                } catch (e) {
                    console.error("Demo Login Error:", e);
                    alert("Erreur lors du lancement de la d√©mo: " + e.message);
                }
            },
            logout: async () => {
                if (confirm("D√©connexion ?")) {
                    if (auth && auth.currentUser) await signOut(auth);
                    window.location.reload();
                }
            }
        };

        // --- NEW : SIGNATURE MANAGER ---
        window.signatureManager = {
            canvas: null, ctx: null, isDrawing: false, currentSignatureData: null,
            init() {
                this.canvas = document.getElementById('signature-pad');
                if (!this.canvas) return;
                this.ctx = this.canvas.getContext('2d');

                // Mouse Events
                this.canvas.addEventListener('mousedown', (e) => this.start(e));
                this.canvas.addEventListener('mousemove', (e) => this.draw(e));
                this.canvas.addEventListener('mouseup', () => this.stop());
                this.canvas.addEventListener('mouseout', () => this.stop());

                // Touch Events
                this.canvas.addEventListener('touchstart', (e) => { e.preventDefault(); this.start(e.touches[0]); });
                this.canvas.addEventListener('touchmove', (e) => { e.preventDefault(); this.draw(e.touches[0]); });
                this.canvas.addEventListener('touchend', () => this.stop());

                // Resize for quality
                this.resizeCanvas();
            },
            resizeCanvas() {
                const parent = this.canvas.parentElement;
                this.canvas.width = parent.clientWidth;
                this.canvas.height = parent.clientHeight;
                this.ctx.lineWidth = 2;
                this.ctx.lineCap = 'round';
                this.ctx.strokeStyle = '#000';
            },
            getPos(e) {
                const rect = this.canvas.getBoundingClientRect();
                return { x: e.clientX - rect.left, y: e.clientY - rect.top };
            },
            start(e) {
                this.isDrawing = true;
                const pos = this.getPos(e);
                this.ctx.beginPath();
                this.ctx.moveTo(pos.x, pos.y);
            },
            draw(e) {
                if (!this.isDrawing) return;
                const pos = this.getPos(e);
                this.ctx.lineTo(pos.x, pos.y);
                this.ctx.stroke();
            },
            stop() { this.isDrawing = false; },
            clear() {
                if (this.ctx) {
                    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                }
                this.currentSignatureData = null;
            },
            openModal() {
                document.getElementById('modal-signature').classList.remove('hidden');
                document.getElementById('modal-signature').classList.add('flex');
                setTimeout(() => this.resizeCanvas(), 50); // Delay for layout
            },
            close() {
                document.getElementById('modal-signature').classList.add('hidden');
                document.getElementById('modal-signature').classList.remove('flex');
            },
            save() {
                this.currentSignatureData = this.canvas.toDataURL();

                // Update UI preview
                const banner = document.getElementById('signature-preview-banner');
                const img = document.getElementById('signature-preview-img');
                banner.classList.remove('hidden');
                img.src = this.currentSignatureData;

                this.close();
            }
        };

        // --- 6. EXPENSES MANAGER ---
        window.expensesManager = {
            async init() {
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('exp-date').value = today;
                this.render();
            },
            async add() {
                const date = document.getElementById('exp-date').value;
                const supplier = document.getElementById('exp-supplier').value;
                const amount = parseFloat(document.getElementById('exp-amount').value);
                const category = document.getElementById('exp-category').value;

                if (!date || !supplier || isNaN(amount)) return alert("Veuillez remplir tous les champs");

                const expense = {
                    date, supplier, amount, category,
                    created_at: new Date().toISOString(),
                    userId: DataService.userId
                };

                await DataService.add('expenses', expense);

                // Reset form
                document.getElementById('exp-supplier').value = '';
                document.getElementById('exp-amount').value = '';
                this.render();
            },
            async del(id) {
                if (confirm("Supprimer cette d√©pense ?")) {
                    await DataService.delete('expenses', id);
                    this.render();
                }
            },
            async render() {
                const list = document.getElementById('expenses-list');
                const totalEl = document.getElementById('exp-total-month');
                if (!list) return;

                const expenses = await DataService.get('expenses');
                expenses.sort((a, b) => new Date(b.date) - new Date(a.date));

                list.innerHTML = '';
                let totalMonth = 0;
                const currentMonth = new Date().getMonth();

                if (expenses.length === 0) {
                    list.innerHTML = '<li class="p-8 text-center text-slate-400 italic">Aucune d√©pense enregistr√©e.</li>';
                }

                expenses.forEach(e => {
                    const d = new Date(e.date);
                    if (d.getMonth() === currentMonth) totalMonth += e.amount;

                    list.innerHTML += `
                        <li class="p-4 hover:bg-slate-50 dark:hover:bg-slate-800/50 flex justify-between items-center group transition-colors">
                            <div class="flex items-center gap-4">
                                <div class="w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center text-slate-500 font-bold text-xs">
                                    ${d.getDate()}/${d.getMonth() + 1}
                                </div>
                                <div>
                                    <div class="font-bold text-slate-900 dark:text-white">${e.supplier}</div>
                                    <div class="text-xs text-slate-500">${e.category}</div>
                                </div>
                            </div>
                            <div class="flex items-center gap-4">
                                <div class="font-black text-slate-900 dark:text-white">-${e.amount.toFixed(2)} ‚Ç¨</div>
                                <button onclick="expensesManager.del('${e.id}')" class="w-8 h-8 rounded-lg text-slate-300 hover:text-red-500 hover:bg-red-50 transition-colors opacity-0 group-hover:opacity-100"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </li>
                    `;
                });

                totalEl.innerText = totalMonth.toFixed(2) + ' ‚Ç¨';
            }
        };

        // --- 7. CORE MANAGERS ---
        window.router = {
            navigate: (id) => {
                // Close menu if open
                if (window.menuManager) window.menuManager.close();

                document.querySelectorAll('.view-section').forEach(e => { if (e.id !== 'view-login') { e.classList.remove('active'); e.classList.add('hidden'); } });
                const target = document.getElementById('view-' + id);
                if (target) {
                    target.classList.remove('hidden');
                    target.classList.add('active');

                    // Init specific managers
                    if (id === 'home' && window.dashboard) window.dashboard.load();
                    if (id === 'devis' && window.editorManager) window.editorManager.init();
                    if (id === 'items' && window.itemManager) window.itemManager.render();
                    if (id === 'clients' && window.clientManager) window.clientManager.render();
                    if (id === 'calendar' && window.calendarManager) window.calendarManager.render();
                    if (id === 'expenses' && window.expensesManager) window.expensesManager.init();
                    if (id === 'settings' && window.settingsManager) window.settingsManager.load();
                    if (id === 'deals' && window.dealsManager) window.dealsManager.render();
                }

                // Update Nav Active State
                document.querySelectorAll('.nav-item, .nav-btn, .nav-btn-mobile').forEach(b => {
                    b.classList.remove('bg-slate-100', 'dark:bg-slate-800', 'text-brand-600', 'text-slate-400', 'text-red-500');
                    if (b.classList.contains('nav-btn-mobile')) b.classList.add('text-slate-400');

                    const targetId = b.dataset.target || (b.id ? b.id.replace('nav-', '') : '');

                    if (targetId === id) {
                        if (b.classList.contains('nav-item') || b.classList.contains('nav-btn')) {
                            b.classList.add('bg-slate-100', 'dark:bg-slate-800', 'text-brand-600');
                            // Special case for sub-items in dropdown
                            if (b.parentElement.id === 'submenu-gestion') {
                                // Ensure dropdown is open
                                document.getElementById('submenu-gestion').classList.remove('hidden');
                                document.getElementById('chevron-gestion').classList.add('rotate-180');
                            }
                        }
                        else b.classList.add(id === 'deals' ? 'text-red-500' : 'text-brand-600');
                        b.classList.remove('text-slate-400');
                    }
                });
            }
        };

        window.dashboard = {
            chartInstance: null,
            async load() {
                const d = await DataService.get('docs');
                const e = await DataService.get('expenses'); // Fetch expenses

                let r = 0, s = 0;
                d.forEach(x => { if (x.status === 'validated' || x.type === 'facture') { r += x.ttc; s++; } });

                let exp = 0;
                e.forEach(x => exp += x.amount); // Calculate total expenses

                const margin = r - exp; // Calculate Net Margin

                if (document.getElementById('stat-revenue')) document.getElementById('stat-revenue').innerText = r.toFixed(0) + ' ‚Ç¨';
                if (document.getElementById('stat-signed')) document.getElementById('stat-signed').innerText = s;
                if (document.getElementById('stat-margin')) {
                    document.getElementById('stat-margin').innerText = margin.toFixed(2) + ' ‚Ç¨';
                    // Color coding for margin
                    if (margin >= 0) document.getElementById('stat-margin').className = "text-2xl font-black text-green-600";
                    else document.getElementById('stat-margin').className = "text-2xl font-black text-red-600";
                }

                // PREMIUM BUTTON IN DASHBOARD
                const premiumBtn = document.getElementById('btn-go-premium');
                if (!DataService.isPremium) {
                    if (!premiumBtn) {
                        const statsGrid = document.querySelector('#view-home .grid');
                        const btn = document.createElement('div');
                        btn.id = 'btn-go-premium';
                        btn.className = 'bg-gradient-to-br from-amber-400 to-orange-600 p-5 rounded-2xl shadow-lg text-white cursor-pointer card-hover btn-action relative overflow-hidden';
                        btn.onclick = () => document.getElementById('modal-premium').classList.remove('hidden');
                        btn.innerHTML = `<i class="fa-solid fa-crown absolute -right-4 -bottom-4 text-8xl text-white/20"></i>
                                         <div class="text-xs font-bold text-amber-100 uppercase mb-2">Upgrade</div>
                                         <div class="text-lg font-black flex items-center gap-2">Passer Premium</div>`;
                        statsGrid.appendChild(btn);
                    }
                } else if (premiumBtn) {
                    premiumBtn.remove();
                }

                const l = document.getElementById('dash-recent-list');
                if (l) {
                    l.innerHTML = '';
                    if (d.length === 0) l.innerHTML = '<li class="p-6 text-center text-sm text-slate-400 italic">Aucun document</li>';
                    d.sort((a, b) => new Date(b.created_at) - new Date(a.created_at)).slice(0, 5).forEach(x =>
                        l.innerHTML += `<li class="p-5 hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-all cursor-pointer flex justify-between items-center border-b border-slate-100 dark:border-800"><div class="font-bold dark:text-white">${x.clientName}</div><div class="font-black">${x.ttc.toFixed(2)}‚Ç¨</div></li>`
                    );
                }
                this.loadChart();
            },
            async loadChart() {
                const ctx = document.getElementById('revenueChart');
                if (!ctx) return;

                const year = parseInt(document.getElementById('chart-year').value);
                const docs = await DataService.get('docs');

                // Init data array for 12 months
                const monthlyData = Array(12).fill(0);

                docs.forEach(d => {
                    if (d.status === 'validated' || d.type === 'facture') {
                        const date = new Date(d.date);
                        if (date.getFullYear() === year) {
                            monthlyData[date.getMonth()] += d.ttc;
                        }
                    }
                });

                const isDark = document.documentElement.classList.contains('dark');
                const color = isDark ? '#60a5fa' : '#3b82f6';
                const bg = isDark ? 'rgba(96, 165, 250, 0.1)' : 'rgba(59, 130, 246, 0.1)';

                if (this.chartInstance) this.chartInstance.destroy();

                this.chartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['Jan', 'F√©v', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Ao√ªt', 'Sep', 'Oct', 'Nov', 'D√©c'],
                        datasets: [{
                            label: 'Chiffre d\'Affaires (‚Ç¨)',
                            data: monthlyData,
                            borderColor: color,
                            backgroundColor: bg,
                            borderWidth: 3,
                            pointBackgroundColor: 'white',
                            pointBorderColor: color,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: isDark ? '#1e293b' : 'white',
                                titleColor: isDark ? 'white' : '#0f172a',
                                bodyColor: isDark ? '#cbd5e1' : '#64748b',
                                borderColor: isDark ? '#334155' : '#e2e8f0',
                                borderWidth: 1,
                                padding: 10,
                                displayColors: false,
                                callbacks: { label: (c) => c.raw.toFixed(2) + ' ‚Ç¨' }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: { color: isDark ? '#334155' : '#e2e8f0', borderDash: [5, 5] },
                                ticks: { color: isDark ? '#94a3b8' : '#64748b', font: { family: 'Inter', size: 10 } }
                            },
                            x: {
                                grid: { display: false },
                                ticks: { color: isDark ? '#94a3b8' : '#64748b', font: { family: 'Inter', size: 10 } }
                            }
                        }
                    }
                });
            },
            async exportAccounting() {
                if (!DataService.checkPremium()) return; // PREMIUM CHECK
                const docs = await DataService.get('docs');
                if (docs.length === 0) return alert("Aucune facture √† exporter.");

                let csv = "Date;Type;Numero;Client;HT;TVA;TTC\n";
                docs.forEach(d => {
                    const date = new Date(d.date).toLocaleDateString();
                    const tvaTotal = d.ttc - d.ht;
                    csv += `${date};${d.type};${d.id.substr(-4)};${d.clientName};${d.ht.toFixed(2)};${tvaTotal.toFixed(2)};${d.ttc.toFixed(2)}\n`;
                });

                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "export_comptable_progest.csv");
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        };

        window.editorManager = {
            lines: [],
            init() {
                this.lines = [{ d: '', q: 1, p: 0, tva: 0.2 }];
                this.renderLines();
                document.getElementById('editor-date').valueAsDate = new Date();

                // Reset signature logic
                window.signatureManager.clear();
                document.getElementById('signature-preview-banner').classList.add('hidden');
                document.getElementById('signature-preview-img').src = '';
            },

            renderLines() {
                const e = document.getElementById('editor-lines');
                e.innerHTML = '';
                let ht = 0, tvaTotal = 0;
                this.lines.forEach((l, i) => {
                    ht += l.q * l.p;
                    tvaTotal += (l.q * l.p) * l.tva;
                    e.innerHTML += `<div class="glass p-3 rounded-xl flex gap-2 items-center flex-wrap mb-2"><button onclick="editorManager.removeLine(${i})" class="text-red-500 px-2"><i class="fa-solid fa-times"></i></button><input class="flex-1 min-w-[150px] bg-transparent outline-none dark:text-white text-slate-900 placeholder-slate-400 font-medium" value="${l.d}" oninput="editorManager.up(${i},'d',this.value)" placeholder="Prestation"><input class="w-14 text-center bg-slate-100 dark:bg-slate-800 rounded p-1 dark:text-white text-slate-900 font-bold" type="number" value="${l.q}" oninput="editorManager.up(${i},'q',this.value)"><input class="w-20 text-right bg-slate-100 dark:bg-slate-800 rounded p-1 dark:text-white text-slate-900 font-bold" type="number" value="${l.p}" oninput="editorManager.up(${i},'p',this.value)"><select class="w-16 bg-slate-100 dark:bg-slate-800 rounded p-1 text-xs dark:text-white" onchange="editorManager.up(${i},'tva',this.value)"><option value="0.2" ${l.tva == 0.2 ? 'selected' : ''}>20%</option><option value="0.1" ${l.tva == 0.1 ? 'selected' : ''}>10%</option><option value="0.055" ${l.tva == 0.055 ? 'selected' : ''}>5.5%</option></select></div>`;
                });
                document.getElementById('editor-total-ht').innerText = ht.toFixed(2) + '‚Ç¨';
                document.getElementById('editor-total-tva').innerText = tvaTotal.toFixed(2) + '‚Ç¨';
                document.getElementById('editor-total-ttc').innerText = (ht + tvaTotal).toFixed(2) + '‚Ç¨';
            },
            up(i, k, v) { this.lines[i][k] = k === 'd' ? v : parseFloat(v) || 0; this.renderLines(); },
            addLine() { this.lines.push({ d: '', q: 1, p: 0, tva: 0.2 }); this.renderLines(); },
            removeLine(i) { if (this.lines.length > 1) { this.lines.splice(i, 1); this.renderLines(); } },
            async saveDocument() {
                const clientName = document.getElementById('editor-client-preview').innerText;
                if (clientName === "S√©lectionner...") return alert('Veuillez s√©lectionner un client');

                const b = document.querySelector('button[onclick="editorManager.saveDocument()"]');
                const t = b.innerHTML; b.innerHTML = '...'; b.disabled = true;

                let ht = 0, tva = 0;
                this.lines.forEach(l => { ht += l.q * l.p; tva += (l.q * l.p) * l.tva; });

                // Get Signature
                const sigData = window.signatureManager.currentSignatureData;

                await DataService.add('docs', {
                    type: 'devis', date: new Date().toISOString(),
                    clientName: clientName, lines: this.lines,
                    ht, ttc: ht + tva, status: sigData ? 'signed' : 'draft',
                    signature: sigData
                });
                b.innerHTML = t; b.disabled = false;
                alert('Sauvegard√© !'); router.navigate('home');
            },
            openLibraryModal() { window.uiManager.openGenericModal('Biblioth√®que', '<div id="modal-lib-list">...</div>'); window.itemManager.render(true); },
            importItem(t, p) { this.lines.push({ d: t, q: 1, p, tva: 0.2 }); this.renderLines(); window.uiManager.closeGenericModal(); },

            // PRINT LOGIC (UPDATED WITH LEGAL, VAT & SIGNATURE)
            async print() {
                const client = document.getElementById('editor-client-preview').innerText;
                if (client === "S√©lectionner...") return alert("Choisissez un client");

                // Get Settings for Logo & Legal
                const s = await DataService.get('settings');
                const conf = s[0] || {};

                document.getElementById('print-client-name').innerText = client;
                document.getElementById('print-date').innerText = new Date().toLocaleDateString();
                document.getElementById('print-ref').innerText = 'D-' + Date.now().toString().substr(-4);

                // Legal Info Header
                let legal = `${conf.company || 'Mon Entreprise'}\nSIRET: ${conf.siret || 'Non renseign√©'}\n${conf.address || ''}\nTVA Intra: ${conf.tvaintra || 'Non renseign√©'}`;
                document.getElementById('print-company-info').innerText = legal;

                // Legal Footer
                document.getElementById('print-legal-footer').innerText = `Assurance D√©cennale: ${conf.decennale || 'Non renseign√©e'} - Mention RGE: ${conf.rge || 'Non applicable'}`;

                // LOGO
                const logoImg = document.getElementById('print-logo');
                if (conf.logo) {
                    logoImg.src = conf.logo;
                    logoImg.classList.remove('hidden');
                } else {
                    logoImg.classList.add('hidden');
                }

                // SIGNATURE IN PRINT
                const sigData = window.signatureManager.currentSignatureData;
                const sigImgPrint = document.getElementById('print-signature-img');
                const sigDatePrint = document.getElementById('print-signature-date');

                if (sigData) {
                    sigImgPrint.src = sigData;
                    sigImgPrint.classList.remove('hidden');
                    sigDatePrint.innerText = "Sign√© num√©riquement le " + new Date().toLocaleDateString();
                    sigDatePrint.classList.remove('hidden');
                } else {
                    sigImgPrint.classList.add('hidden');
                    sigDatePrint.classList.add('hidden');
                }

                // Lines
                const tbody = document.getElementById('print-lines');
                tbody.innerHTML = '';
                this.lines.forEach(l => {
                    const tvaPct = (l.tva * 100).toFixed(1) + '%';
                    tbody.innerHTML += `<tr class="border-b border-slate-100"><td class="py-3 px-4">${l.d}</td><td class="text-center">${l.q}</td><td class="text-center text-xs text-slate-500">${tvaPct}</td><td class="text-right">${l.p}‚Ç¨</td><td class="text-right font-bold">${(l.q * l.p).toFixed(2)}‚Ç¨</td></tr>`;
                });

                document.getElementById('print-ht').innerText = document.getElementById('editor-total-ht').innerText;
                document.getElementById('print-tva').innerText = document.getElementById('editor-total-tva').innerText;
                document.getElementById('print-ttc').innerText = document.getElementById('editor-total-ttc').innerText;

                window.print();
            }
        };

        const clientManager = {
            async render() { const e = document.getElementById('clients-list-body'); const c = await DataService.get('clients'); e.innerHTML = ''; if (c.length === 0) e.innerHTML = '<p class="text-slate-400 p-4">Vide</p>'; c.forEach(x => e.innerHTML += `<div class="glass p-4 rounded-xl shadow border border-slate-200/50 flex justify-between"><span class="font-bold dark:text-white text-slate-900">${x.name}</span><button onclick="clientManager.del('${x.id}')" class="text-red-500"><i class="fa-solid fa-trash"></i></button></div>`); }, openAddModal() { const isEditor = document.getElementById('view-devis').classList.contains('active'); if (isEditor) this.renderSel(); else this.openNewForm(false); }, async renderSel() { const c = await DataService.get('clients'); let h = '<div class="space-y-2 mb-4 max-h-60 overflow-auto custom-scrollbar">'; c.forEach(x => h += `<div onclick="clientManager.sel('${x.id}','${x.name}')" class="p-3 bg-slate-100 dark:bg-slate-800 rounded-lg cursor-pointer font-bold text-slate-900 dark:text-white hover:bg-brand-100">${x.name}</div>`); h += '</div><button onclick="uiManager.closeGenericModal();clientManager.openNewForm(true)" class="text-brand-600 text-sm font-bold">Nouveau Client</button>'; uiManager.openGenericModal('Choisir', h); }, openNewForm(isEditor = false) { uiManager.openGenericModal('Nouveau Client', `<input id="new-c-name" class="w-full p-3 border rounded-xl mb-3 bg-slate-100 dark:bg-slate-800 text-slate-900 dark:text-white" placeholder="Nom"><button onclick="clientManager.save(${isEditor})" class="w-full bg-brand-600 text-white p-3 rounded-xl font-bold">Ajouter</button>`); }, async save(s = false) {
                console.log("save called", s);
                try {
                    const n = document.getElementById('new-c-name').value;
                    if (!n) return alert("Le nom est obligatoire");

                    console.log("Calling DataService.add...");
                    const r = await DataService.add('clients', { name: n });
                    console.log("DataService returned:", r);

                    if (!r) throw new Error("Erreur interne: Aucune donn√©e retourn√©e");

                    if (s) {
                        this.sel(r.id, r.name);
                    } else {
                        uiManager.closeGenericModal();
                        this.render();
                    }
                } catch (e) {
                    console.error("Save Error:", e);
                    alert("Erreur lors de l'enregistrement: " + e.message);
                }
            }, sel(i, n) { document.getElementById('editor-client-preview').innerText = n; document.getElementById('editor-client-preview').classList.add('text-slate-900', 'dark:text-white'); document.getElementById('editor-client-id').value = i; uiManager.closeGenericModal(); }, async del(i) { if (confirm('Supprimer ?')) { await DataService.delete('clients', i); this.render(); } }
        };
        const itemManager = { async render(m = false) { const i = await DataService.get('items'); const e = m ? document.getElementById('modal-lib-list') : document.getElementById('items-list-body'); e.innerHTML = ''; i.forEach(x => { const a = m ? `onclick="editorManager.importItem('${x.title}',${x.price})"` : ''; e.innerHTML += `<div ${a} class="glass p-4 rounded-xl mb-2 flex justify-between cursor-pointer border border-slate-200/50 dark:border-slate-700"><span class="dark:text-white text-slate-900 font-bold">${x.title}</span><span class="font-black text-brand-600">${x.price}‚Ç¨</span></div>`; }); }, openAddModal() { uiManager.openGenericModal('Nouvelle Prestation', `<input id="new-i-t" class="w-full p-3 border rounded-xl mb-3 bg-slate-100 dark:bg-slate-800 text-slate-900 dark:text-white" placeholder="Titre"><input id="new-i-p" class="w-full p-3 border rounded-xl mb-3 bg-slate-100 dark:bg-slate-800 text-slate-900 dark:text-white" placeholder="Prix"><button onclick="itemManager.save()" class="w-full bg-brand-600 text-white p-3 rounded-xl font-bold">Ajouter</button>`); }, async save() { await DataService.add('items', { title: document.getElementById('new-i-t').value, price: parseFloat(document.getElementById('new-i-p').value) }); uiManager.closeGenericModal(); this.render(); } };
        const calendarManager = {
            currentDate: new Date(),
            changeMonth(delta) { this.currentDate.setMonth(this.currentDate.getMonth() + delta); this.render(); },
            async render() {
                const year = this.currentDate.getFullYear();
                const month = this.currentDate.getMonth();
                const monthNames = ["Janvier", "F√©vrier", "Mars", "Avril", "Mai", "Juin", "Juillet", "Ao√ªt", "Septembre", "Octobre", "Novembre", "D√©cembre"];
                const disp = document.getElementById('calendar-month-display');
                if (disp) disp.innerText = `${monthNames[month]} ${year}`;
                const grid = document.getElementById('calendar-grid');
                if (!grid) return;
                grid.innerHTML = '';
                const appts = await DataService.get('appointments');
                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const offset = firstDay === 0 ? 6 : firstDay - 1;
                for (let i = 0; i < offset; i++) grid.innerHTML += `<div class="calendar-day bg-slate-50 dark:bg-slate-800/50 opacity-50"></div>`;
                const today = new Date();
                for (let d = 1; d <= daysInMonth; d++) {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                    const isToday = (d === today.getDate() && month === today.getMonth() && year === today.getFullYear());
                    const dayAppts = appts.filter(a => a.date === dateStr);
                    let dots = '';
                    dayAppts.forEach(a => {
                        let c = 'bg-brand-500';
                        if (a.type == 'chantier') c = 'bg-green-500';
                        if (a.type == 'urgence') c = 'bg-red-500';
                        dots += `<div class="w-2 h-2 rounded-full ${c} mb-0.5"></div>`;
                    });
                    grid.innerHTML += `<div onclick="calendarManager.openDayModal('${dateStr}')" class="calendar-day group relative hover:bg-brand-50 dark:hover:bg-slate-800 transition-colors"><span class="text-xs font-bold text-slate-500 dark:text-slate-400">${d}</span><div class="mt-1 flex flex-wrap gap-0.5 content-start">${dots}</div></div>`;
                }
            },
            async openDayModal(dateStr) {
                const appts = await DataService.get('appointments');
                const clients = await DataService.get('clients');
                const dayAppts = appts.filter(a => a.date === dateStr);
                const niceDate = new Date(dateStr).toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' });
                let ops = `<option value="">-- Client --</option>`;
                clients.forEach(c => ops += `<option value="${c.name}">${c.name}</option>`);
                let list = '';
                dayAppts.forEach(a => {
                    // Google Calendar Link Generation
                    const startDate = dateStr.replace(/-/g, '');
                    const endDate = new Date(new Date(dateStr).getTime() + 86400000).toISOString().split('T')[0].replace(/-/g, ''); // Next day for all-day event
                    const gCalUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(a.title)}&dates=${startDate}/${endDate}&details=${encodeURIComponent('Type: ' + a.type)}`;

                    list += `<li class="flex justify-between items-center glass p-3 mb-2 rounded-xl border border-slate-200 dark:border-slate-700">
                        <div class="flex-1">
                            <div class="font-bold text-sm text-slate-900 dark:text-white">${a.title}</div>
                            <div class="text-xs text-slate-500">${a.type}</div>
                        </div>
                        <div class="flex gap-2">
                            <a href="${gCalUrl}" target="_blank" class="w-8 h-8 flex items-center justify-center rounded-lg bg-blue-50 text-blue-600 hover:bg-blue-100" title="Ajouter √† Google Agenda">
                                <i class="fa-brands fa-google"></i>
                            </a>
                            <button onclick="calendarManager.del('${a.id}','${dateStr}')" class="w-8 h-8 flex items-center justify-center rounded-lg bg-red-50 text-red-400 hover:bg-red-100">
                                <i class="fa-solid fa-times"></i>
                            </button>
                        </div>
                    </li>`;
                });
                if (!list) list = '<p class="text-slate-400 italic text-sm mb-4">Rien de pr√©vu</p>';
                const form = `<div class="border-t border-slate-200 dark:border-slate-700 pt-4 mt-4"><label class="text-[10px] uppercase font-bold text-slate-500 mb-2 block">Ajouter</label><select id="cal-client" class="w-full p-3 bg-slate-100 dark:bg-slate-800 rounded-xl mb-2 outline-none text-slate-900 dark:text-white" onchange="document.getElementById('cal-title').value = this.value">${ops}</select><input id="cal-title" class="w-full p-3 bg-slate-100 dark:bg-slate-800 rounded-xl mb-2 outline-none text-slate-900 dark:text-white" placeholder="Ou titre libre..."><div class="flex gap-2"><select id="cal-type" class="p-3 bg-slate-100 dark:bg-slate-800 rounded-xl outline-none text-slate-900 dark:text-white flex-1"><option value="rdv">RDV</option><option value="chantier">Chantier</option><option value="urgence">Urgence</option></select><button onclick="calendarManager.save('${dateStr}')" class="bg-brand-600 text-white font-bold rounded-xl px-4">OK</button></div></div>`;
                window.uiManager.openGenericModal(niceDate, `<ul class="mb-2">${list}</ul>${form}`);
            },
            async save(dateStr) { const title = document.getElementById('cal-title').value; const type = document.getElementById('cal-type').value; if (!title) return; await DataService.add('appointments', { title, type, date: dateStr }); window.uiManager.closeGenericModal(); this.render(); },
            async del(id, dateStr) { if (confirm('Supprimer ?')) { await DataService.delete('appointments', id); this.openDayModal(dateStr); this.render(); } }
        };

        const siteManager = {
            async addNote() {
                const clients = await DataService.get('clients');
                let ops = ''; clients.forEach(c => ops += `<option value="${c.name}">${c.name}</option>`);
                window.uiManager.openGenericModal('Note de Chantier', `
                    <div class="space-y-4">
                        <select id="site-client" class="w-full p-4 bg-slate-100 dark:bg-slate-800 text-slate-900 dark:text-white rounded-xl outline-none">${ops}</select>
                        <textarea id="site-note" rows="3" class="w-full p-4 bg-slate-100 dark:bg-slate-800 text-slate-900 dark:text-white rounded-xl outline-none" placeholder="Avancement..."></textarea>
                        <button onclick="siteManager.save()" class="w-full bg-brand-600 text-white font-bold p-4 rounded-xl">Publier</button>
                    </div>
                `);
            },
            async save() {
                const client = document.getElementById('site-client').value;
                const note = document.getElementById('site-note').value;
                if (!client) return;
                // Just visual for demo
                const feed = document.getElementById('sites-feed');
                feed.innerHTML = `<div class="glass p-6 rounded-2xl border border-slate-200 dark:border-slate-700 mb-4 animate-fade-in"><div class="flex items-center gap-3 mb-2"><div class="w-8 h-8 rounded-full bg-brand-100 flex items-center justify-center text-brand-600 font-bold">${client.charAt(0)}</div><div class="font-bold dark:text-white">${client}</div></div><p class="text-slate-600 dark:text-slate-300">${note}</p></div>` + feed.innerHTML;
                window.uiManager.closeGenericModal();
            }
        };

        const settingsManager = {
            async load() {
                const s = await DataService.get('settings');
                if (s.length > 0) {
                    const c = s[0];
                    if (document.getElementById('set-company')) document.getElementById('set-company').value = c.company || '';
                    if (document.getElementById('set-siret')) document.getElementById('set-siret').value = c.siret || '';
                    if (document.getElementById('set-address')) document.getElementById('set-address').value = c.address || '';
                    if (document.getElementById('set-decennale')) document.getElementById('set-decennale').value = c.decennale || '';
                    if (document.getElementById('set-rge')) document.getElementById('set-rge').value = c.rge || '';
                    if (document.getElementById('set-tva-intra')) document.getElementById('set-tva-intra').value = c.tvaintra || '';
                    if (c.logo) document.getElementById('preview-logo').innerHTML = `<img src="${c.logo}" class="w-full h-full object-contain">`;
                }
                if (auth && auth.currentUser) {
                    document.getElementById('settings-email').innerText = auth.currentUser.email;
                    document.getElementById('set-username').value = auth.currentUser.displayName || '';
                    if (auth.currentUser.photoURL) document.getElementById('settings-photo').src = auth.currentUser.photoURL;
                }
            },
            handleLogo(input) {
                const file = input.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onloadend = () => {
                    document.getElementById('preview-logo').innerHTML = `<img src="${reader.result}" class="w-full h-full object-contain">`;
                    document.getElementById('set-logo').dataset.b64 = reader.result;
                };
                reader.readAsDataURL(file);
            },
            async save(e) {
                e.preventDefault();
                const logoB64 = document.getElementById('set-logo').dataset.b64 || null;
                const current = await DataService.get('settings');
                const oldLogo = (current.length > 0) ? current[0].logo : null;

                await DataService.saveSettings({
                    company: document.getElementById('set-company').value,
                    siret: document.getElementById('set-siret').value,
                    address: document.getElementById('set-address').value,
                    decennale: document.getElementById('set-decennale').value,
                    rge: document.getElementById('set-rge').value,
                    tvaintra: document.getElementById('set-tva-intra').value,
                    logo: logoB64 || oldLogo
                });
                alert('OK');
            },
            async updateProfile() {
                const newName = document.getElementById('set-username').value;
                if (auth.currentUser) {
                    try { await updateProfile(auth.currentUser, { displayName: newName }); document.getElementById('user-name').innerText = newName; alert("Profil mis √† jour !"); } catch (e) { console.error(e); alert("Erreur"); }
                }
            }
        };

        const aiManager = {
            openModal: () => {
                if (!DataService.checkPremium()) return; // PREMIUM CHECK
                document.getElementById('modal-ai').classList.remove('hidden');
            },
            closeModal: () => document.getElementById('modal-ai').classList.add('hidden'),
            async generate() {
                const b = document.getElementById('ai-btn-generate'); b.innerHTML = '...';
                await new Promise(r => setTimeout(r, 1000));
                window.editorManager.lines = [{ d: "Peinture compl√®te", q: 1, p: 450, tva: 0.1 }, { d: "Pose sol", q: 20, p: 40, tva: 0.2 }];
                window.editorManager.renderLines();
                this.closeModal();
                b.innerHTML = 'G√©n√©rer';
            }
        };
        const uiManager = { openGenericModal(t, c) { const m = document.getElementById('modal-generic'); m.innerHTML = `<div class="fixed inset-0 bg-black/60 backdrop-blur-sm" onclick="uiManager.closeGenericModal()"></div><div class="glass w-full max-w-md p-6 rounded-2xl z-10 animate-slide-up shadow-2xl"><h3 class="font-bold mb-4 dark:text-white text-xl">${t}</h3><div>${c}</div></div>`; m.classList.remove('hidden'); }, closeGenericModal() { document.getElementById('modal-generic').classList.add('hidden'); } };
        const themeManager = { toggle: () => { document.documentElement.classList.toggle('dark'); } };
        const menuManager = {
            open() {
                document.getElementById('main-menu').classList.add('open');
                document.getElementById('menu-overlay').classList.remove('hidden');
                setTimeout(() => document.getElementById('menu-overlay').classList.add('open'), 10);
            },
            close() {
                document.getElementById('main-menu').classList.remove('open');
                document.getElementById('menu-overlay').classList.remove('open');
                setTimeout(() => document.getElementById('menu-overlay').classList.add('hidden'), 300);
            }
        };

        // INIT
        if (!auth) {
            console.warn("Firebase Auth non disponible. Mode hors ligne/d√©mo uniquement.");
            // Force login view to be active if not already
            document.getElementById('view-login').classList.add('active');
            document.getElementById('view-login').classList.remove('hidden');
        }

        // Globals
        window.clientManager = clientManager; window.itemManager = itemManager;
        window.calendarManager = calendarManager; window.settingsManager = settingsManager;
        window.aiManager = aiManager; window.siteManager = siteManager;
        window.uiManager = uiManager; window.themeManager = themeManager; window.menuManager = menuManager;

        if (!window.clientManager) alert("ERREUR CRITIQUE: clientManager non charg√© !");
        console.log("Modules attached to window");

        // --- AUTH STATE LISTENER (MOVED TO END) ---
        if (auth) {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // alert("Utilisateur connect√©: " + user.email); // Debug
                    console.log("Utilisateur connect√©:", user.uid);
                    DataService.userId = user.uid;

                    // Update UI
                    document.getElementById('user-name').innerText = user.displayName || 'Utilisateur';
                    if (user.photoURL) document.getElementById('user-photo').src = user.photoURL;
                    document.getElementById('dash-name').innerText = (user.displayName || 'Chef').split(' ')[0];
                    document.getElementById('settings-email').innerText = user.email;
                    document.getElementById('set-username').value = user.displayName;
                    if (user.photoURL) document.getElementById('settings-photo').src = user.photoURL;

                    // Mock Subscription (Copy from Demo)
                    window.subscriptionManager = { checkLimit: async () => true, checkForSuccess: () => { } };

                    // Initialize Signature (Copy from Demo)
                    if (window.signatureManager) {
                        window.signatureManager.init();
                    }

                    // Switch View
                    document.getElementById('view-login').classList.remove('active');
                    document.getElementById('view-login').classList.add('hidden');
                    router.navigate('home');
                } else {
                    console.log("Utilisateur d√©connect√©");
                    DataService.userId = null;
                    document.getElementById('view-login').classList.add('active');
                    document.getElementById('view-login').classList.remove('hidden');
                }
            });
        }
    </script>
</body>

</html>